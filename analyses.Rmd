---
title: "Eastern quoll behaviour and dispersal"
author: "Christina Gee, Belinda Wilson"
date: "14 March 2024"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: true
    theme: cerulean
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'tutorial.html')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE)
```

# * Background

Safe havens (also referred to as sanctuaries) are valuable tools for protecting extant species in decline, and reintroducing species into areas from which they were extirpated (Smith et al. 2020). For those with conservation-fencing, designs which prevent entry (by invasive species) but do not prevent exit (of species living inside) can allow reintroduce species to disperse into the surrounding landscape (Wilson et al. 2020). But does every individual have an equal opportunity to disperse, or is this process driven by genetic and/or phenotypic traits?

We studied whether behavioural, morphological, and demographic traits drove dispersal in a reintroduced mesopredator (eastern quoll *Dasyurus viverrinus*, ‘murunguny’ in the Indigenous Ngunnawal language) which was reintroduced to a conservation-fenced haven in the Australian Capital Territory in 2016 (Wilson et al. 2020, 2021). The unmanaged dispersal of eastern quolls from the reintroduction site to surrounding areas presented a unique research opportunity to compare the individuals constituting the (1) self-regulating core population (henceforth residents), and the (2) recently founded external population (henceforth dispersers).

Investigating these trends can build our understanding of dispersal behaviour (and its stages of emigration, inter-patch movement, and immigration), how it responds to density-dependence, and how these processes can be managed for metapopulation health.

# * Setup

First, we installed the [pacman Package Management Tool](https://cran.r-project.org/web/packages/pacman/index.html), which allows us to install and load subsequent packages in a condensed and efficient way. 

```{r, eval=FALSE}
#install.packages("pacman")
```

# Install packages
```{r, results='hide', warning=FALSE, message=FALSE}
# Install and load required packages
pacman::p_load(basemaps, ggplot2, ggpubr, gtools, janitor, lme4,lmerTest, MuMIn,  
               readr, sf, readxl, rstudioapi, tidyverse, viridis, beepr, corrplot,
               broom, sjPlot, sjmisc, sjlabelled, knitr)

#install.packages("kableExtra")
library(kableExtra)

#install.packages("broom.mixed")
library(broom.mixed)

#install.packages("AICcmodavg")
library(AICcmodavg)

#install.packages("glmmTMB")
library(glmmTMB)

install.packages("scales")
library(scales)

```

# Data preparation
```{r, eval=FALSE}
# Assign raw data filename to an object
raw_data <- "data.xlsx"

# Read in behavioural assay data
raw <- read_excel(raw_data, sheet="Assays", na="N/A") %>% 
  clean_names() %>%
  select("obs_id"="observation_id", 
         "assay_id", 
         "quoll_code",
         behaviour="behavior", 
         occurrences="total_number_of_occurences")

#Read in the data for all data sheets in excel 
meta <- read_excel(raw_data, sheet="Metadata", na="N/A") %>% 
  clean_names()

quoll <- read_excel(raw_data, sheet="Quoll", na="N/A") %>%
  clean_names()

capture <- read_excel(raw_data, sheet="Captures") %>%
  clean_names()

session <- read_excel(raw_data, sheet="Sessions") %>%
    clean_names()

#Clean up behaviour data from long to wide format 
occ <- pivot_wider(data = raw, 
                   names_from = behaviour, 
                   values_from = occurrences)  %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_o = "section_1", 
         section_2_o = "section_2", 
         section_3_o = "section_3", 
         section_4_o = "section_4", 
         moving_o = "moving", 
         jump_climb_o = "jump_climb", 
         food_o = "food", 
         legs_o = "legs", 
         grooming_o = "grooming", 
         resting_o = "resting", 
         perch_o = "perch")

raw <- read_excel(raw_data, sheet="Assays", , na="N/A") %>% 
  clean_names() %>%
  select("obs_id"="observation_id", 
         "assay_id", 
         quoll_code, 
         behaviour="behavior", 
         duration="total_duration_s")

dur <- pivot_wider(data = raw,
                   names_from = behaviour, 
                   values_from = duration) %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_d = "section_1", 
         section_2_d = "section_2", 
         section_3_d = "section_3", 
         section_4_d = "section_4", 
         moving_d = "moving", 
         jump_climb_d = "jump_climb", 
         food_d = "food", 
         legs_d = "legs", 
         grooming_d = "grooming", 
         resting_d = "resting", 
         perch_d = "perch")

assays <- left_join(occ, dur, by=c("obs_id", "assay_id", "quoll_code"))

#Adding all sections together to create a column with total section visitations
assays$sumsect_o <- rowSums(assays[, c("section_1_o", "section_2_o", "section_3_o", "section_4_o")])

#Adding together all activity occurrences without sections
assays$totalact_o <- rowSums(assays[, c(4:10)])
#view(assays)

# Append metadata for each assay to dataframe
behavdata <- left_join(meta, assays, by=c("assay_id", "quoll_code"))%>%
  filter(!is.na(assay_number))

behavdata <- left_join(behavdata, session, by=c("session"))%>%
  filter(!is.na(assay_number))

quolldata <- left_join(capture, quoll, by=c("quoll_code"))

data <- left_join(behavdata, quolldata, by=c("session", "quoll_code"))
  
data <- data %>%
  select(-min_temp, -session_desc, -capture_date, -new_animal) %>%
  mutate(assay_number = as.factor(assay_number),
         cond_n = as.numeric(ifelse(condition=="Excellent", 4,
                            ifelse(condition=="Good", 3,
                                   ifelse(condition=="Fair", 2, NA)))),
         age_n = as.numeric(ifelse(age_estimate=="<1yr", 0,
                               ifelse(age_estimate=="1-2yrs", 1,
                                      ifelse(age_estimate=="2-3yrs", 2, NA)))))


```

# Calculating time differences 
```{r}

#Change time columns to correct POSIXct format
data$snout <- as.POSIXct(data$snout)
data$process_end <- as.POSIXct(data$process_end)
data$first_light <- as.POSIXct(data$first_light)

#Calculate time differences
data$time_processtoassay <- data$snout - data$process_end
data$time_assaytolight <- data$first_light - data$snout

#Filtering out the two individuals who were assayed in Sept 2023
data <- data %>%
  filter(!(quoll_code %in% c("53328", "87DE0")))


```

# Correlation analysis
```{r}
cor <- data  %>% 
  dplyr::select(age_n, body_weight_kg, cond_n, pes_mean_mm, head_length_mm)

#Running the correlation test
cor <- cor(cor)
view(cor)

#Saving them to a .csv file
write.csv(cor, "data - morphometric correlation matrix.csv")

#Creating and printing correlation matrix .jpgs which colour code the correlations
col_names <- c("Age estimate", "Body weight (kg)", "Condition", "Pes length (mm)", "Head length (mm)")
row_names <- c("Age estimate", "Body weight (kg)", "Condition", "Pes length (mm)", "Head length (mm)")
colnames(cor) <- col_names
rownames(cor) <- row_names

#Correlation of occurrences and duration with sections
jpeg(height=2000, width=2000, file="data corplot.jpeg", type="cairo")
corrplot(cor, method="color",
                  col= colorRampPalette(c("#B8DE29", "#FFFFFF","#2D718E"))(10),
         type="upper", #creates a correlation matrix
         cl.cex=3, number.cex=4, tl.cex=4, diag=FALSE,
         tl.col="black", tl.srt=45, addCoef.col="black")
dev.off()
```

#** SINGLE ASSAYS

# Subsetting data to include first assays only 
For morphometric and demographic analysis, and 'static behaviour' analysis
```{r}

data1 <- data %>%
      filter(assay_number !=2)

data1$site01 <- ifelse(data1$study_site == "Goorooyarroo", 1, 0)
write.csv(data1, "data1 - first assay data raw.csv")

```

Ensure that the data frame is in the format needed
```{r}
data1 <- data1 %>%
  mutate(age_n = as.numeric(as.character(age_n)), 
         condition = factor(condition, 
                            levels = c("Excellent", "Good", "Fair", "Poor")))

data1 <- data1 %>%
  # assign as factor
  mutate(age_estimate = as.factor(age_estimate)) %>%
  # Assign new labels
  mutate(age_estimate = recode(age_estimate, 
                               "1-2yrs" = "1–2 years", 
                               "<1yr" = "<1 year", 
                               "2-3yrs" = "2–3 years"))  %>%
  # reorder new labels
  mutate(age_estimate = factor(age_estimate, 
                               levels = c("2–3 years", "1–2 years", "<1 year")))

```

#Demo/morpho analysis
```{r}
#GLM
mod <- glm(site01 ~ sex + body_weight_kg + age_n + cond_n, 
           data=data1, family=binomial)
summary(mod)

```

#Demo/morpho table with kableExtra
```{r}
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Study site", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```

#Demo/morpho plots
```{r}

show_col(viridis(16))

str(data1)
mutate(as.numeric(data1$site01))

#Age plot
age_plot  <- ggplot() + 
  geom_smooth(data=data1, aes(x=age_n, y=site01), colour = "#1caa85", fill = "#68C6AE" ) + 
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(-0.4,1,0.2),labels=seq(-0.4,1,0.2), limits=c(-0.4,1)) +
  ylab("Probability of capture in MF (0) or GS (1)") +
  xlab("Age estimate") +
  annotate("text", x = 1.9, y =0.95, label = "A", size = 8, hjust = 1)

print(age_plot)

#Condition plot
cond_plot  <- ggplot() + 
 geom_smooth(data=data1, aes(x=cond_n, y=site01), colour = "#2D718E", fill = "#5089A1") + 
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
   scale_y_continuous(breaks=seq(-0.4,1,0.2),labels=seq(-0.4,1,0.2), limits=c(-0.4,1)) +
  ylab(" ") +
  xlab("Body condition score")+
  annotate("text", x = 3.9, y =0.95, label = "C", size = 8, hjust = 1)
print(cond_plot)

weight_plot  <- ggplot() + 
 geom_smooth(data=data1, aes(x=body_weight_kg, y=site01), colour = "#482677", fill = "#674A8E") + 
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
   scale_y_continuous(breaks=seq(-0.4,1,0.2),labels=seq(-0.4,1,0.2), limits=c(-0.4,1)) +
  #scale_x_continuous(breaks=seq(0, 2, 0.5), labels=seq(0,2,0.5), limits=c(0,2))+
  ylab(" ") +
  xlab("Body weight (kg)")+
  annotate("text", x = 1.6, y =0.95, label = "B", size = 8, hjust = -0.5)
print(weight_plot)


#Combine grooming plots
plot <- ggarrange(age_plot, weight_plot, cond_plot, nrow = 1, ncol = 3)
plot <- annotate_figure(plot, 
        #left = text_grob("Adjusted behaviours over two assays", rot=90, size = 16, face = "bold"),
        bottom = text_grob("Study site", size = 20))
print(plot)
ggsave(filename = "morpho plots.jpeg", plot, width=350, height= 150, units = "mm")

```

#Environmental vars influence GLM analysis
```{r}

mod <- glm(food_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
mod <- glm(food_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

mod <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
mod <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

mod <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
mod <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

mod <- glm(legs_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
mod <- glm(legs_o  ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

mod <- glm(moving_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
mod <- glm(moving_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

mod <- glm(perch_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
mod <- glm(perch_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

mod <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
mod <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
mod <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
mod <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

mod <- glm(stress_in_trap ~ temp + moon_phase, data=data1)
mod <- glm(stress_in_bag ~ temp + moon_phase, data=data1)
mod <- glm(stress_on_table ~ temp + moon_phase, data=data1)

```

#Environmental vars tables  with kabelExtra
```{r}

#Tables with kableExtra

response_var <- all.vars(formula(mod))[1]
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

```

#Environmental vars plots - don't need these 
```{r}

names(data1)

#Grooming and tempoerature
groomtemp <- ggplot(data=data1, aes(x = temp, y = grooming_o)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab(expression(paste("Ambient temperature (", degree, "C)"))) + 
  ylab(expression(paste("Grooming occurrences ", italic("(n) ")))) + labs("")

print(groomtemp)
#ggsave(filename = "2 assays raw - food v weight.jpeg", groomtemp, width=150, height= 150, units = "mm")


#Grooming and tempoerature
groomtemp <- ggplot(data=data1, aes(x = temp, y = grooming_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab(expression(paste("Ambient temperature (", degree, "C)"))) + 
  ylab("Grooming duration (s)") + labs("")

print(groomtemp)
#ggsave(filename = "2 assays raw - food v weight.jpeg", groomtemp, width=150, height= 150, units = "mm")


#Moving duration and time to first light
plot <- ggplot(data=data1, aes(x = time_assaytolight, y = moving_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Time (mins) from assay to first light") + 
  ylab("Quadrupedal movement duration (s)") + labs("")

print(plot)
#ggsave(filename = "2 assays raw - food v weight.jpeg", groomtemp, width=150, height= 150, units = "mm")

#Moving duration and time to first light
plot <- ggplot(data=data1, aes(x = time_assaytolight, y = legs_o)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Time (mins) from assay to first light") + 
  ylab("Hind leg stand occurrences (n)") + labs("")

print(plot)
#ggsave(filename = "2 assays raw - food v weight.jpeg", groomtemp, width=150, height= 150, units = "mm")


#Perching duration and all vars
plot <- ggplot(data=data1, aes(x = time_assaytolight, y = perch_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Time (mins) from assay to first light") + 
  ylab("Perching duration (s)") + labs("")
print(plot)


plot <- ggplot(data=data1, aes(x = time_processtoassay, y = perch_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Time (mins) from processing to assay") + 
  ylab("Perching duration (s)") + labs("")
print(plot)

plot <- ggplot(data=data1, aes(x = moon_phase, y = perch_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Moon illumination (%)") + 
  ylab("Perching duration (s)") + labs("")
print(plot)


plot <- ggplot(data=data1, aes(x = temp, y = perch_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Temp") + 
  ylab("Perching duration (s)") + labs("")
print(plot)


```


Analyse behaviour indicators
  1. Test the influence of fixed (e.g., site) and random effects (e.g., arena) on behavioural responses (e.g., food interaction duration) using the `lmer()` function.
  2. If multiple fixed effects produce significance, perform model selection using the dredge() function to determine which fixed effects are within delta 2 AICc.

#Capture behaviour GLMMS
Testing behaviour in GLMMs including environmental variables as competing factors in fixed effects model.

```{r}

mod <- lmer(bait_eaten_g ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(emerge_max ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + (1|arena),
            data=data1, na.action = "na.fail")

mod <- lmer(food_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(food_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(grooming_d ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + (1|arena),
            data=data1, na.action = "na.fail")

mod <- lmer(grooming_o ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(jump_climb_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(jump_climb_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(legs_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(legs_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(moving_d ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(moving_o ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(perch_d ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + moon_phase + 
              time_assaytolight + time_processtoassay + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(perch_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_in_bag ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_in_trap ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_on_table ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(sumsect_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(totalact_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

```


```{r}

#Tables with kableExtra

response_var <- all.vars(formula(mod))[1]

tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE)
 
table

```

#Capture behaviour AICc model selection
```{r}

control_ml <- lmerControl(optimizer = "Nelder_Mead")

#Grooming duration 
mod_gd_site <- lmer(grooming_d ~ study_site + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_gd_temp <- lmer(grooming_d ~ temp + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_gd_site, mod_gd_temp)
model.names <- c("Site", "Temp")
aictab(cand.set = models, modnames = model.names)

#Grooming occurrences
mod_go_site <- lmer(grooming_o ~ study_site + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_go_temp <- lmer(grooming_o ~ temp + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_go_site, mod_go_temp)
model.names <- c("Site", "Temp")
aictab(cand.set = models, modnames = model.names)


#Latency to emerge
mod_emerge_temp <- lmer(emerge_max ~ temp + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_emerge_weight <- lmer(emerge_max ~ body_weight_kg + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_emerge_age <- lmer(emerge_max ~ age_n + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_emerge_temp, mod_emerge_weight, mod_emerge_age)
model.names <- c("Temp", "Weight", "Age")
aictab(cand.set = models, modnames = model.names)



```

#Capture behaviour plots
```{r}

#Grooming duration v study site plot
groomd_site <- ggplot(data=data1, aes(x = study_site, y = grooming_d, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(0,110,20),labels=seq(0,110,20), limits=c(0,110)) +
  xlab("") + ylab("Grooming duration (s)") + labs("")  +
  annotate("text", x = "Mulligans Flat", y =110, label = "A", size = 9, hjust = -2)
print(groomd_site)
ggsave(filename = "1st assay - study site v grooming dur.jpeg", groomd_site, width=150, height= 150, units = "mm")

#Grooming occurrences v study site plot
groomo_site <- ggplot(data=data1, aes(x = study_site, y = grooming_o, 
                        fill = study_site)) + 
  geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(0,8,2),labels=seq(0,8,2), limits=c(0,8)) +
  xlab("") + ylab(expression(paste("Grooming occurrences ", italic(" (n)")))) + labs("") +
  annotate("text", x = "Mulligans Flat", y =8, label = "B", size = 9, hjust = -2)
print(groomo_site)
ggsave(filename = "1st assay - study site v grooming occ.jpeg", groomo_site, width=150, height= 150, units = "mm")


#Moving duration v study site plot
moved_site <- ggplot(data=data1, aes(x = study_site, y = moving_d, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(0,250,50),labels=seq(0,250,50), limits=c(0,250)) +
  xlab("") + ylab("Quadrupedal movement duration (s)") + labs("") +
    annotate("text", x = "Mulligans Flat", y =250, label = "C", size = 9, hjust = -2)
print(moved_site)
#ggsave(filename = "1st assay - study site v moving dur.jpeg", moved_site, width=100, height= 150, units = "mm")


#Combine grooming plots
plot <- ggarrange(groomd_site, groomo_site, moved_site, ncol = 3, nrow=1)
plot <- annotate_figure(plot, 
        #left = text_grob("Adjusted behaviours over two assays", rot=90, size = 16, face = "bold"),
        bottom = text_grob("Study site", size = 20))
print(plot)
ggsave(filename = "1st assay - groom and move violin plots.jpeg", plot, width=350, height= 150, units = "mm")


#Perching vs temp
perchtemp <- ggplot(data=data1, aes(x = temp, y = perch_d)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,1000,250),labels=seq(0,1000,250), limits=c(-30, 1000)) +
  xlab(expression(paste("Ambient temperature (", degree, "C)"))) + 
  ylab("Perching duration (s)") + labs("") +
  annotate("text", x =23, y =990, label = "A", size = 10, hjust = 0)
print(perchtemp)
ggsave(filename = "1st assay perch temp.jpeg", perchtemp, width=150, height= 150, units = "mm")

#Latency to emerge vs temp
emergetemp <- ggplot(data=data1, aes(x = temp, y = emerge_max)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#482677", fill = "#674A8E") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_x_continuous(breaks=seq(10,25,5),labels=seq(10,25,5), limits=c(10,25)) +
  xlab(expression(paste("Ambient temperature (", degree, "C)"))) + 
  ylab("Latency to emerge (s)") + labs("") +
  annotate("text", x =23, y =59, label = "B", size = 10, hjust = -1)

print(emergetemp)
ggsave(filename = "1st assay emerge temp.jpeg", emergetemp, width=150, height= 150, units = "mm")

#Emerge weight
emergeweight <- ggplot(data=data1, aes(x = body_weight_kg, y = emerge_max)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#2D718E", fill = "#5089A1") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_x_continuous(breaks=seq(0.25,1.75,0.5),labels=seq(0.25,1.75,0.5), limits=c(0.25,1.75)) +
  xlab("Body weight (kg)") + 
  ylab("Latency to emerge (s)") + 
  labs("") +
    annotate("text", x =1.6, y =59, label = "C", size = 10, hjust = 0)

print(emergeweight)
ggsave(filename = "1st assay emerge weight.jpeg", emergeweight, width=150, height= 150, units = "mm")


#Combine emerge plots
plot <- ggarrange(perchtemp, emergetemp, emergeweight, ncol = 3, nrow=1)
plot <- annotate_figure(plot, 
        bottom = text_grob("Study site", size = 20))
print(plot)
ggsave(filename = "1st assay emerge plots.jpeg", plot, width=350, height= 150, units = "mm")



```

## ** MULTIPLE ASSAYS
#Subsetting data to animals with repeated assays
```{r}
values_to_exclude <- c("524E3", "53221", "53511", "53512", "53515", "53526", "563A6", "56ABE", "56EB2", "5FC08", "6D409" , "6D53F" , "6E990" , "71A4D" , "71B69" , "86E19" , "86FFC" , "87F61", "BCA09")

tally <- table(data$quoll_code)
print(tally)

data2 <- data %>%
  filter(!quoll_code %in% values_to_exclude)

write.csv(data2, "data2 - individuals with two assays raw data.csv")

```

#Capture and recapture environmental vars GLM analysis
```{r}

mod <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

mod <- glm(food_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
mod <- glm(food_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

mod <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
mod <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

mod <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
mod <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

mod <- glm(legs_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
mod <- glm(legs_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

mod <- glm(moving_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
mod <- glm(moving_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

mod <- glm(perch_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
mod <- glm(perch_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

mod <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
mod <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
mod <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

mod <- glm(stress_in_trap ~ temp + moon_phase, data=data2)
mod <- glm(stress_in_bag ~ temp + moon_phase, data=data2)
mod <- glm(stress_on_table ~ temp + moon_phase, data=data2)

```

#Capture and recapture environmental vars tables with kableExtra
```{r}
response_var <- all.vars(formula(mod))[1]
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE)
table

```

#Capture and recapture behaviour GLMMs with environmental vars
```{r}

data2 <- data2 %>%
  mutate(age_n = as.numeric(as.character(age_n)))

mod <- lmer(bait_eaten_g ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + (1|arena),
            data=data2, na.action = "na.fail")

mod <- lmer(emerge_max ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + (1|arena),
            data=data2, na.action = "na.fail")

mod <- lmer(food_d ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase +(1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(food_o ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight + 
              time_processtoassay + (1|arena), data=data2, na.action = "na.fail")

mod <- lmer(grooming_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena),
            data=data2, na.action = "na.fail")

mod <- lmer(grooming_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(jump_climb_d ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight+ (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(jump_climb_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(legs_d ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(legs_o ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight + 
              time_processtoassay + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(moving_d ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + 
              time_assaytolight + time_processtoassay + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(moving_o ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + 
              time_assaytolight + time_processtoassay + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(perch_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(perch_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(stress_in_bag ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(stress_in_trap ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(stress_on_table ~ study_site + sex + age_n + cond_n + body_weight_kg + 
            (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(sumsect_o ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + 
              time_processtoassay +  (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(totalact_o ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + 
              time_processtoassay + time_assaytolight + (1|arena), 
            data=data2, na.action = "na.fail")
```

```{r}

#Tables with kableExtra
response_var <- all.vars(formula(mod))[1]
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE)
table

```

#Capture and recapture behaviour AICc model selection
```{r}

control_ml <- lmerControl(optimizer = "Nelder_Mead")

#Food occ   
mod_fo_process <- lmer(food_o ~ time_processtoassay + (1|arena), 
            data=data2, control = control_ml, na.action = "na.fail")
mod_fo_light <- lmer(food_o ~ time_assaytolight + (1|arena), 
            data=data2, control = control_ml, na.action = "na.fail")
models <- list(mod_fo_process, mod_fo_light)
model.names <- c("Process to assay", "Assay to light")
aictab(cand.set = models, modnames = model.names)

#Legs occ   
mod_lo_process <- lmer(legs_o ~ time_processtoassay + (1|arena), 
            data=data2, control = control_ml, na.action = "na.fail")
mod_lo_light <- lmer(legs_o ~ time_assaytolight + (1|arena), 
            data=data2, control = control_ml, na.action = "na.fail")
models <- list(mod_lo_process, mod_lo_light)
model.names <- c("Process to assay", "Assay to light")
aictab(cand.set = models, modnames = model.names)


#Move occ   
mod_mo_process <- lmer(moving_o ~ time_processtoassay + (1|arena), 
            data=data2, control = control_ml, na.action = "na.fail")
mod_mo_light <- lmer(moving_o ~ time_assaytolight + (1|arena), 
            data=data2, control = control_ml, na.action = "na.fail")
models <- list(mod_mo_process, mod_mo_light)
model.names <- c("Process to assay", "Assay to light")
aictab(cand.set = models, modnames = model.names)

#Move dur   
mod_md_process <- lmer(moving_d ~ time_processtoassay + (1|arena), 
            data=data2, control = control_ml, na.action = "na.fail")
mod_md_light <- lmer(moving_d ~ time_assaytolight + (1|arena), 
            data=data2, control = control_ml, na.action = "na.fail")
models <- list(mod_md_process, mod_md_light)
model.names <- c("Process to assay", "Assay to light")
aictab(cand.set = models, modnames = model.names)


#Table stress   
mod_table_process <- lmer(stress_on_table ~ time_processtoassay + (1|arena), 
            data=data2, control = control_ml, na.action = "na.fail")
mod_table_light <- lmer(stress_on_table ~ time_assaytolight + (1|arena), 
            data=data2, control = control_ml, na.action = "na.fail")
models <- list(mod_table_process, mod_table_light)
model.names <- c("Process to assay", "Assay to light")
aictab(cand.set = models, modnames = model.names)

```


#Plots for two assays
```{r}

#Grooming duration v sex 
groomdur <- ggplot(data=data2, aes(x = sex, y = grooming_d, fill = sex)) + 
  geom_boxplot() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
             shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#4DBC94")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,80,20),labels=seq(0,80,20), limits=c(0,80)) +
  xlab("Sex") + 
  ylab("Grooming duration (s)") + labs("") +
  scale_x_discrete(labels = c("M" = "Male", "F" = "Female"))+
  annotate("text", x="M", y =80, label = "C", size = 10, hjust = -2)
print(groomdur)
ggsave(filename = "2 assays - sex v grooming.jpeg", groomdur, width=150, height= 150, units = "mm")


#Bait eaten v age
baitage <- ggplot(data=data2, aes(x = age_estimate, y = bait_eaten_g, fill = age_estimate)) + 
  geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
             shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#68C6A5","#D0E970")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=19)) + 
  scale_y_continuous(breaks=seq(0,50,25),labels=seq(0,50,25), limits=c(0,50)) +
  xlab("Age estimate") + 
  ylab("Bait eaten (g)") + labs("") +
  scale_x_discrete(labels = c("<1yr" = "<1 year", "1-2yrs" = "1-2 years", "2-3yrs" ="2-3 years"))+
  annotate("text", x =2, y =50, label = "A", size = 10, hjust = -6)
print(baitage)

#Perhing v site
perchocc <- ggplot(data=data2, aes(x = study_site, y = perch_o, fill = study_site)) + 
  geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
             shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#68C6A5")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=19)) + 
  scale_y_continuous(breaks=seq(0,60,20),labels=seq(0,60,20), limits=c(0,60)) +
  xlab("Study site") + 
  ylab(expression(paste("Perching occurrences ", italic(" (n)")))) +
  annotate("text", x ="Mulligans Flat", y =60, label = "B", size = 10, hjust = -2)
print(perchocc)
#ggsave(filename = "2 assays raw - site v perching.jpeg", perchocc, width=150, height= 150, units = "mm")

#Combine  plots
plot <- ggarrange(baitage, perchocc, groomdur, ncol = 3, nrow=1)
#plot <- annotate_figure(plot, 
        #left = text_grob("Adjusted behaviours over two assays", rot=90, size = 16, face = "bold"),
        #bottom = text_grob("Study site", size = 20))
print(plot)
ggsave(filename = "2 assays -bait perch emerge.jpeg", plot, width=350, height= 150, units = "mm")

viridis(9)


#Total section vs moon 
sum_moon <- ggplot(data=data2, aes(x = moon_phase, y = sumsect_o)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#440154", fill = "#82568D") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,100,25),labels=seq(0,100,25), limits=c(0,100)) +
  xlab("Moon illumination (%)") + 
    ylab(expression(paste("Sum of arena section visits", italic(" (n)")))) + labs("") +
  annotate("text", x =100, y =100, label = "A", size = 10, hjust = 1)
print(sum_moon)
#ggsave(filename = "2 assay raw - emerge temp.jpeg", emergetemp, width=150, height= 150, units = "mm")


#Food occ v time assay to light 
foodo_light <- ggplot(data=data2, aes(x = time_assaytolight, y = food_o)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#472D7B", fill = "#8473A7") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,50,10),labels=seq(0,50,10), limits=c(-5,55)) +
  #scale_x_continuous(breaks=seq(10,25,5),labels=seq(10,25,5), limits=c(10,25)) +
  xlab("Time: assay to first light (mins)") + 
  ylab(expression(paste("Food interaction occurrences ", italic(" (n)")))) + labs("") +
  annotate("text", x =400, y =55, label = "B", size = 10, hjust = 1)
print(foodo_light)

#ggsave(filename = "2 assay raw - food light.jpeg", foodo_light, width=150, height= 150, units = "mm")

#Food occ v time process to assay
foodo_process <- ggplot(data=data2, aes(x = time_processtoassay, y = food_o)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#3B528B", fill = "#7C8CB2") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,50,10),labels=seq(0,50,10), limits=c(-10,55)) +
  scale_x_continuous(breaks=seq(50,250,50),labels=seq(50,250,50), limits=c(40,250)) +
  xlab("Time: processing to assay (mins)") + 
  ylab(expression(paste("Food interaction occurrences ", italic(" (n)")))) + labs("") +
  annotate("text", x =250, y =55, label = "C", size = 10, hjust = 1)
print(foodo_process)

#ggsave(filename = "2 assay raw - food process.jpeg", foodo_process, width=150, height= 150, units = "mm")


#Move dur v time assay to light 
moved_light <- ggplot(data=data2, aes(x = time_assaytolight, y = moving_d)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#2C728E", fill = "#72A1B4") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,250,50),labels=seq(0,250,50), limits=c(0,250)) +
  #scale_x_continuous(breaks=seq(10,25,5),labels=seq(10,25,5), limits=c(10,25)) +
  xlab("Time: assay to first light (mins)") + 
  ylab("Quadrupedal movement duration (s)") + labs("") +
  annotate("text", x =400, y =245, label = "D", size = 10, hjust = 1)

print(moved_light)
#ggsave(filename = "2 assay raw - legs light.jpeg", legso_light, width=150, height= 150, units = "mm")


#Move occ v time assay to light 
moveo_light <- ggplot(data=data2, aes(x = time_assaytolight, y = moving_o)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#21908C", fill = "#6BB5B2") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,200,50),labels=seq(0,200,50), limits=c(0,200)) +
  #scale_x_continuous(breaks=seq(10,25,5),labels=seq(10,25,5), limits=c(10,25)) +
  xlab("Time: assay to first light (mins)") + 
  ylab(expression(paste("Quadrupedal movement occurrences ", italic(" (n)")))) + labs("") +
  annotate("text", x =395, y =195, label = "E", size = 10, hjust = 1)

print(moveo_light)
#ggsave(filename = "2 assay raw - legs light.jpeg", legso_light, width=150, height= 150, units = "mm")


#Move occ v time process to assay
moveo_process <- ggplot(data=data2, aes(x = time_processtoassay, y = moving_o)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#27AD81", fill = "#6FC8AB") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  #scale_y_continuous(breaks=seq(0,200,50),labels=seq(0,200,50), limits=c(0,200)) +
  scale_x_continuous(breaks=seq(50,300,50),labels=seq(50,300,50), limits=c(50,300)) +
  xlab("Time: processing to assay (mins)") + 
  ylab(expression(paste("Quadrupedal movement occurrences ", italic(" (n)")))) + labs("") +
  annotate("text", x =300, y =195, label = "F", size = 10, hjust = 1)

print(moveo_process)
#ggsave(filename = "2 assay raw - legs process.jpeg", legso_process, width=150, height= 150, units = "mm")


#Legs occ v time assay to light 
legso_light <- ggplot(data=data2, aes(x = time_assaytolight, y = legs_o)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#5DC863", fill = "#93DA97") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,150,50),labels=seq(0,150,50), limits=c(0,150)) +
  #scale_x_continuous(breaks=seq(10,25,5),labels=seq(10,25,5), limits=c(10,25)) +
  xlab("Time: assay to first light (mins)") + 
  ylab(expression(paste("Hind leg stand occurrences", italic(" (n)")))) + labs("") +
  annotate("text", x =400, y =150, label = "G", size = 10, hjust = 1)

print(legso_light)
#ggsave(filename = "2 assay raw - legs light.jpeg", legso_light, width=150, height= 150, units = "mm")


#Legs occ v time process to assay
legso_process <- ggplot(data=data2, aes(x = time_processtoassay, y = legs_o)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#AADC32", fill = "#C6E876") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,150,50),labels=seq(0,150,50), limits=c(-20,150)) +
  scale_x_continuous(breaks=seq(50,280,50),labels=seq(50,280,50), limits=c(30,290)) +
  xlab("Time: processing to assay (mins)") + 
  ylab(expression(paste("Hind leg stand occurrences", italic(" (n)")))) + labs("") +
  annotate("text", x =290, y =150, label = "H", size = 10, hjust = 1)

print(legso_process)
#ggsave(filename = "2 assay raw - legs process.jpeg", legso_process, width=150, height= 150, units = "mm")


#Latency to emerge vs temp
emergetemp <- ggplot(data=data2, aes(x = temp, y = emerge_max)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#AADC32", fill = "#C6E876") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_x_continuous(breaks=seq(10,25,5),labels=seq(10,25,5), limits=c(10,25)) +
  xlab(expression(paste("Ambient temperature (", degree, "C)"))) + 
  ylab("Latency to emerge (s)") + labs("") +
  annotate("text", x =25, y =60, label = "I", size = 10, hjust = 1)
print(emergetemp)
#ggsave(filename = "2 assay raw - emerge temp.jpeg", emergetemp, width=150, height= 150, units = "mm")


#Combine  plots
plot <- ggarrange(sum_moon, foodo_light, foodo_process, 
                  moved_light, moveo_light, moveo_process, 
                  legso_light, legso_process, emergetemp, 
                  ncol = 3, nrow=3) 
#plot <- annotate_figure(plot, 
        #left = text_grob("Adjusted behaviours over two assays", rot=90, size = 16, face = "bold"),
        #bottom = text_grob("Study site", size = 20))
print(plot)
ggsave(filename = "2 assays - fixed effects.jpeg", plot, width=350, height= 350, units = "mm")


```

#Environmental vars data mutated
```{r}

#Mutating the environmental variables 
data2_mutate <- data2 %>%
  mutate_at(vars(5, 44, 65, 66), ~ as.vector(scale(.)))

data2$condition <- factor(data2$condition, levels = c("Excellent", "Good", "Fair", "Poor"))

str(data2_mutate$age_n)

write.csv(data2_mutate, "data2_mutate - both assays env vars adjusted.csv")

```

#Adjusted behaviour variables - extracting values
```{r}

mod <- glm(food_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$foodo_p <- predict(mod, type = "response")
             
mod <- glm(food_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$foodd_p <- predict(mod, type = "response")
             
mod <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$groomo_p <- predict(mod, type = "response")

mod <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$groomd_p <- predict(mod, type = "response")
             
mod <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$jumpo_p <- predict(mod, type = "response")

mod <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$jumpd_p <- predict(mod, type = "response")

mod <- glm(legs_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$legsd_p <- predict(mod, type = "response")

mod <- glm(legs_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$legso_p <- predict(mod, type = "response")

mod <- glm(moving_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$moved_p <- predict(mod, type = "response")
             
mod <- glm(moving_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$moveo_p <- predict(mod, type = "response")

mod <- glm(perch_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$perchd_p <- predict(mod, type = "response")
             
mod <- glm(perch_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$percho_p <- predict(mod, type = "response")

mod <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$bait_p <- predict(mod, type = "response")
 
mod <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$sumsecto_p <- predict(mod, type = "response")            
             
mod <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$totalacto_p <- predict(mod, type = "response")
             
mod <- glm(stress_in_trap ~ temp + moon_phase, family = gaussian, data=data2_mutate)
             data2_mutate$trapstress_p <- predict(mod, type = "response")

mod <- glm(stress_in_bag ~ temp + moon_phase,
           family=gaussian, data=data2_mutate)
             data2_mutate$bagstress_p <- predict(mod, type = "response")

mod <- glm(stress_on_table ~ temp + moon_phase,
           family=gaussian, data=data2_mutate)
             data2_mutate$tablestress_p <- predict(mod, type = "response")

mod <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + time_processtoassay,
           family=gaussian, data=data2_mutate)
             data2_mutate$emerge_p <- predict(mod, type = "response")

```

#Adjusted behaviour variables - create df 
Accounting for environmental heterogeneity for both assays
```{r}

data2_pred <- data2_mutate %>%
  select(-food_o, -food_d, -grooming_o, -grooming_d, 
                     -jump_climb_o, -jump_climb_d, -legs_o, -legs_d, 
                     -moving_o, -moving_d, -perch_d, -perch_o, -resting_o,
                     -resting_d, -bait_eaten_g, 
                     -sumsect_o, -totalact_o, -emerge_max, -time_to_emerge_s, -arena_entry) %>%
mutate(assay_number = as.factor(assay_number))

str(data2_pred)

write.csv(data2_pred,"data2_pred - both assays adjusted env variables.csv")

```

#Adjusted behaviour variables - test vs assay number
```{r}
mod <- glm(foodd_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(foodo_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(bait_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(groomd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(groomo_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(jumpd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(jumpo_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(legsd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(legso_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(moved_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(moveo_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(emerge_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(perchd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(percho_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(sumsecto_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(totalacto_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(bagstress_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(trapstress_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(tablestress_p ~ assay_number, family=gaussian, data=data2_pred)

```

```{r}
response_var <- all.vars(formula(mod))[1]
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE)
table

```

#Adjusted behaviour variables vs assay number plots
```{r}
#Latency to emerge
ed_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = emerge_p, 
                        fill = assay_number)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,50,10),labels=seq(0,50,10), limits=c(0,50)) +
  xlab("Assay number") + 
  ylab(expression(paste("Latency to emerge (s)")))+
  labs("")+
  annotate("text", x = "2", y =50, label = "A", size = 10, hjust = -2)
print(ed_plot)

ggsave(filename = "assay number - emerge.jpeg", ed_plot, width=150, height= 150, units = "mm")



#Food interaction occurrences
fo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = foodo_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  #scale_y_continuous(breaks=seq(0,35,10),labels=seq(0,35,10), limits=c(0,35)) +
  xlab("") + ylab(expression(paste("Food interaction occurrences", italic(" (n) ")))) +
  annotate("text", x = "2", y =30, label = "B", size = 10, hjust = -3) + 
  labs("") 
print(fo_plot)
#ggsave(filename = "assay number - food occ - site.jpeg", fo_plot, width=200, height= 150, units = "mm")


#Jump climb duration
jd_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = jumpd_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  #scale_y_continuous(breaks=seq(0,200,50),labels=seq(0,200,50), limits=c(0,200)) +
   xlab("") + ylab(expression(paste("Jumping and climbing duration (s)" )))  +
  annotate("text", x = "2", y =200, label = "C", size = 10, hjust = -3) +
  labs("") 
print(jd_plot)
#ggsave(filename = "assay number - jump dur - site.jpeg", jd_plot, width=200, height= 150, units = "mm")

#Jump climb occurrences
jo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = jumpo_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) +
  #scale_y_continuous(breaks=seq(0,80,20),labels=seq(0,80,20), limits=c(0,80)) +
  xlab("") + ylab(expression(paste("Jumping and climbing occurrences ", italic(" (n) ")))) +
  annotate("text", x = "2", y =80, label = "D", size = 10, hjust = -2.5) + 
  labs("") 
print(jo_plot)
#ggsave(filename = "assay number - jump occ - site.jpeg", jo_plot, width=200, height= 150, units = "mm")

#Perching occurrences
po_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = percho_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,30,10),labels=seq(0,30,10), limits=c(0,30)) +
  xlab("Assay number") + ylab(expression(paste("Perching occurrences ", italic(" (n) ")))) + 
    annotate("text", x = "2", y =30, label = "E", size = 10, hjust = -2.5) + 
  labs("") 
print(po_plot)
ggsave(filename = "assay number - perch occ.jpeg", po_plot, width=150, height= 150, units = "mm")



#Moving duration
md_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = moved_p, 
                        fill = assay_number)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,160,50),labels=seq(0,160,50), limits=c(0,160)) +
  xlab("") + ylab(expression(paste("Quadrupedal movement duration (s)" ))) +
  annotate("text", x = "2", y =160, label = "F", size = 10, hjust = -3) + 
  labs("") 
print(md_plot)
#ggsave(filename = "assay number - move dur - site.jpeg", md_plot, width=200, height= 150, units = "mm")

#Moving occurrences
mo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = moveo_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,150,50),labels=seq(0,150,50), limits=c(0,150)) +
  xlab("") + ylab(expression(paste("Quadrupedal movement occurrences", italic(" (n) ")))) +
  annotate("text", x = "2", y =150, label = "G", size = 10, hjust = -3) + 
  labs("") 
print(mo_plot)
#ggsave(filename = "assay number - move occ - site.jpeg", mo_plot, width=200, height= 150, units = "mm")


#Legs occurrences
lo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = legso_p, 
                        fill = assay_number)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,110,20),labels=seq(0,110,20), limits=c(0,110)) +
  xlab("") + ylab(expression(paste("Standing on hind legs occurrences", italic("(n) ")))) +
  annotate("text", x = "2", y =110, label = "H", size = 10, hjust = -2.5) +
  labs("") 
print(lo_plot)
ggsave(filename = "assay number - legs occ - site.jpeg", lo_plot, width=200, height= 150, units = "mm")

#Sum total activity 
act_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = totalacto_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,400,100),labels=seq(0,400,100), limits=c(0,400)) +
  xlab("") + ylab(expression(paste("Total activity occurrences", italic(" (n) ")))) +
  annotate("text", x = "2", y =400, label = "I", size = 10, hjust = -2.5) + 
  labs("") 
print(act_plot)
#ggsave(filename = "assay number - tot sect - site.jpeg", act_plot, width=200, height= 150, units = "mm")

#Sum section visits
sum_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = sumsecto_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(0,80,20),labels=seq(0,80,20), limits=c(0,80)) +
  xlab("") + ylab(expression(paste("Total arena section visits", italic(" (n) ")))) +
  annotate("text", x = "2", y =80, label = "J", size = 10, hjust = -5) + 
  labs("") 
print(sum_plot)
#ggsave(filename = "assay number - sum sect - site.jpeg", sum_plot, width=200, height= 150, units = "mm")

plot <- ggarrange(ed_plot, fo_plot, jd_plot, jo_plot, 
                  po_plot, md_plot, mo_plot, 
                    lo_plot, act_plot, sum_plot, nrow=5, ncol=2)

plot <- annotate_figure(plot, 
        bottom = text_grob("Assay number", size = 24))
print(plot)
ggsave(filename = "2 assays - activity by assay number.jpeg", plot, width=300, height= 600, units = "mm")




#Bag stress
bag_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = bagstress_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(1,1.5,0.1),labels=seq(1,1.5,0.1), limits=c(0.9,1.5)) +
  xlab("") + ylab("Adjusted bag stress rating") +
  annotate("text", x = "2", y =1.5, label = "A", size = 10, hjust = -2) + 
  labs("") 
print(bag_plot)
#ggsave(filename = "assay number - sum sect - site.jpeg", sum_plot, width=200, height= 150, units = "mm")


#Table stress
table_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = tablestress_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#7E67A0","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(1,1.5,0.1),labels=seq(1,1.5,0.1), limits=c(0.9,1.5)) +
  xlab("") + ylab("Adjusted table stress rating") +
  annotate("text", x = "2", y =1.5, label = "B", size = 10, hjust = -2) + 
  labs("") 
print(table_plot)
#ggsave(filename = "assay number - sum sect - site.jpeg", sum_plot, width=200, height= 150, units = "mm")


plot <- ggarrange(bag_plot, table_plot)

plot <- annotate_figure(plot, 
        bottom = text_grob("Capture number", size = 24))
print(plot)
ggsave(filename = "2 assays - stress by capture.jpeg", plot, width=300, height= 150, units = "mm")


```

#** PERSONALITY AND PLASTICITY 
Prep data for coefficient left_join 
```{r}

view(data2_pred)
str(data2_pred)
view(quoll2)
quoll2 <- data2_pred %>%
  select(-assay_date, -initial_repeat_assay, -trap_location, -snout, 
                     -haunches, -trap_session_date, -trap_session_morning, -first_light,
                     -ssr, -process_start, -process_end, -pouch, -teeth_colour, 
                     -teeth_sharpness, -teeth_shine, stress_in_trap, stress_in_bag, stress_on_table)

unique(quoll2$age_estimate)

quoll2 <- quoll2 %>%
  # assign as factor
  mutate(condition = as.factor(condition), 
         age_estimate = as.factor(age_estimate)) %>%
  # Assign new labels
  mutate(age_estimate = recode(age_estimate, 
                               "1-2yrs" = "1–2 years", 
                               "<1yr" = "<1 year", 
                               "2-3yrs" = "2–3 years"))  %>%
  # reorder new labels
   mutate(condition = factor(condition, 
                               levels = c("Excellent", "Good", 
                                          "Fair", "Poor")), 
          age_estimate = factor(age_estimate, 
                               levels = c("2–3 years", 
                                          "1–2 years", "<1 year")))


str(quoll2)

write.csv(quoll2, "quoll2.csv")

```

#Intercept and slope - extracting adjusted values for intercept (personality) and  slope (plasticity) over both assays
```{r}

# Create a list of dependent behavioural variables
dependent <- c("foodd_p","foodo_p","groomd_p","groomo_p",
               "jumpd_p","jumpo_p","legsd_p","legso_p", "moved_p",
               "moveo_p", "perchd_p", "percho_p", "bait_p", "sumsecto_p", "totalacto_p", 
               "trapstress_p", "bagstress_p", "tablestress_p", "emerge_p")

# Define the levels in an object
quolls <- levels(factor(quoll2$quoll_code))

# Create a blank dataframe with four columns
coefficients <- data.frame(quoll_code=NULL, intercept=NULL, 
                           slope=NULL, variable=NULL)

# Loop to extract the intercept and slope of each behavioural response
for(v in 1:NROW(dependent)) {
  for(i in 1:NROW(quolls)){
    quoll_code <- quolls[i]
    variable <- dependent[v]
    mod <- lm(eval(as.name(paste0(variable))) ~ 
                assay_number + temp + moon_phase + time_assaytolight + time_processtoassay, 
              data=subset(quoll2, quoll_code==quolls[i]))
    i <- coef(mod)[1]
    s <- coef(mod)[2]
    results <- data.frame(cbind(quoll_code, i, s, variable))
    coefficients <- rbind(coefficients, results)
  }
}

# Convert the df to wide format
coefficients <- reshape(coefficients, idvar="quoll_code", 
                        timevar="variable", direction="wide")

# Define names of the coefficients
names(coefficients) <- gsub("\\.", "_", names(coefficients))

# Remove duplicated coefficients
coefficients <- coefficients[ , !duplicated(colnames(coefficients))]

# Check structure of coefficients
str(coefficients)

#If they are being read as characters, change to numeric 
cols_to_convert <- setdiff(names(coefficients), "quoll_code")
coefficients[cols_to_convert] <- lapply(coefficients[cols_to_convert], as.numeric)

# Join behavioural df with post-release df
ppdata <- left_join(quoll2, coefficients, by="quoll_code", "session") %>%
  distinct(quoll_code, .keep_all = TRUE)

# Remove duplicated column names
ppdata <- ppdata[ , !duplicated(colnames(ppdata))]

# Write to csv file
write_csv(ppdata, "ppdata - intercept and slope data.csv")

str(ppdata)

```

# Analyse behaviour indicators for personality and plasticity 

  1. Test the influence of fixed (e.g., site) and random effects (e.g., arena) on behavioural responses (e.g., food interaction duration) using the `lmer()` function.
  2. If multiple fixed effects produce significance, perform model selection using the dredge() function to determine which fixed effects are within delta 2 AICc.

#Intercept GLMMs - testing behaviour intercept (personality) against independent variables
```{r}


mod <- lmer(i_bait_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_emerge_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_foodd_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_foodo_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_groomd_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_groomo_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_jumpd_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_jumpo_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_legsd_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_legso_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_moved_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_moveo_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_perchd_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_percho_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_sumsecto_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_totalacto_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_trapstress_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_bagstress_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_tablestress_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

```

#Intercept tables
```{r}
response_var <- all.vars(formula(mod))[1]
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE) %>%
  kable_classic(full_width = F)
table

```

#Intercept AICc model selection
```{r}

#Perching duration
mod_pdi_site <- lmer(i_perchd_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_pdi_weight <- lmer(i_perchd_p ~ sex*body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_pdi_site, mod_pdi_weight)
model.names <- c("Study site", "Interaction of Sex and body weight kg")
aictab(cand.set = models, modnames = model.names)

```

#Intercept plots
```{r}

#Bag stress
i_bs_site <- ggplot(data=ppdata, aes(x = study_site, y = i_bagstress_p, fill=study_site)) + 
geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(0.9,1.3,0.1),labels=seq(0.9,1.3,0.1), limits=c(0.9,1.3)) +
  xlab("") + 
  ylab("Adjusted bag stress rating intercept") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 1.3, label = parse(text = "A"), size = 10, hjust = -2)
print(i_bs_site)
#ggsave(filename = "intercept - study site v bag stress.jpeg", i_bs_site, width=200, height= 150, units = "mm")

#Table stress
i_ts_site <- ggplot(data=ppdata, aes(x = study_site, y = i_tablestress_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(0.9,1.3,0.1),labels=seq(0.9,1.3,0.1), limits=c(0.9,1.3)) +
  xlab("") + 
  ylab("Adjusted table stress rating intercept") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 1.3, label = parse(text = "B"), size = 10, hjust = -2)
print(i_ts_site)
#ggsave(filename = "intercept - study site v table stress.jpeg", i_ts_site, width=200, height= 150, units = "mm")

#Latency to emerge
i_e_site <- ggplot(data=ppdata, aes(x = study_site, y = i_emerge_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(0,50,10),labels=seq(0,50,10), limits=c(0,50)) +
  xlab(" ") + 
  ylab("Adjusted latency to emerge (s) intercept") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 50, label = parse(text = "C"), size = 10, hjust = -2)
print(i_e_site)
#ggsave(filename = "intercept - study site v latency to emerge.jpeg", i_e_site, width=200, height= 150, units = "mm")


#Bait eaten
i_b_site <- ggplot(data=ppdata, aes(x = study_site, y = i_bait_p, fill=study_site)) + 
geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  xlab(" ") + 
  ylab("Adjusted bait eaten (g) intercept") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 20, label = parse(text = "F"), size = 10, hjust = -2)
print(i_b_site)

#ggsave(filename = "intercept - study site v bait.jpeg", i_b_site, width=200, height= 150, units = "mm")

#Groom duration
i_gd_site <- ggplot(data=ppdata, aes(x = study_site, y = i_groomd_p, fill=study_site)) + geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("") + 
  ylab("Adjusted grooming duration (s) intercept") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 25, label = parse(text = "E"), size = 10, hjust = -2)
print(i_gd_site)

#ggsave(filename = "intercept - study site v grooming dur.jpeg", i_gd_site, width=150, height= 150, units = "mm")

#Hind legs duration
i_ld_site <- ggplot(data=ppdata, aes(x = study_site, y = i_legsd_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(100,300,100),labels=seq(100,300,100), limits=c(100,300)) +
  xlab(" ") + 
  ylab("Adjusted hindleg stands duration (s) intercept") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 300, label = parse(text = "D"), size = 10, hjust = -2)
print(i_ld_site)

#ggsave(filename = "intercept - study site v legs dur.jpeg", i_ld_site, width=200, height= 150, units = "mm")


#Combine plots
plot <- ggarrange(i_bs_site, i_ts_site,
                  i_e_site,i_ld_site,  
                  i_gd_site, i_b_site, nrow=3,ncol=2)
plot <- annotate_figure(plot,
        bottom = text_grob("Study site", size = 20))
print(plot)
ggsave(filename = "intercept plots A.jpeg", plot, width=300, height= 400, units = "mm")



#Jump/climb duration
i_jd_site <- ggplot(data=ppdata, aes(x = study_site, y = i_jumpd_p, fill=study_site)) + 
geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(0,200,50),labels=seq(0,200,50), limits=c(0,220)) +
  xlab(" ") + 
  ylab("Adjusted jumping + climbing duration (s) intercept") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 220, label = parse(text = "A"), size = 10, hjust = -2)

print(i_jd_site)
#ggsave(filename = "intercept - study site v jumpclimb dur.jpeg", i_jd_site, width=200, height= 150, units = "mm")


#Jump/climb occurrences
i_jo_site <- ggplot(data=ppdata, aes(x = study_site, y = i_jumpo_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(0,80,20),labels=seq(0,80,20), limits=c(0,90)) +
  xlab(" ") + 
  ylab(expression(paste("Adjusted jumping + climbing occurrences ", italic("(n)"), " intercept"))) +
  labs("") +
  annotate("text", x = "Mulligans Flat", y = 90, label = parse(text = "B"), size = 10, hjust = -2)

print(i_jo_site)
#ggsave(filename = "intercept - study site v jumpclimb occ.jpeg", i_jo_site, width=200, height= 150, units = "mm")


#Perch duration
i_pd_site <- ggplot(data=ppdata, aes(x = study_site, y = i_perchd_p, fill=study_site)) + geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=17)) + 
  #scale_y_continuous(breaks=seq(50,300,100),labels=seq(50,300,100), limits=c(50,300)) +
  xlab(" ") + 
  ylab("Adjusted perching duration (s) intercept") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 300, label = parse(text = "C"), size = 10, hjust = -2)
print(i_pd_site)
#ggsave(filename = "intercept - study site v perch dur.jpeg", i_pd_site, width=200, height= 150, units = "mm")

#Perch occurrences
i_po_site <- ggplot(data=ppdata, aes(x = study_site, y = i_percho_p, fill=study_site)) + geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab(expression(paste("Adjusted perching occurrences ", italic("(n)"), " intercept"))) +
  annotate("text", x = "Mulligans Flat", y = 30, label = parse(text = "D"), size = 10, hjust = -2)
print(i_po_site)
#ggsave(filename = "intercept - study site v perch occ.jpeg", i_po_site, width=200, height= 150, units = "mm")

#Move duration
i_md_site <- ggplot(data=ppdata, aes(x = study_site, y = i_moved_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted quadrupedal movement duration (s) intercept") + 
  labs("") +
  annotate("text", x = "Mulligans Flat", y = 160, label = parse(text = "E"), size = 10, hjust = -2)

  print(i_md_site)
#ggsave(filename = "intercept - study site v move dur.jpeg", i_md_site, width=200, height= 150, units = "mm")

#Sum of section visits
i_sumsect_site <- ggplot(data=ppdata, aes(x = study_site, y = i_sumsecto_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(30,70,10),labels=seq(30,70,10), limits=c(30,70)) +
  xlab("") + 
  ylab(expression(paste("Adjusted sum of section visits ", italic("(n)"), " intercept"))) +
  annotate("text", x = "Mulligans Flat", y = 70, label = parse(text = "F"), size = 10, hjust = -2)
print(i_sumsect_site)
#ggsave(filename = "intercept - study site v sum sections.jpeg", i_sumsect_site, width=200, height= 150, units = "mm")

#Combine plots
plot <- ggarrange(i_jd_site, i_jo_site,
                  i_pd_site,i_po_site,  
                  i_md_site, i_sumsect_site, nrow=3,ncol=2)
plot <- annotate_figure(plot,
        bottom = text_grob("Study site", size = 20))
print(plot)
ggsave(filename = "intercept plots B.jpeg", plot, width=300, height= 400, units = "mm")


#Total activity occurrences
i_act_site <- ggplot(data=ppdata, aes(x = study_site, y = i_totalacto_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#CDE868","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(150,350,100),labels=seq(150,350,100), limits=c(150,350)) +
  xlab("Study site") + 
  ylab(expression(paste("Adjusted total activity occurrences ", italic("(n)"), " intercept"))) 
  #annotate("text", x = "Mulligans Flat", y = 350, label = parse(text = "B"), size = 10, hjust = -4)
print(i_act_site)
ggsave(filename = "intercept - study site v total activity.jpeg", i_act_site, width=150, height= 150, units = "mm")

```

#Slope GLMMs - testing behaviour slope (plasticity) against independent variables
```{r}

mod <- lmer(s_bait_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_emerge_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_foodd_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_foodo_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_groomd_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_groomo_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_jumpd_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_jumpo_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_legsd_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_legso_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_moved_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_moveo_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_perchd_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_percho_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_sumsecto_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_totalacto_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_bagstress_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_trapstress_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_tablestress_p ~ sex + body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")
```

#Tables with kableExtra
```{r}
response_var <- all.vars(formula(mod))[1]
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE) %>%
  kable_classic(full_width = F)
table

```

#Slope AICc model selection
```{r}

#Food occ
mod_fos_cond <- lmer(s_foodo_p ~ cond_n + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_fos_sex <- lmer(s_foodo_p ~ sex + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_fos_weight <- lmer(s_foodo_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

models <- list(mod_fos_cond, mod_fos_sex, mod_fos_weight)
model.names <- c("Condition", "Sex", "Body weight")
aictab(cand.set = models, modnames = model.names)

#Legs occ
mod_los_cond <- lmer(s_legso_p ~ cond_n + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_los_sex <- lmer(s_legso_p ~ sex + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_los_weight <- lmer(s_legso_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_los_site <- lmer(s_legso_p ~ study_site  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

models <- list(mod_los_cond, mod_los_sex, mod_los_weight, mod_los_site)
model.names <- c("Condition", "Sex", "Body weight", "Study site")
aictab(cand.set = models, modnames = model.names)

#Jump occ
mod_jos_cond <- lmer(s_jumpo_p ~ cond_n + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_jos_weight <- lmer(s_jumpo_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_jos_site <- lmer(s_jumpo_p ~ study_site  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

models <- list(mod_jos_cond, mod_jos_weight, mod_jos_site)
model.names <- c("Condition", "Body weight", "Study site")
aictab(cand.set = models, modnames = model.names)

#Move dur
mod_mds_cond <- lmer(s_moved_p ~ cond_n + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_mds_weight <- lmer(s_moved_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_mds_site <- lmer(s_moved_p ~ study_site  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

models <- list(mod_mds_cond, mod_mds_weight, mod_mds_site)
model.names <- c("Condition", "Body weight", "Study site")
aictab(cand.set = models, modnames = model.names)

#Move occ
mod_mos_cond <- lmer(s_moveo_p ~ cond_n + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_mos_weight <- lmer(s_moveo_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_mos_site <- lmer(s_moveo_p ~ study_site  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_mos_sex <- lmer(s_moveo_p ~ sex  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

models <- list(mod_mos_cond, mod_mos_weight, mod_mos_site, mod_mos_sex)
model.names <- c("Condition", "Body weight", "Study site", "Sex")
aictab(cand.set = models, modnames = model.names)

#Table stress
mod_tabs_cond <- lmer(s_tablestress_p ~ cond_n + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_tabs_weight <- lmer(s_tablestress_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_tabs_site <- lmer(s_tablestress_p ~ study_site  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

models <- list(mod_tabs_cond, mod_tabs_weight, mod_tabs_site)
model.names <- c("Condition", "Body weight", "Study site")
aictab(cand.set = models, modnames = model.names)

#Sum section
mod_sums_weight <- lmer(s_sumsecto_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_sums_sex <- lmer(s_sumsecto_p ~ sex  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

models <- list(mod_sums_weight, mod_sums_sex)
model.names <- c("Body weight", "Sex")
aictab(cand.set = models, modnames = model.names)

#Total act
mod_tots_cond <- lmer(s_totalacto_p ~ cond_n + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_tots_weight <- lmer(s_totalacto_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

mod_tots_sex <- lmer(s_totalacto_p ~ sex  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")

models <- list(mod_tots_cond, mod_tots_weight, mod_tots_sex)
model.names <- c("Condition", "Body weight", "Sex")
aictab(cand.set = models, modnames = model.names)

```

#Plasticity x weight plots
```{r}

#Food occ v weight
food <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_foodo_p)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#2C728E", fill = "#72A1B4") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  scale_y_continuous(breaks=seq(-30,10,10),labels=seq(-30,10,10), limits=c(-30,10)) +
  xlab("") + 
    ylab(expression(paste("Adjusted food interaction occurrences", italic(" (n)")," slope"))) + labs("") +
  annotate("text", x =1.6, y =10, label = "D", size = 10, hjust = 1)
print(food)

#Legs occ v weight
legso_weight <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_legso_p)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#440154", fill = "#82568D") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  scale_y_continuous(breaks=seq(-100,25,25),labels=seq(-100,25,25), limits=c(-100,25)) +
  xlab("") + 
    ylab(expression(paste("Adjusted hindleg stand occurrences", italic(" (n)")," slope"))) +
  labs("") +
  annotate("text", x =1.6, y =25, label = "A", size = 10, hjust = 1)
print(legso_weight)

#Legs dur v weight
legsd_weight <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_legsd_p)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#472D7B", fill = "#8473A7") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  scale_y_continuous(breaks=seq(-40,50,20),labels=seq(-40,50,20), limits=c(-40, 50)) +
  xlab("") + 
    ylab("Adjusted hindleg stand duration (s) slope") + labs("") +
  annotate("text", x =1.6, y =50, label = "B", size = 10, hjust = 1)
print(legsd_weight)

#Move occ v weight
moveo_weight <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_moveo_p)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#3B528B", fill = "#7C8CB2") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  scale_y_continuous(breaks=seq(-150,50,50),labels=seq(-150,50,50), limits=c(-150, 50)) +
  xlab("") + 
    ylab(expression(paste("Adjusted quadrupedal movement occurrences", italic(" (n)")," slope"))) +
  annotate("text", x =1.6, y =50, label = "C", size = 10, hjust = 1)
print(moveo_weight)

#Sums sect v weight
sum_weight <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_sumsecto_p)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#21908C", fill = "#6BB5B2") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  scale_y_continuous(breaks=seq(-40,0,20),labels=seq(-40,0,20), limits=c(-40, 0)) +
  xlab("") + 
    ylab(expression(paste("Adjusted total arena section visits", italic(" (n)")," slope"))) +
  annotate("text", x =1.6, y =0, label = "E", size = 10, hjust = 1)
print(sum_weight)

#Total act v weight
tot_weight <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_totalacto_p)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#27AD81", fill = "#6FC8AB") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  scale_y_continuous(breaks=seq(-300,10,50),labels=seq(-300,10,50), limits=c(-300, 20)) +
  xlab("") + 
    ylab(expression(paste("Adjusted total activity", italic(" (n)")," slope"))) +
  annotate("text", x =1.6, y =0, label = "F", size = 10, hjust = 1)
print(tot_weight)

#Combine plots
plot <- ggarrange(legso_weight, legsd_weight, moveo_weight, food, sum_weight, tot_weight, nrow=3,ncol=2)
plot <- annotate_figure(plot,
        bottom = text_grob("Body weight (kg)", size = 20))
print(plot)
ggsave(filename = "slope - weight plots.jpeg", plot, width=300, height= 450, units = "mm")

```

#Plasticity site plots block 1
```{r}

custom_colors <- c("Goorooyarroo" = "#4DBC94", "Mulligans Flat" = "#2D718E")
#custom_colors <- c("Goorooyarroo" = "#674A8E", "Mulligans Flat" = "#2D718E")


#Food interaction dur blob
s_fd_site <- ggplot(data=ppdata, aes(x = study_site, y = s_foodd_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  scale_fill_manual (values = c("#68C6A5","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=17)) + 
  scale_y_continuous(breaks=seq(-100,60,20),labels=seq(-100,60,20), limits=c(-100,60)) +
  xlab("") + 
  ylab("Adjusted food interaction duration (s) slope") + labs("") +
  annotate("text", x ="Mulligans Flat", y =60, label = "A", size = 10, hjust = -3)
print(s_fd_site)

#Food dur vs site smooth
food <- ggplot(data=d2pred, aes(x = assay_number, y =foodd_p, color = study_site, fill = study_site)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, aes(fill = study_site)) +
  theme_minimal() +
    theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=17)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") + 
  scale_y_continuous(breaks=seq(-50,100,25),labels=seq(-50,100,25), limits=c(-50,100)) +
  scale_x_continuous(breaks = c(min(d2pred$assay_number), max(d2pred$assay_number))) +
  xlab("") + 
  ylab("Adjusted food interaction duration (s)") +
  labs(color = "Study site", fill = "Study site") +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  annotate("text", x =max(d2pred$assay_number), y =100, label = "B", size = 10, hjust = 2)

print(food)

#Latency to emerge blob
s_e_site <- ggplot(data=ppdata, aes(x = study_site, y = s_emerge_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add horizontal line at y = 0
  scale_y_continuous(breaks=seq(-10,50,10),labels=seq(-10,50,10), limits=c(-10,50)) +
  scale_fill_manual (values = c("#68C6A5","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=17)) + 
  xlab("") + 
  ylab("Adjusted latency to emerge (s) slope") + labs("") +
  annotate("text", x ="Mulligans Flat", y =50, label = "C", size = 10, hjust = -3)
print(s_e_site)


#Latency to emerge smooth
emerge <- ggplot(data=d2pred, aes(x = assay_number, y = emerge_p, color = study_site, fill = study_site)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, aes(fill = study_site)) +
  theme_minimal() +
    theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=17)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_x_continuous(breaks = c(min(d2pred$assay_number), max(d2pred$assay_number))) +
  scale_y_continuous(breaks=seq(-10,50,10),labels=seq(-10,50,10), limits=c(-10,50)) +
  xlab("") + 
  ylab("Adjusted latency to emerge (s)") +
  labs(color = "Study site", fill = "Study site") +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  annotate("text", x =max(d2pred$assay_number), y =50, label = "D", size = 10, hjust = 2)
print(emerge)


#Jump + climb dur blob
s_jd_site <- ggplot(data=ppdata, aes(x = study_site, y = s_jumpd_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_fill_manual (values = c("#68C6A5","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=17)) + 
  scale_y_continuous(breaks=seq(-150,50,50),labels=seq(-150,50,50), limits=c(-150,50)) +
  xlab("Study site") + 
  ylab("Adjusted jumping + climbing duration (s) slope") +
  annotate("text", x ="Mulligans Flat", y =50, label = "E", size = 10, hjust = -3)
print(s_jd_site)


#Jump climb dur smooth
jump <- ggplot(data=d2pred, aes(x = assay_number, y =jumpd_p, color = study_site, fill = study_site)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, aes(fill = study_site)) +
  theme_minimal() +
    theme(legend.position = "bottom", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=17)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  scale_x_continuous(breaks = c(min(d2pred$assay_number), max(d2pred$assay_number))) +
  xlab("Assay number") + 
  ylab("Adjusted jumping + climbing duration (s)") +
  labs(color = "Study site", fill = "Study site") +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  annotate("text", x =max(d2pred$assay_number), y =200, label = "F", size = 10, hjust = 2)
print(jump)


#Combine plots
plot <- ggarrange(s_fd_site, food, s_e_site, emerge, s_jd_site, jump, nrow=3,ncol=2, heights = c(1, 1, 1.1))
#plot <- annotate_figure(plot,
  #      bottom = text_grob("Body weight (kg)", size = 20))
print(plot)
ggsave(filename = "slope - study site plots 1.jpeg", plot, width=300, height= 400, units = "mm")



```

#Plasticity site plots block 2
```{r}

#Jump + climb occurrences blob
s_jo_site <- ggplot(data=ppdata, aes(x = study_site, y = s_jumpo_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add horizontal line at y = 0
  scale_fill_manual (values = c("#68C6A5","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(-60,0,20),labels=seq(-60,0,20), limits=c(-60,0)) +
  xlab(" ") + 
  ylab(expression(paste("Adjusted jump. + climb. occurrences ", italic("(n)"), " slope")))+
  annotate("text", x ="Mulligans Flat", y =0, label = "A", size = 10, hjust = -2)
print(s_jo_site)

#Jump climb occ smooth
jump2 <- ggplot(data=d2pred, aes(x = assay_number, y =jumpo_p, color = study_site, fill = study_site)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, aes(fill = study_site)) +
  theme_minimal() +
    theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_x_continuous(breaks = c(min(d2pred$assay_number), max(d2pred$assay_number))) +
  xlab("") + 
  ylab(expression(paste("Adjusted jumping + climbing occurrences ", italic("(n)"), ""))) +
  labs(color = "Study site", fill = "Study site") +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  annotate("text", x =max(d2pred$assay_number), y =80, label = "B", size = 10, hjust = 2)
print(jump2)

#Perching duration blob
s_pd_site <- ggplot(data=ppdata, aes(x = study_site, y = s_perchd_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black",  
               shape=21, size=1.5, stroke=1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add horizontal line at y = 0
  scale_fill_manual (values = c("#68C6A5","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_y_continuous(breaks=seq(-200,200,100),labels=seq(-200,200,100), limits=c(-200,200)) +
  xlab(" ") + 
  ylab("Adjusted perching duration (s) slope") + labs("") +
  annotate("text", x ="Mulligans Flat", y =200, label = "C", size = 10, hjust = -2)
print(s_pd_site)

#Perch dur smooth
perch <- ggplot(data=d2pred, aes(x = assay_number, y =perchd_p, color = study_site, fill = study_site)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, aes(fill = study_site)) +
  theme_minimal() +
    theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_x_continuous(breaks = c(min(d2pred$assay_number), max(d2pred$assay_number))) +
  xlab("") + 
  ylab("Adjusted perching duration (s)") +
  labs(color = "Study site", fill = "Study site") +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  annotate("text", x =max(d2pred$assay_number), y =300, label = "D", size = 10, hjust = 2)
 print(perch)

#Perching occurrences blob
s_po_site <- ggplot(data=ppdata, aes(x = study_site, y = s_percho_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add horizontal line at y = 0
  scale_fill_manual (values = c("#68C6A5","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Study site") + 
  ylab(expression(paste("Adjusted perching occurrences ", italic("(n)"), "slope"))) +
  annotate("text", x ="Mulligans Flat", y =5, label = "E", size = 10, hjust = -2)
print(s_po_site)

#Perch occ smooth 
perch2 <- ggplot(data=d2pred, aes(x = assay_number, y =percho_p, color = study_site, fill = study_site)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, aes(fill = study_site)) +
  theme_minimal() +
    theme(legend.position = "bottom", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  scale_x_continuous(breaks = c(min(d2pred$assay_number), max(d2pred$assay_number))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  xlab("Assay number") + 
  ylab(expression(paste("Adjusted perching occurrences ", italic("(n)"), ""))) +
  labs(color = "Study site", fill = "Study site") +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  annotate("text", x =max(d2pred$assay_number), y =30, label = "F", size = 10, hjust = 2)
print(perch2)

#Combine plots
plot <- ggarrange(s_jo_site, jump2, s_pd_site, perch, s_po_site, perch2, nrow=3,ncol=2, heights = c(1, 1, 1.1))
#plot <- annotate_figure(plot,
  #      bottom = text_grob("Body weight (kg)", size = 20))
print(plot)
ggsave(filename = "slope - study site plots 2.jpeg", plot, width=300, height= 400, units = "mm")

```

#Plasticity site plots block 3 and 4
```{r}

#Bag stress rating blob
s_bs_site <- ggplot(data=ppdata, aes(x = study_site, y = s_bagstress_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add horizontal line at y = 0
  scale_fill_manual (values = c("#68C6A5","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  xlab("") + 
  ylab("Adjusted bag stress rating slope") + labs("") +
  annotate("text", x ="Mulligans Flat", y =0.2, label = "A", size = 10, hjust = -2)
print(s_bs_site)

#Bag stress vs site smooth
bag <- ggplot(data=d2pred, aes(x = assay_number, y =bagstress_p, color = study_site, fill = study_site)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, aes(fill = study_site)) +
  theme_minimal() +
    theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_y_continuous(breaks=seq(0.9,1.3,0.1),labels=seq(0.9,1.3,0.1), limits=c(0.9,1.3))+
  scale_x_continuous(breaks = c(min(d2pred$assay_number), max(d2pred$assay_number))) +
  xlab("") + 
  ylab("Adjusted bag stress rating") +
  labs(color = "Study site", fill = "Study site") +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  annotate("text", x =max(d2pred$assay_number), y =1.3, label = "B", size = 10, hjust = 2)
print(bag)

#Table stress site blob
s_ts_site <- ggplot(data=ppdata, aes(x = study_site, y = s_tablestress_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black",  
               shape=21, size=1.5, stroke=1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add horizontal line at y = 0
  scale_fill_manual (values = c("#68C6A5","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=18)) + 
  scale_y_continuous(breaks=seq(-0.1,0.2,0.1),labels=seq(-0.1,0.2,0.1), limits=c(-0.1,0.2)) +
  xlab("Study site") + 
  ylab("Adjusted table stress rating slope") + labs("") +
  annotate("text", x ="Mulligans Flat", y =0.2, label = "C", size = 10, hjust = -2)
print(s_ts_site)

#Table stress vs site 
table <- ggplot(data=d2pred, aes(x = assay_number, y =tablestress_p, color = study_site, fill = study_site)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, aes(fill = study_site)) +
  theme_minimal() +
    theme(legend.position = "bottom", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
   scale_x_continuous(breaks = c(min(d2pred$assay_number), max(d2pred$assay_number))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  xlab("Assay number") + 
  ylab("Adjusted table stress rating") +
  labs(color = "Study site", fill = "Study site") +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  annotate("text", x =max(d2pred$assay_number), y =2, label = "D", size = 10, hjust = 2)
print(table)

#Combine plots
plot <- ggarrange(s_bs_site, bag, s_ts_site, table, nrow=2,ncol=2, heights = c(1, 1.1))
#plot <- annotate_figure(plot,
  #      bottom = text_grob("Body weight (kg)", size = 20))
print(plot)
ggsave(filename = "slope - study site plots 3.jpeg", plot, width=300, height= 400, units = "mm")

#Movement duration v site
s_md_site <- ggplot(data=ppdata, aes(x = study_site, y = s_moved_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey20", fill="grey20", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="black", fill="black", 
               shape=21, size=1.5, stroke=1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  # Add horizontal line at y = 0
  scale_fill_manual (values = c("#68C6A5","#6B9BAF")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Study site") + 
  ylab("Adjusted quadrupedal movement duration (s) slope") + labs("") +
    annotate("text", x ="Mulligans Flat", y =50, label = "A", size = 10, hjust = -2)
print(s_md_site)

#Move dur vs site 
move <- ggplot(data=d2pred, aes(x = assay_number, y =moved_p, color = study_site, fill = study_site)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, aes(fill = study_site)) +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  scale_x_continuous(breaks = c(min(d2pred$assay_number), max(d2pred$assay_number))) +
  xlab("Assay number") + 
  ylab("Adjusted quadrupedal movement duration (s)") +
  labs(color = "Study site", fill = "Study site") +
  scale_color_manual(values = custom_colors) +
  scale_fill_manual(values = custom_colors) +
  annotate("text", x =max(d2pred$assay_number), y =160, label = "B", size = 10, hjust = 2)
print(move)

#Total act v weight
tot <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_moved_p)) + 
 geom_point() +
  geom_smooth(method = "lm", se = TRUE, colour = "#CDE868", fill = "#CDE868") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=16)) + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +  
  scale_y_continuous(breaks=seq(-150,50,50),labels=seq(-150,50,50), limits=c(-170, 50)) +
  xlab("Body weight (kg)") + 
    ylab("Adjusted quadrupedal movement duration (s) slope") +
  annotate("text", x =1.6, y =50, label = "C", size = 10, hjust = 1)
print(tot)

#Combine plots
plot <- ggarrange(s_md_site, move, tot, nrow=2,ncol=2, widths = c(1, 1.25))
#plot <- annotate_figure(plot,
  #      bottom = text_grob("Body weight (kg)", size = 20))
print(plot)
ggsave(filename = "slope - study site plots 4.jpeg", plot, width=400, height= 350, units = "mm")

```

# **Session information**
```{r}
# Display version information for R, OS, and packages
sessionInfo()
```



#Activity over time - prepping data
```{r}

bin <- read_excel(raw_data, sheet="Binned assays", na="N/A")%>%
 clean_names() 
 view(bin)

 # Append metadata for each assay to dataframe
bin_data <- left_join(meta, bin, by=c("assay_id", "quoll_code"), relationship = "many-to-many")
#view(data)
 
bin_data <- left_join(meta, bin, by=c("session", "assay_id", "quoll_code"), relationship = "many-to-many")%>%
 filter(!assay_id %in% c("MulligansA_4", "MulligansA_9", "MulligansB_19")) %>%
  select(-initial_repeat_assay, -trap_location, -time_to_emerge_s, -remaining_bait_g, -bait_eaten_g)

bin_data <- bin_data %>%
  mutate(minute_integer = as.integer(gsub("\\D", "", minute)))

names(bin_data)
view(bin_data)
 
```


```{r}

bin_data$assay_number <- factor(bin_data$assay_number)

plot <- ggplot(data = bin_data, 
       mapping = aes(x = minute_integer, y = moving_occ_binned))

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, color = study_site)) +
  geom_smooth() + # Add line
  labs(x = "Assay minute", y = "Moving Occurrences", title = "Line Plot") + # Add labels
  theme_minimal() # Choose a theme

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, color = assay_number)) +
  geom_smooth() + # Add line
  labs(x = "Assay minute", y = "Moving Occurrences", title = "Line Plot") + # Add labels
  theme_minimal() # Choose a theme

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, 
                             color = study_site, fill=study_site)) +
  geom_smooth() + # Add line
  ggtitle(label="Assay number", vjust=0.5) +
  labs(x="Assay minute", y="moving occ") + # Add labels
  theme_minimal() + # Choose a theme
  facet_wrap(~assay_number)

print(plot)
```

