---
title: "Eastern quoll behaviour and dispersal"
author: "Christina Gee, Belinda Wilson"
date: "14 March 2024"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: true
    theme: cerulean
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'tutorial.html')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE)
```

# * Background

Safe havens (also referred to as sanctuaries) are valuable tools for protecting extant species in decline, and reintroducing species into areas from which they were extirpated (Smith et al. 2020). For those with conservation-fencing, designs which prevent entry (by invasive species) but do not prevent exit (of species living inside) can allow reintroduce species to disperse into the surrounding landscape (Wilson et al. 2020). But does every individual have an equal opportunity to disperse, or is this process driven by genetic and/or phenotypic traits?

We studied whether behavioural, morphological, and demographic traits drove dispersal in a reintroduced mesopredator (eastern quoll *Dasyurus viverrinus*, ‘murunguny’ in the Indigenous Ngunnawal language) which was reintroduced to a conservation-fenced haven in the Australian Capital Territory in 2016 (Wilson et al. 2020, 2021). The unmanaged dispersal of eastern quolls from the reintroduction site to surrounding areas presented a unique research opportunity to compare the individuals constituting the (1) self-regulating core population (henceforth residents), and the (2) recently founded external population (henceforth dispersers).

Investigating these trends can build our understanding of dispersal behaviour (and its stages of emigration, inter-patch movement, and immigration), how it responds to density-dependence, and how these processes can be managed for metapopulation health.

# * Setup

First, we installed the [pacman Package Management Tool](https://cran.r-project.org/web/packages/pacman/index.html), which allows us to install and load subsequent packages in a condensed and efficient way. 

```{r, eval=FALSE}
#install.packages("pacman")
```

# Install packages
```{r, results='hide', warning=FALSE, message=FALSE}
# Install and load required packages
pacman::p_load(basemaps, ggplot2, ggpubr, gtools, janitor, lme4,lmerTest, MuMIn,  
               readr, sf, readxl, rstudioapi, tidyverse, viridis, beepr, corrplot,
               broom, sjPlot, sjmisc, sjlabelled, knitr)

#install.packages("kableExtra")
library(kableExtra)

#install.packages("broom.mixed")
library(broom.mixed)

#install.packages("AICcmodavg")
library(AICcmodavg)

#install.packages("glmmTMB")
library(glmmTMB)

install.packages("scales")
library(scales)

install.packages("freqtables")
library(freqtables)

```

# Data preparation
```{r, eval=FALSE}
# Assign raw data filename to an object
raw_data <- "data.xlsx"

# Read in behavioural assay data
raw <- read_excel(raw_data, sheet="Assays", na="N/A") %>% 
  clean_names() %>%
  select("obs_id"="observation_id", 
         "assay_id", 
         "quoll_code",
         behaviour="behavior", 
         occurrences="total_number_of_occurences")

#Read in the data for all data sheets in excel 
meta <- read_excel(raw_data, sheet="Metadata", na="N/A") %>% 
  clean_names()

quoll <- read_excel(raw_data, sheet="Quoll", na="N/A") %>%
  clean_names()

capture <- read_excel(raw_data, sheet="Captures") %>%
  clean_names()

session <- read_excel(raw_data, sheet="Sessions") %>%
    clean_names()

#Clean up behaviour data from long to wide format 
occ <- pivot_wider(data = raw, 
                   names_from = behaviour, 
                   values_from = occurrences)  %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_o = "section_1", 
         section_2_o = "section_2", 
         section_3_o = "section_3", 
         section_4_o = "section_4", 
         moving_o = "moving", 
         jump_climb_o = "jump_climb", 
         food_o = "food", 
         legs_o = "legs", 
         grooming_o = "grooming", 
         resting_o = "resting", 
         perch_o = "perch")

raw <- read_excel(raw_data, sheet="Assays", , na="N/A") %>% 
  clean_names() %>%
  select("obs_id"="observation_id", 
         "assay_id", 
         quoll_code, 
         behaviour="behavior", 
         duration="total_duration_s")

dur <- pivot_wider(data = raw,
                   names_from = behaviour, 
                   values_from = duration) %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_d = "section_1", 
         section_2_d = "section_2", 
         section_3_d = "section_3", 
         section_4_d = "section_4", 
         moving_d = "moving", 
         jump_climb_d = "jump_climb", 
         food_d = "food", 
         legs_d = "legs", 
         grooming_d = "grooming", 
         resting_d = "resting", 
         perch_d = "perch")

assays <- left_join(occ, dur, by=c("obs_id", "assay_id", "quoll_code"))

#Adding all sections together to create a column with total section visitations
assays$sumsect_o <- rowSums(assays[, c("section_1_o", "section_2_o", "section_3_o", "section_4_o")])

#Adding together all activity occurrences without sections
assays$totalact_o <- rowSums(assays[, c(4:10)])
#view(assays)

# Append metadata for each assay to dataframe
behavdata <- left_join(meta, assays, by=c("assay_id", "quoll_code"))%>%
  filter(!is.na(assay_number))

behavdata <- left_join(behavdata, session, by=c("session"))%>%
  filter(!is.na(assay_number))

quolldata <- left_join(capture, quoll, by=c("quoll_code"))

data <- left_join(behavdata, quolldata, by=c("session", "quoll_code"))
  
data <- data %>%
  select(-min_temp, -session_desc, -capture_date, -new_animal) %>%
  mutate(assay_number = as.factor(assay_number),
         cond_n = as.numeric(ifelse(condition=="Excellent", 4,
                            ifelse(condition=="Good", 3,
                                   ifelse(condition=="Fair", 2, NA)))),
         age_n = as.numeric(ifelse(age_estimate=="<1yr", 0,
                               ifelse(age_estimate=="1-2yrs", 1,
                                      ifelse(age_estimate=="2-3yrs", 2, NA)))))


```

# Calculating time differences 
```{r}

#Change time columns to correct POSIXct format
data$snout <- as.POSIXct(data$snout)
data$process_end <- as.POSIXct(data$process_end)
data$first_light <- as.POSIXct(data$first_light)

#Calculate time differences
data$time_processtoassay <- data$snout - data$process_end
data$time_assaytolight <- data$first_light - data$snout

#Filtering out the two individuals who were assayed in Sept 2023
data <- data %>%
  filter(!(quoll_code %in% c("53328", "87DE0")))


```

# Correlation analysis
```{r}
cor <- data  %>% 
  dplyr::select(age_n, body_weight_kg, cond_n, pes_mean_mm, head_length_mm)

#Running the correlation test
cor <- cor(cor)
view(cor)

#Saving them to a .csv file
write.csv(cor, "data - morphometric correlation matrix.csv")

#Creating and printing correlation matrix .jpgs which colour code the correlations
col_names <- c("Age estimate", "Body weight (kg)", "Condition", "Pes length (mm)", "Head length (mm)")
row_names <- c("Age estimate", "Body weight (kg)", "Condition", "Pes length (mm)", "Head length (mm)")
colnames(cor) <- col_names
rownames(cor) <- row_names

#Correlation of occurrences and duration with sections
jpeg(height=2000, width=2000, file="data corplot.jpeg", type="cairo")
corrplot(cor, method="color", type="upper", #creates a correlation matrix
         cl.cex=3, number.cex=2, tl.cex=3, diag=FALSE,
         tl.col="black", tl.srt=45, addCoef.col="black")
dev.off()
```

#** SINGLE ASSAYS

# Subsetting data to include first assays only 
For morphometric and demographic analysis, and 'static behaviour' analysis
```{r}

data1 <- data %>%
      filter(assay_number !=2)

data1$site01 <- ifelse(data1$study_site == "Goorooyarroo", 1, 0)

write.csv(data1, "data1 - first assay data raw.csv")

```

Ensure that the data frame is in the format needed
```{r}
data1 <- data1 %>%
  mutate(age_n = as.numeric(as.character(age_n)))

data1$condition <- factor(data1$condition, levels = c("Excellent", "Good", "Fair", "Poor"))

data1 <- data1 %>%
  # assign as factor
  mutate(age_estimate = as.factor(age_estimate)) %>%
  # Assign new labels
  mutate(age_estimate = recode(age_estimate, 
                               "1-2yrs" = "1–2 years", 
                               "<1yr" = "<1 year", 
                               "2-3yrs" = "2–3 years"))  %>%
  # reorder new labels
  mutate(age_estimate = factor(age_estimate, 
                               levels = c("2–3 years", "1–2 years", "<1 year")))

```

#Demo/morpho analysis
```{r}

data1$site01 <- factor(data1$site01)
str(data1)

#GLM
mod <- glm(site01 ~ sex + body_weight_kg + age_n + cond_n, data=data1, family=binomial)
summary(mod)


```

#Demo/morpho table with kableExtra
```{r}
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Study site", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```

#Demo/morpho plots
```{r}

show_col(viridis(16))

#Condition plot
cond_plot  <- ggplot(data=data1, aes(x = study_site, fill=condition)) + 
 geom_bar(position="fill") +
  stat_count(aes(label = ..count..), geom = "text", position = position_fill(vjust = 0.5), size = 3.5, 
             color = "white") +
  scale_fill_manual (values = c("#472F7dFF", "#2a788Eff", "#35B770FF","#D2e21bff"), name = "Body condition score") +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,20,5),labels=seq(0,20,5), limits=c(0,20)) +
  xlab("Study site") + ylab("Proportion of eastern quolls") + labs("") 
print(cond_plot)
ggsave(filename = "morpho - cond v study site.jpeg", cond_plot, width=175, height=125, units = "mm")


#Age plot 
age_plot  <- ggplot(data=data1, aes(x = study_site, fill=age_estimate)) +
 geom_bar(position="fill") +
  stat_count(aes(label = ..count..), geom = "text", position = position_fill(vjust = 0.5), size = 4, 
             color = "white") +
  scale_fill_manual (values = c("#472F7dFF", "#2a788Eff", "#35B770FF"), 
                     name = "Age estimate") +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,20,5),labels=seq(0,20,5), limits=c(0,20)) +
  xlab("Study site") + ylab("Proportion of eastern quolls") + labs("") 
print(age_plot)
ggsave(filename = "morpho - age v study site.jpeg", age_plot, width=175, height= 125, units = "mm")


weight_plot <- ggplot(data = data1, aes(x = study_site, y = body_weight_kg, fill = study_site)) +
  geom_boxplot() +
  theme_minimal()
print(weight_plot)

```

#Environmental vars influence GLM analysis
```{r}

foodd <- glm(food_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
foodo <- glm(food_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

groomd <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
groomo <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

jumpd <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
jumpo <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

legsd <- glm(legs_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
legso <- glm(legs_o  ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

moved <- glm(moving_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
moveo <- glm(moving_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

perchd <- glm(perch_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
percho <- glm(perch_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

bait <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
sumsecto <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
totalacto <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
emerge <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

trapstress <- glm(stress_in_trap ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
bagstress <- glm(stress_in_bag ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
tablestress <- glm(stress_on_table ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

```

#Environmental vars tables  with kabelExtra
```{r}

tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```

#Environmental vars plots
```{r}

names(data1)

#Grooming and tempoerature
groomtemp <- ggplot(data=data1, aes(x = temp, y = grooming_o)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab(expression(paste("Ambient temperature (", degree, "C)"))) + 
  ylab(expression(paste("Grooming occurrences ", italic("(n) ")))) + labs("")

print(groomtemp)
#ggsave(filename = "2 assays raw - food v weight.jpeg", groomtemp, width=150, height= 150, units = "mm")


#Grooming and tempoerature
groomtemp <- ggplot(data=data1, aes(x = temp, y = grooming_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab(expression(paste("Ambient temperature (", degree, "C)"))) + 
  ylab("Grooming duration (s)") + labs("")

print(groomtemp)
#ggsave(filename = "2 assays raw - food v weight.jpeg", groomtemp, width=150, height= 150, units = "mm")


#Moving duration and time to first light
plot <- ggplot(data=data1, aes(x = time_assaytolight, y = moving_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Time (mins) from assay to first light") + 
  ylab("Quadrupedal movement duration (s)") + labs("")

print(plot)
#ggsave(filename = "2 assays raw - food v weight.jpeg", groomtemp, width=150, height= 150, units = "mm")

#Moving duration and time to first light
plot <- ggplot(data=data1, aes(x = time_assaytolight, y = legs_o)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Time (mins) from assay to first light") + 
  ylab("Hind leg stand occurrences (n)") + labs("")

print(plot)
#ggsave(filename = "2 assays raw - food v weight.jpeg", groomtemp, width=150, height= 150, units = "mm")


#Perching duration and all vars
plot <- ggplot(data=data1, aes(x = time_assaytolight, y = perch_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Time (mins) from assay to first light") + 
  ylab("Perching duration (s)") + labs("")
print(plot)


plot <- ggplot(data=data1, aes(x = time_processtoassay, y = perch_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Time (mins) from processing to assay") + 
  ylab("Perching duration (s)") + labs("")
print(plot)

plot <- ggplot(data=data1, aes(x = moon_phase, y = perch_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Moon illumination (%)") + 
  ylab("Perching duration (s)") + labs("")
print(plot)


plot <- ggplot(data=data1, aes(x = temp, y = perch_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "right", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(-5,10,5),labels=seq(-5,10,5), limits=c(-5,10)) +
  xlab("Temp") + 
  ylab("Perching duration (s)") + labs("")
print(plot)


```



Analyse behaviour indicators
  1. Test the influence of fixed (e.g., site) and random effects (e.g., arena) on behavioural responses (e.g., food interaction duration) using the `lmer()` function.
  2. If multiple fixed effects produce significance, perform model selection using the dredge() function to determine which fixed effects are within delta 2 AICc.

#Capture behaviour GLMMS
Testing behaviour in GLMMs including environmental variables as competing factors in fixed effects model.

```{r}

mod <- lmer(bait_eaten_g ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(emerge_max ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + (1|arena),
            data=data1, na.action = "na.fail")

mod <- lmer(food_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(food_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(grooming_d ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + (1|arena),
            data=data1, na.action = "na.fail")

mod <- lmer(grooming_o ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(jump_climb_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(jump_climb_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(legs_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(legs_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(moving_d ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(moving_o ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(perch_d ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + moon_phase + 
              time_assaytolight + time_processtoassay + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(perch_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_in_bag ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_in_trap ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_on_table ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(sumsect_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(totalact_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

#Tables with kableExtra

response_var <- all.vars(formula(mod))[1]

tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

```

#Capture behaviour AICc model selection
```{r}

control_ml <- lmerControl(optimizer = "Nelder_Mead")

#Grooming duration 
mod_gd_site <- lmer(grooming_d ~ study_site + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_gd_temp <- lmer(grooming_d ~ temp + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_gd_site, mod_gd_temp)
model.names <- c("Site", "Temp")
aictab(cand.set = models, modnames = model.names)

#Grooming occurrences
mod_go_site <- lmer(grooming_o ~ study_site + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_go_temp <- lmer(grooming_o ~ temp + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_go_site, mod_go_temp)
model.names <- c("Site", "Temp")
aictab(cand.set = models, modnames = model.names)

```

#Capture behaviour plots
```{r}

view(data1)

#Groodata1#Grooming duration v study site plot
groomd_site <- ggplot(data=data1, aes(x = study_site, y = grooming_d, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,110,20),labels=seq(0,110,20), limits=c(0,110)) +
  xlab("") + ylab("Grooming duration (s)") + labs("")  +
  annotate("text", x = "Mulligans Flat", y =110, label = "A", size = 10, hjust = -4)

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('h')"), size = 5, hjust = -5)
print(groomd_site)
ggsave(filename = "1st assay - study site v grooming dur.jpeg", groomd_site, width=150, height= 150, units = "mm")

#Grooming occurrences v study site plot
groomo_site <- ggplot(data=data1, aes(x = study_site, y = grooming_o, 
                        fill = study_site)) + 
  geom_violin() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,8,2),labels=seq(0,8,2), limits=c(0,8)) +
  xlab("") + ylab(expression(paste("Grooming occurrences ", italic(" (n)")))) + labs("") +
  annotate("text", x = "Mulligans Flat", y =8, label = "B", size = 10, hjust = -4)

print(groomo_site)

ggsave(filename = "1st assay - study site v grooming occ.jpeg", groomo_site, width=150, height= 150, units = "mm")


plot <- ggarrange(groomd_site, groomo_site)
plot <- annotate_figure(plot, 
        #left = text_grob("Adjusted behaviours over two assays", rot=90, size = 16, face = "bold"),
        bottom = text_grob("Study site", size = 20))
print(plot)
ggsave(filename = "1st assay groom site plots.jpeg", plot, width=300, height= 150, units = "mm")

data1$age_estimate


custom_order <- c("<1 year", "1–2 years", "2–3 years")
data1$age_estimate <- factor(data1$age_estimate, levels = custom_order)

#Jumping and climbing v age plot 
joage_plot  <- ggplot(data=data1, aes(x = age_estimate, y = jump_climb_o, fill = age_estimate)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288", "#25798F", "#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  xlab("Age estimate") + ylab(expression(paste("Jumping and climbing occurrences ", italic(" (n) ")))) + 
  labs("")
print(joage_plot)

ggsave(filename = "1st assay - age v jumping.jpeg", joage_plot, width=150, height= 150, units = "mm")


```

## ** MULTIPLE ASSAYS
#Subsetting data to animals with repeated assays
```{r}
values_to_exclude <- c("524E3", "53221", "53511", "53512", "53515", "53526", "563A6", "56ABE", "56EB2", "5FC08", "6D409" , "6D53F" , "6E990" , "71A4D" , "71B69" , "86E19" , "86FFC" , "87F61", "BCA09")

data2 <- data %>%
  filter(!quoll_code %in% values_to_exclude)

write.csv(data2, "data2 - individuals with two assays raw data.csv")

```

#Capture and recapture environmental vars GLM analysis
```{r}

bait2 <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

foodd2 <- glm(food_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
foodo2 <- glm(food_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

groomd2 <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
groomo2 <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

jumpd2 <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
jumpo2 <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

legsd2 <- glm(legs_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
legso2 <- glm(legs_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

moved2 <- glm(moving_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
moveo2 <- glm(moving_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

perchd2 <- glm(perch_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
percho2 <- glm(perch_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

emerge2 <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
summary(emerge2)

sumsect2 <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
totalact2 <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

trapstress2 <- glm(stress_in_trap ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
bagstress2 <- glm(stress_in_bag ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
tablestress2 <- glm(stress_on_table ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
summary(tablestress2)

```

#Capture and recapture environmental vars tables with kableExtra
```{r}

tidy_results <- tidy(bait2) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Bait eaten (g)", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```


#Capture and recapture behaviour GLMMs with environmental vars
```{r}

data2 <- data2 %>%
  mutate(age_n = as.numeric(as.character(age_n)))


mod <- lmer(bait_eaten_g ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + (1|arena),
            data=data2, na.action = "na.fail")

summary(mod)

mod <- lmer(emerge_max ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + (1|arena),             data=data2, na.action = "na.fail")

mod <- lmer(food_d ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase +(1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(food_o ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight + time_processtoassay + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(grooming_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena),
            data=data2, na.action = "na.fail")

mod <- lmer(grooming_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(jump_climb_d ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight+ (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(jump_climb_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(legs_d ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight + 
              time_processtoassay + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(legs_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(moving_d ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + 
              time_assaytolight + time_processtoassay + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(moving_o ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + 
              time_assaytolight + time_processtoassay + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(perch_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(perch_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(stress_in_bag ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(stress_in_trap ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(stress_on_table ~ study_site + sex + age_n + cond_n + body_weight_kg + 
              time_assaytolight + time_processtoassay + (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(sumsect_o ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + 
              time_assaytolight +  (1|arena), 
            data=data2, na.action = "na.fail")

mod <- lmer(totalact_o ~ study_site + sex + age_n + cond_n + body_weight_kg + moon_phase + 
              time_processtoassay + (1|arena), 
            data=data2, na.action = "na.fail")

#Tables with kableExtra
response_var <- all.vars(formula(mod))[1]

tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

```

#Capture and recapture behaviour AICc model selection
```{r}

control_ml <- lmerControl(optimizer = "Nelder_Mead")

#Total activity  
mod_tot_site <- lmer(totalact_o ~ study_site + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_tot_moon <- lmer(totalact_o ~ moon_phase + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_tot_site, mod_tot_moon)
model.names <- c("Site", "Moon")
aictab(cand.set = models, modnames = model.names)


```


#Plots for two assays
```{r}

view(data2)

#Total activity
tot_act <- ggplot(data=data2, aes(x = study_site, y = totalact_o, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,550,100),labels=seq(0,550,100), limits=c(0,550)) +
  xlab("Study site") +  ylab(expression(paste("Jumping and climbing occurrences ", italic("(n) ")))) + labs("") 

print(tot_act)

ggsave(filename = "2 assays raw - site v total activity.jpeg", tot_act, width=150, height= 150, units = "mm")


str(data2)
view(data2
     )
#Grooming duration
groomdur <- ggplot(data=data2, aes(x = sex, y = grooming_d, fill = sex)) + 
  geom_boxplot() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
             shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#472F7dFF","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,80,20),labels=seq(0,80,20), limits=c(0,80)) +
  xlab("Sex") + 
  ylab("Grooming duration (s)") + labs("") +
  scale_x_discrete(labels = c("M" = "Male", "F" = "Female"))

print(groomdur)

ggsave(filename = "2 assays raw - sex v grooming.jpeg", groomdur, width=150, height= 150, units = "mm")



#Food interaction duration
foodweight <- ggplot(data=data2, aes(x = body_weight_kg, y = food_d)) + 
 geom_point() +
  geom_smooth(method = "auto", se = TRUE, colour = "#1caa85", fill = "#68C6AE") +
  theme_minimal() +
    theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  #scale_y_continuous(breaks=seq(0,110,20),labels=seq(0,110,20), limits=c(0,110)) +
  xlab("Body weight (kg)") + 
  ylab("Food interaction duration (s)") + labs("")

print(foodweight)

ggsave(filename = "2 assays raw - food v weight.jpeg", foodweight, width=150, height= 150, units = "mm")



```



#Environmental vars data mutated
```{r}

#Mutating the environmental variables 
data2_mutate <- data2 %>%
  mutate_at(vars(5, 44, 65, 66), ~ as.vector(scale(.)))

data2$condition <- factor(data2$condition, levels = c("Excellent", "Good", "Fair", "Poor"))
data2$age_n <- factor(data2$age_n, levels = c("2", "1", "0"))

view(data2_mutate)
write.csv(data2_mutate, "data2_mutate - both assays env vars adjusted.csv")

```

#Adjusted behaviour variables - extracting values
```{r}

mod <- glm(food_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$foodo_p <- predict(mod, type = "response")
             
mod <- glm(food_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$foodd_p <- predict(mod, type = "response")
             
mod <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$groomo_p <- predict(mod, type = "response")

mod <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$groomd_p <- predict(mod, type = "response")
             
mod <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$jumpo_p <- predict(mod, type = "response")

mod <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$jumpd_p <- predict(mod, type = "response")

mod <- glm(legs_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$legsd_p <- predict(mod, type = "response")

mod <- glm(legs_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$legso_p <- predict(mod, type = "response")

mod <- glm(moving_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$moved_p <- predict(mod, type = "response")
             
mod <- glm(moving_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$moveo_p <- predict(mod, type = "response")

mod <- glm(perch_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$perchd_p <- predict(mod, type = "response")
             
mod <- glm(perch_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$percho_p <- predict(mod, type = "response")

mod <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$bait_p <- predict(mod, type = "response")
 
mod <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$sumsecto_p <- predict(mod, type = "response")            
             
mod <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$totalacto_p <- predict(mod, type = "response")
             
mod <- glm(stress_in_trap ~ temp + moon_phase + time_assaytolight + time_processtoassay,
           family=gaussian, data=
             data2_mutate)
             data2_mutate$trapstress_p <- predict(mod, type = "response")

mod <- glm(stress_in_bag ~ temp + moon_phase + time_assaytolight + time_processtoassay,
           family=gaussian, data=
             data2_mutate)
             data2_mutate$bagstress_p <- predict(mod, type = "response")

mod <- glm(stress_on_table ~ temp + moon_phase + time_assaytolight + time_processtoassay,
           family=gaussian, data=
             data2_mutate)
             data2_mutate$tablestress_p <- predict(mod, type = "response")

mod <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + time_processtoassay,
           family=gaussian, data=
             data2_mutate)
             data2_mutate$emerge_p <- predict(mod, type = "response")

```

#Adjusted behaviour variables - create df 
Accounting for environmental heterogeneity for both assays
```{r}

data2_pred <- data2_mutate %>%
  select(-food_o, -food_d, -grooming_o, -grooming_d, 
                     -jump_climb_o, -jump_climb_d, -legs_o, -legs_d, 
                     -moving_o, -moving_d, -perch_d, -perch_o, -resting_o,
                     -resting_d, -bait_eaten_g, 
                     -sumsect_o, -totalact_o, -emerge_max, -time_to_emerge_s, -arena_entry) %>%
mutate(assay_number = as.factor(assay_number))

write.csv(data2_pred,"data2_pred - both assays adjusted env variables.csv")

```

#Adjusted behaviour variables - test vs assay number
```{r}

view(data2)

mod <- glm(foodd_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(foodo_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(bait_p ~ assay_number, family=gaussian, data=data2_pred)
summary(mod)

mod <- glm(groomd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(groomo_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(jumpd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(jumpo_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(legsd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(legso_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(moved_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(moveo_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(emerge_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(perchd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(percho_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(sumsecto_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(totalacto_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(bagstress_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(trapstress_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(tablestress_p ~ assay_number, family=gaussian, data=data2_pred)

#Tables with kableExtra
tidy_results <- tidy(mod)%>%
 mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Adjusted jumping and climbing occurrences (n)", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```

#Adjusted behaviour variables vs assay number plots
```{r}

#Latency to emerge
ed_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = emerge_p, 
                        fill = assay_number)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288","#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,50,10),labels=seq(0,50,10), limits=c(0,50)) +
  xlab("") + 
  ylab(expression(paste("Latency to emerge (s)")))+
  annotate("text", x = "2", y =50, label = "A", size = 10, hjust = -3) + 
  labs("") 
print(ed_plot)
#ggsave(filename = "assay number - emerge - site.jpeg", ed_plot, width=200, height= 150, units = "mm")


#Food interaction occurrences
fo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = foodo_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288","#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
    scale_y_continuous(breaks=seq(0,30,10),labels=seq(0,30,10), limits=c(0,30)) +
  xlab("") + ylab(expression(paste("Food interaction occurrences", italic(" (n) ")))) +
  annotate("text", x = "2", y =30, label = "B", size = 10, hjust = -3) + 
  labs("") 
print(fo_plot)
#ggsave(filename = "assay number - food occ - site.jpeg", fo_plot, width=200, height= 150, units = "mm")


#Legs occurrences
lo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = legso_p, 
                        fill = assay_number)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288","#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,100,20),labels=seq(0,100,20), limits=c(0,100)) +
  xlab("") + ylab(expression(paste("Standing on hind legs occurrences", italic("(n) ")))) +
  annotate("text", x = "2", y =100, label = "C", size = 10, hjust = -3) +
  labs("") 
print(lo_plot)
ggsave(filename = "assay number - legs occ - site.jpeg", lo_plot, width=200, height= 150, units = "mm")


#Perching occurrences
po_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = percho_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288","#1caa85")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,30,10),labels=seq(0,30,10), limits=c(0,30)) +
  xlab("") + ylab(expression(paste("Perching occurrences ", italic(" (n) ")))) + 
  annotate("text", x = "2", y =30, label ="D", size = 10, hjust = -3) +
  labs("") 

print(po_plot)
ggsave(filename = "assay number - perch occ  - site.jpeg", po_plot, width=200, height= 150, units = "mm")


plot <- ggarrange(ed_plot, fo_plot, lo_plot, po_plot, ncol = 2, nrow = 2)
plot <- annotate_figure(plot, 
        #left = text_grob("Adjusted behaviours over two assays", rot=90, size = 16, face = "bold"),
        bottom = text_grob("Assay number", size = 20))

print(plot)
ggsave(filename = "2 assays - behav by assay number.jpeg", plot, width=300, height= 300, units = "mm")



#Jump climb duration
jd_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = jumpd_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288","#1caa85")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,200,50),labels=seq(0,200,50), limits=c(0,200)) +
   xlab("") + ylab(expression(paste("Jumping and climbing duration (s)" )))  +
  annotate("text", x = "2", y =200, label = "A", size = 10, hjust = -3) +
  labs("") 
print(jd_plot)
#ggsave(filename = "assay number - jump dur - site.jpeg", jd_plot, width=200, height= 150, units = "mm")

#Jump climb occurrences
jo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = jumpo_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288","#1caa85")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) +
  scale_y_continuous(breaks=seq(0,80,20),labels=seq(0,80,20), limits=c(0,80)) +
  xlab("") + ylab(expression(paste("Jumping and climbing occurrences ", italic(" (n) ")))) +
  annotate("text", x = "2", y =80, label = "B", size = 10, hjust = -3) + 
  labs("") 

print(jo_plot)
#ggsave(filename = "assay number - jump occ - site.jpeg", jo_plot, width=200, height= 150, units = "mm")

plot <- ggarrange(jd_plot, jo_plot)
plot <- annotate_figure(plot, 
        bottom = text_grob("Assay number", size = 20))

print(plot)
ggsave(filename = "2 assays - jump climb by assay number.jpeg", plot, width=300, height= 150, units = "mm")



#Moving duration
md_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = moved_p, 
                        fill = assay_number)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288","#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,160,50),labels=seq(0,160,50), limits=c(0,160)) +
  xlab("") + ylab(expression(paste("Quadrupedal movement duration (s)" ))) +
  annotate("text", x = "2", y =160, label = "A", size = 10, hjust = -3) + 
  labs("") 
print(md_plot)
#ggsave(filename = "assay number - move dur - site.jpeg", md_plot, width=200, height= 150, units = "mm")

#Moving occurrences
mo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = moveo_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288","#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,150,50),labels=seq(0,150,50), limits=c(0,150)) +
  xlab("") + ylab(expression(paste("Quadrupedal movement occurrences", italic(" (n) ")))) +
  annotate("text", x = "2", y =150, label = "B", size = 10, hjust = -3) + 
  labs("") 
print(mo_plot)
#ggsave(filename = "assay number - move occ - site.jpeg", mo_plot, width=200, height= 150, units = "mm")

plot <- ggarrange(md_plot, mo_plot)
plot <- annotate_figure(plot, 
        bottom = text_grob("Assay number", size = 20))
print(plot)
ggsave(filename = "2 assays - move by assay number.jpeg", plot, width=300, height= 150, units = "mm")


#Sum section visits
sum_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = sumsecto_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288","#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,80,20),labels=seq(0,80,20), limits=c(0,80)) +
  xlab("") + ylab(expression(paste("Total different section visits", italic(" (n) ")))) +
  annotate("text", x = "2", y =80, label = "A", size = 10, hjust = -3) + 
  labs("") 
print(sum_plot)
#ggsave(filename = "assay number - sum sect - site.jpeg", sum_plot, width=200, height= 150, units = "mm")

#Sum total activity 
act_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = totalacto_p, 
                        fill = assay_number)) + 
  geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#3f4288","#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        text = element_text(size=20)) + 
  scale_y_continuous(breaks=seq(0,400,100),labels=seq(0,400,100), limits=c(0,400)) +
  xlab("") + ylab(expression(paste("Total activity occurrences", italic(" (n) ")))) +
  annotate("text", x = "2", y =400, label = "B", size = 10, hjust = -3) + 
  labs("") 
print(act_plot)
#ggsave(filename = "assay number - tot sect - site.jpeg", act_plot, width=200, height= 150, units = "mm")

plot <- ggarrange(sum_plot, act_plot)
plot <- annotate_figure(plot, 
        bottom = text_grob("Assay number", size = 20))
print(plot)
ggsave(filename = "2 assays - activity by assay number.jpeg", plot, width=300, height= 150, units = "mm")



```

Arrange individual plots into one. 
```{r}

behav <- ggarrange(ed_plot, fo_plot, jd_plot, jo_plot, md_plot, mo_plot,
  sum_plot, act_plot, lo_plot, po_plot, ncol = 2, nrow = 5,
  font.label = list(
    size = 6,
    face = "bold",
    color = "black",
    label.x = 0.89,
    label.y = 0.99,
    hjust = -0.1,
    vjust = 1.5  ))

behav <- annotate_figure(behav, 
        left = text_grob("Adjusted behaviours over two assays", rot=90, size = 16, face = "bold"),
        bottom = text_grob("Assay number", size = 16, face = "bold"))

print(behav)
ggsave(filename = "adjusted behaviour plots.jpeg", behav, width=300, height= 500, units = "mm")

```

#** PERSONALITY AND PLASTICITY 
Prep data for coefficient left_join 
```{r}

view(data2_pred)

view(quoll2)
quoll2 <- data2_pred %>%
  select(-assay_date, -initial_repeat_assay, -trap_location, -snout, 
                     -haunches, -trap_session_date, -trap_session_morning, -first_light,
                     -ssr, -process_start, -process_end, -pouch, -teeth_colour, 
                     -teeth_sharpness, -teeth_shine, stress_in_trap, stress_in_bag, stress_on_table)

unique(quoll2$age_estimate)

quoll2 <- quoll2 %>%
  # assign as factor
  mutate(condition = as.factor(condition), 
         age_estimate = as.factor(age_estimate)) %>%
  # Assign new labels
  mutate(age_estimate = recode(age_estimate, 
                               "1-2yrs" = "1–2 years", 
                               "<1yr" = "<1 year", 
                               "2-3yrs" = "2–3 years"))  %>%
  # reorder new labels
   mutate(condition = factor(condition, 
                               levels = c("Excellent", "Good", 
                                          "Fair", "Poor")), 
          age_estimate = factor(age_estimate, 
                               levels = c("2–3 years", 
                                          "1–2 years", "<1 year")))


str(quoll2)

write.csv(quoll2, "quoll2.csv")

```

#Intercept and slope - extracting adjusted values for intercept (personality) and  slope (plasticity) over both assays
```{r}

# Create a list of dependent behavioural variables
dependent <- c("foodd_p","foodo_p","groomd_p","groomo_p",
               "jumpd_p","jumpo_p","legsd_p","legso_p", "moved_p",
               "moveo_p", "perchd_p", "percho_p", "bait_p", "sumsecto_p", "totalacto_p", 
               "trapstress_p", "bagstress_p", "tablestress_p", "emerge_p")

# Define the levels in an object
quolls <- levels(factor(quoll2$quoll_code))

# Create a blank dataframe with four columns
coefficients <- data.frame(quoll_code=NULL, intercept=NULL, 
                           slope=NULL, variable=NULL)

# Loop to extract the intercept and slope of each behavioural response
for(v in 1:NROW(dependent)) {
  for(i in 1:NROW(quolls)){
    quoll_code <- quolls[i]
    variable <- dependent[v]
    mod <- lm(eval(as.name(paste0(variable))) ~ 
                assay_number + temp + moon_phase + time_assaytolight + time_processtoassay, 
              data=subset(quoll2, quoll_code==quolls[i]))
    i <- coef(mod)[1]
    s <- coef(mod)[2]
    results <- data.frame(cbind(quoll_code, i, s, variable))
    coefficients <- rbind(coefficients, results)
  }
}

# Convert the df to wide format
coefficients <- reshape(coefficients, idvar="quoll_code", 
                        timevar="variable", direction="wide")

# Define names of the coefficients
names(coefficients) <- gsub("\\.", "_", names(coefficients))

# Remove duplicated coefficients
coefficients <- coefficients[ , !duplicated(colnames(coefficients))]

# Check structure of coefficients
str(coefficients)

#If they are being read as characters, change to numeric 
cols_to_convert <- setdiff(names(coefficients), "quoll_code")
coefficients[cols_to_convert] <- lapply(coefficients[cols_to_convert], as.numeric)

# Join behavioural df with post-release df
ppdata <- left_join(quoll2, coefficients, by="quoll_code", "session") %>%
  distinct(quoll_code, .keep_all = TRUE)

# Remove duplicated column names
ppdata <- ppdata[ , !duplicated(colnames(ppdata))]

# Write to csv file
write_csv(ppdata, "ppdata - intercept and slope data.csv")
view(ppdata)

```

# Analyse behaviour indicators for personality and plasticity 

  1. Test the influence of fixed (e.g., site) and random effects (e.g., arena) on behavioural responses (e.g., food interaction duration) using the `lmer()` function.
  2. If multiple fixed effects produce significance, perform model selection using the dredge() function to determine which fixed effects are within delta 2 AICc.

#Intercept GLMMs - testing behaviour intercept (personality) against independent variables
```{r}

view(ppdata)

mod <- lmer(i_bait_p ~ sex*body_weight_kg + study_site + cond_n + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_emerge_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_foodd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_foodo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_groomd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_groomo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_jumpd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_jumpo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_legsd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_legso_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_moved_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_moveo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_perchd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_percho_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_sumsecto_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_totalacto_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_trapstress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_bagstress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_tablestress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

```

#Intercept tables
```{r}
response_var <- all.vars(formula(mod))[1]
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

```

#Intercept AICc model selection
```{r}

#Perching duration TO DO****
mod_pdi_site <- lmer(i_perchd_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_pdi_weight <- lmer(i_perchd_p ~ sex*body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_pdi_site, mod_pdi_weight)
model.names <- c("Study site", "Interaction of Sex and body weight kg")
aictab(cand.set = models, modnames = model.names)

```

#Intercept plots
```{r}

#Latency to emerge
i_e_site <- ggplot(data=ppdata, aes(x = study_site, y = i_emerge_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted latency to emerge (s) intercept") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(i_e_site)

ggsave(filename = "intercept - study site v latency to emerge.jpeg", i_e_site, width=200, height= 150, units = "mm")


#Bait eaten
i_b_site <- ggplot(data=ppdata, aes(x = study_site, y = i_bait_p, fill=study_site)) + 
geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted bait eaten (g) intercept") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('b')"), size = 5, hjust = -5)

print(i_b_site)

ggsave(filename = "intercept - study site v bait.jpeg", i_b_site, width=200, height= 150, units = "mm")


#Groom duration
i_gd_site <- ggplot(data=ppdata, aes(x = study_site, y = i_groomd_p, fill=study_site)) + geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted grooming duration (s) intercept") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('c')"), size = 5, hjust = -5)

print(i_gd_site)
ggsave(filename = "intercept - study site v grooming dur.jpeg", i_gd_site, width=200, height= 150, units = "mm")


#Groom occurrences
i_go_site <- ggplot(data=ppdata, aes(x = study_site, y = i_groomo_p, fill=study_site)) + geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
   ylab("Adjusted grooming occurrences (n) intercept") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('d')"), size = 5, hjust = -5)

print(i_go_site)

ggsave(filename = "intercept - study site v grooming occ.jpeg", i_go_site, width=200, height= 150, units = "mm")


#Move duration
i_md_site <- ggplot(data=ppdata, aes(x = study_site, y = i_moved_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted quadrupedal movement duration (s) intercept") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('e')"), size = 5, hjust = -5)
print(i_md_site)

ggsave(filename = "intercept - study site v move dur.jpeg", i_md_site, width=200, height= 150, units = "mm")



#Jump/climb duration
i_jd_site <- ggplot(data=ppdata, aes(x = study_site, y = i_jumpd_p, fill=study_site)) + 
geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted jumping and climbing duration (s) intercept") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('f')"), size = 5, hjust = -5)

print(i_jd_site)

ggsave(filename = "intercept - study site v jumpclimb dur.jpeg", i_jd_site, width=200, height= 150, units = "mm")


#Jump/climb occurrences
i_jo_site <- ggplot(data=ppdata, aes(x = study_site, y = i_jumpo_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted jumping and climbing occurrences (n) intercept") + labs("") 
  #annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('g')"), size = 5, hjust = -5)

print(i_jo_site)

ggsave(filename = "intercept - study site v jumpclimb occ.jpeg", i_jo_site, width=200, height= 150, units = "mm")


#Perch duration
i_pd_site <- ggplot(data=ppdata, aes(x = study_site, y = i_perchd_p, fill=study_site)) + geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted perching duration (s) intercept") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('h')"), size = 5, hjust = -5)

print(i_pd_site)
ggsave(filename = "intercept - study site v perch dur.jpeg", i_pd_site, width=200, height= 150, units = "mm")


#Perch occurrences
i_po_site <- ggplot(data=ppdata, aes(x = study_site, y = i_percho_p, fill=study_site)) + geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted perching occurrences (n) intercept") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('i')"), size = 5, hjust = -5)

print(i_po_site)
ggsave(filename = "intercept - study site v perch occ.jpeg", i_po_site, width=200, height= 150, units = "mm")



#Hind legs duration
i_ld_site <- ggplot(data=ppdata, aes(x = study_site, y = i_legsd_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted standing on hind legs duration (s) intercept") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('j')"), size = 5, hjust = -5)

print(i_ld_site)
ggsave(filename = "intercept - study site v legs dur.jpeg", i_ld_site, width=200, height= 150, units = "mm")

#Bag stress
i_bs_site <- ggplot(data=ppdata, aes(x = study_site, y = i_bagstress_p, fill=study_site)) + 
geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("") + 
  ylab("Adjusted bag stress rating intercept") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(i_bs_site)
ggsave(filename = "intercept - study site v bag stress.jpeg", i_bs_site, width=200, height= 150, units = "mm")

#Table stress
i_ts_site <- ggplot(data=ppdata, aes(x = study_site, y = i_tablestress_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("") + 
  ylab("Adjusted table stress rating intercept") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('b')"), size = 5, hjust = -5)

print(i_ts_site)
ggsave(filename = "intercept - study site v table stress.jpeg", i_ts_site, width=200, height= 150, units = "mm")



#Sum of section visits
i_sumsect_site <- ggplot(data=ppdata, aes(x = study_site, y = i_sumsecto_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("") + 
  ylab("Adjusted sum of section visits (n) intercept") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('b')"), size = 5, hjust = -5)

print(i_sumsect_site)
ggsave(filename = "intercept - study site v sum sections.jpeg", i_sumsect_site, width=200, height= 150, units = "mm")


#Total activity occurrences
i_act_site <- ggplot(data=ppdata, aes(x = study_site, y = i_totalacto_p, fill=study_site)) + 
 geom_violin() +
 geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("") + 
  ylab("Adjusted total activity occurrences (n) intercept") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('b')"), size = 5, hjust = -5)

print(i_act_site)
ggsave(filename = "intercept - study site v total activity.jpeg", i_act_site, width=200, height= 150, units = "mm")

```

Arrange intercept plots into one. 
```{r}

intercept_plot <- ggarrange(i_md_site, i_gd_site, i_go_site, i_b_site, i_jd_site, i_jo_site, i_e_site, i_pd_site, i_po_site, i_ld_site, i_lo_site, ncol = 3, nrow = 4,
  font.label = list(
    size = 6,
    face = "bold",
    color = "black",
    label.x = 0.89,
    label.y = 0.99,
    hjust = -0.1,
    vjust = 1.5  ))

intercept_plot <- annotate_figure(intercept_plot, 
        left = text_grob("Adjusted behaviour intercepts a.k.a personality", rot=90, size = 16, face = "bold"),
        bottom = text_grob("Study site", size = 16, face = "bold"))

print(intercept_plot)
ggsave(filename = "intercept - study site v adjusted behaviour plots.jpeg", intercept_plot, width=600, height= 800, units = "mm")
```

#Slope GLMMs - testing behaviour slope (plasticity) against independent variables
```{r}

mod <- lmer(s_bait_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_emerge_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_foodd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_foodo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_groomd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_groomo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_jumpd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_jumpo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_legsd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_legso_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_moved_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_moveo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_perchd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_percho_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_sumsecto_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_totalacto_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_bagstress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_trapstress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_tablestress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")
```

#Tables with kableExtra
```{r}
response_var <- all.vars(formula(mod))[1]
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = response_var, escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

```

#Slope AICc model selection
```{r}

#Perching duration TO DO****
mod_mds_site <- lmer(s_moved_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_mds_weight <- lmer(s_moved_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_mds_site, mod_mds_weight)
model.names <- c("Study site", "Body weight kg")
aictab(cand.set = models, modnames = model.names)

```



#Slope plots
```{r}

view(ppdata)
names(ppdata)

#Latency to emerge v site
s_e_site <- ggplot(data=ppdata, aes(x = study_site, y = s_emerge_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted latency to emerge (s) slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

#print(s_e_site)

ggsave(filename = "slope - study site v latency to emerge.jpeg", s_e_site, width=150, height= 150, units = "mm")



#Food interaction duration v site
s_fd_site <- ggplot(data=ppdata, aes(x = study_site, y = s_foodd_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted food interaction duration (s) slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_fd_site)

ggsave(filename = "slope - study site v food dur.jpeg", s_fd_site, width=150, height= 150, units = "mm")


#Food interaction occurrences v weight
s_fo_weight <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_foodo_p)) + 
 geom_smooth() +
  #geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
 # stat_summary(fun="median", geom="point", col="grey40", fill="white", 
  #             shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Body weight (kg)") + 
  ylab("Adjusted food interaction occurrences (n) slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_fo_weight)

ggsave(filename = "slope - weight v food occ.jpeg", s_fo_weight, width=150, height= 150, units = "mm")


#Legs occurrences v weight
s_lo_weight <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_legso_p, )) + 
 geom_smooth() +
  #geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  #stat_summary(fun="median", geom="point", col="grey40", fill="white", 
  #             shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Body weight (kg)") + 
  ylab("Adjusted hind leg stands occurrences (n) slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_lo_weight)

ggsave(filename = "slope - weight v legs occ.jpeg", s_lo_weight, width=150, height= 150, units = "mm")


#Movement duration
s_md_site <- ggplot(data=ppdata, aes(x = study_site, y = s_moved_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted quadrupedal movement duration (s) slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_md_site)

ggsave(filename = "slope - study site v movement dur.jpeg", s_md_site, width=150, height= 150, units = "mm")



#Jump + climb duration
s_jd_site <- ggplot(data=ppdata, aes(x = study_site, y = s_jumpd_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted jumping and climbing duration (s) slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_jd_site)

ggsave(filename = "slope - study site v jump dur.jpeg", s_jd_site, width=150, height= 150, units = "mm")


#Jump + climb occurrences
s_jo_site <- ggplot(data=ppdata, aes(x = study_site, y = s_jumpo_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted jumping and climbing occurrences (n) slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_jo_site)

ggsave(filename = "slope - study site v jump occ.jpeg", s_jo_site, width=150, height= 150, units = "mm")


#Perching duration
s_pd_site <- ggplot(data=ppdata, aes(x = study_site, y = s_perchd_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted perching duration (s) slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_pd_site)

ggsave(filename = "slope - study site v perch dur.jpeg", s_pd_site, width=150, height= 150, units = "mm")


#Perching occurrences
s_po_site <- ggplot(data=ppdata, aes(x = study_site, y = s_percho_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted perching occurrences (n) slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_po_site)

ggsave(filename = "slope - study site v perch occ.jpeg", s_po_site, width=150, height= 150, units = "mm")


#Bag stress rating
s_bs_site <- ggplot(data=ppdata, aes(x = study_site, y = s_bagstress_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted bag stress rating slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_bs_site)

ggsave(filename = "slope - study site v bag stress.jpeg", s_bs_site, width=150, height= 150, units = "mm")


#Table stress rating
s_ts_site <- ggplot(data=ppdata, aes(x = study_site, y = s_tablestress_p, fill=study_site)) + 
 geom_violin() +
  geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  stat_summary(fun="median", geom="point", col="grey40", fill="white", 
               shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab(" ") + 
  ylab("Adjusted table stress rating slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_ts_site)

ggsave(filename = "slope - study site v table stress.jpeg", s_ts_site, width=150, height= 150, units = "mm")



#Move occ v weight 
s_mo_weight <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_moveo_p)) + 
 geom_smooth() +
  #geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  #stat_summary(fun="median", geom="point", col="grey40", fill="white", 
  #             shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Body weight (kg) ") + 
  ylab("Adjusted quadrupedal movement occurrences slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_mo_weight)

ggsave(filename = "slope - weight  v moving occ.jpeg", s_mo_weight, width=150, height= 150, units = "mm")



#Total activity v weight 
s_toto_weight <- ggplot(data=ppdata, aes(x = body_weight_kg, y = s_totalacto_p)) + 
 geom_smooth() +
  #geom_boxplot(col="grey40", fill="grey40", width=0.02, lwd=0.5) +
  #stat_summary(fun="median", geom="point", col="grey40", fill="white", 
  #             shape=21, size=1.5, stroke=1) +
  scale_fill_manual (values = c("#420053","#3f4288")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Body weight (kg) ") + 
  ylab("Adjusted total activity occurrences (n) slope") + labs("") 

#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('a')"), size = 5, hjust = -5)

print(s_toto_weight)

ggsave(filename = "slope - weight  v total activity occr.jpeg", s_toto_weight, width=150, height= 150, units = "mm") 


```

Arrange slope plots into one. 

```{r}

slope_plot <- ggarrange(i_md_site, i_gd_site, i_go_site, i_b_site, i_jd_site, i_jo_site, i_e_site, i_pd_site, i_po_site, i_ld_site, i_lo_site, ncol = 3, nrow = 4,
  font.label = list(
    size = 6,
    face = "bold",
    color = "black",
    label.x = 0.89,
    label.y = 0.99,
    hjust = -0.1,
    vjust = 1.5  ))


slope_plot <- annotate_figure(slope_plot, 
        left = text_grob("Adjusted behaviour intercepts a.k.a personality", rot=90, size = 16, face = "bold"),
        bottom = text_grob("Study site", size = 16, face = "bold"))

print(slope_plot)
ggsave(filename = "intercept - study site v adjusted behaviour plots.jpeg", slope_plot, width=800, height= 600, units = "mm")
```



#Activity over time - prepping data
```{r}

bin <- read_excel(raw_data, sheet="Binned assays", na="N/A")%>%
 clean_names() 
 view(bin)

 # Append metadata for each assay to dataframe
bin_data <- left_join(meta, bin, by=c("assay_id", "quoll_code"), relationship = "many-to-many")
#view(data)
 
bin_data <- left_join(meta, bin, by=c("session", "assay_id", "quoll_code"), relationship = "many-to-many")%>%
 filter(!assay_id %in% c("MulligansA_4", "MulligansA_9", "MulligansB_19")) %>%
  select(-initial_repeat_assay, -trap_location, -time_to_emerge_s, -remaining_bait_g, -bait_eaten_g)

bin_data <- bin_data %>%
  mutate(minute_integer = as.integer(gsub("\\D", "", minute)))

names(bin_data)
view(bin_data)
 
```


```{r}

bin_data$assay_number <- factor(bin_data$assay_number)

plot <- ggplot(data = bin_data, 
       mapping = aes(x = minute_integer, y = moving_occ_binned))

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, color = study_site)) +
  geom_smooth() + # Add line
  labs(x = "Assay minute", y = "Moving Occurrences", title = "Line Plot") + # Add labels
  theme_minimal() # Choose a theme

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, color = assay_number)) +
  geom_smooth() + # Add line
  labs(x = "Assay minute", y = "Moving Occurrences", title = "Line Plot") + # Add labels
  theme_minimal() # Choose a theme

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, 
                             color = study_site, fill=study_site)) +
  geom_smooth() + # Add line
  ggtitle(label="Assay number", vjust=0.5) +
  labs(x="Assay minute", y="moving occ") + # Add labels
  theme_minimal() + # Choose a theme
  facet_wrap(~assay_number)

print(plot)
```




# **Session information**

```{r}
# Display version information for R, OS, and packages
sessionInfo()
```


#Plasticity slope plot
```{r}

d2pred <- data2_pred %>%
  mutate(assay_number = as.numeric(assay_number))

#Jumping duration v study site
plot <- ggplot(data=d2pred, aes(x=assay_number, y=jumpd_p, fill=study_site
                                    )) + 
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) +
  xlab("Assay number") + ylab("Jumping + climbing duration (s) adjusted") + labs("") +
    scale_x_continuous(breaks = c(min(d2pred$assay_number), max(d2pred$assay_number)))

print(plot)

```



## Map

```{r, warning=FALSE}
# Read in and project MFWS fence shapefile using rgdal
mfws <- readOGR(dsn="shapefiles/MFGO_fences_and surrounds.shp", verbose=FALSE) %>% 
  spTransform(CRS("+proj=utm +zone=55 +ellps=WGS84")) %>%
  # Transform shapefile into a dataframe
  fortify(verbose=FALSE) %>%
  mutate(lat=as.numeric(lat + 10000000), 
         long=as.numeric(long))

# Read in and project MFGO fence shapefile using rgdal
mfgo <- st_read("shapefiles/MFGO_fences.shp", quiet=TRUE) %>%
  # Set projection to eastings/northings
  st_set_crs("EPSG:32755") %>% 
  # Reproject to lat/long
  st_transform("EPSG:4326")

# Plot den locations on MFWS map for each trial
map <- ggplot() + 
  geom_polygon(mfws, mapping=aes(x=long, y=lat, group=group), col="grey15") +
  #coord_sf(xlim=c(695750, 699250), ylim=c(6104250, 6107750)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_rect(fill="white"),
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.key = element_blank(), 
        strip.background = element_blank()) +
  #facet_wrap(~factor(year_of_acquisition), ncol=3) +
  #scale_colour_manual(values = viridis(3, begin=0.9, end=0.1)) +
  xlab("") + ylab("") + labs(col="Trial")
print(map)
```

```{r}
jpeg(file="mfgo_fences_and_surrounds.jpeg", 
     width=4750, height=1500, units="px", res=500)
map
dev.off()
```

