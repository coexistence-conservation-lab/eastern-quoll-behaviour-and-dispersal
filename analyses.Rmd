---
title: "Eastern quoll behaviour and dispersal"
author: "Christina Gee, Belinda Wilson"
date: "14 March 2024"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: true
    theme: cerulean
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'tutorial.html')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE)
```

# * Background

Personality can play a crucial role in the survival and dispersal of reintroduced animals. In 2017, we reintroduced a cohort of female-only eastern quolls (*Dasyurus viverrinus*) to a [conservation-fenced haven](https://www.mulligansflat.org.au/) in the Australian Capital Territory, and conducted behavioural assays on each animal prior to their release. We aimed to determine whether personality and plasticity of these animals could predict their post-release performance.

Here we describe the analyses we conducted for our article [Wilson *et al.* (2022) Personality and plasticity predicts post-release performance in a reintroduced mesopredator](https://doi.org/10.1016/j.anbehav.2022.02.019), published in Animal Behaviour.

# * Setup

First, we installed the [pacman Package Management Tool](https://cran.r-project.org/web/packages/pacman/index.html), which allows us to install and load subsequent packages in a condensed and efficient way. 

```{r, eval=FALSE}
#install.packages("pacman")
```

# Install packages
```{r, results='hide', warning=FALSE, message=FALSE}
# Install and load required packages
pacman::p_load(basemaps, ggplot2, ggpubr, gtools, janitor, lme4,lmerTest, MuMIn,  
               readr, sf, readxl, rstudioapi, tidyverse, viridis, beepr, corrplot,
               broom, sjPlot, sjmisc, sjlabelled, knitr)

install.packages("kableExtra")
library(kableExtra)

install.packages("broom.mixed")
library(broom.mixed)

install.packages("sjPlot")
library(sjPlot)

install.packages("nnet")
library(nnet)

install.packages("AICcmodavg")
library(AICcmodavg)

```

# Data preparation
```{r, eval=FALSE}
# Assign raw data filename to an object
raw_data <- "data.xlsx"

# Read in behavioural assay data
raw <- read_excel(raw_data, sheet="Assays", na="N/A") %>% 
  clean_names() %>%
  select("obs_id"="observation_id", 
         "assay_id", 
         "quoll_code",
         behaviour="behavior", 
         occurrences="total_number_of_occurences")

#Read in the data for all data sheets in excel 
meta <- read_excel(raw_data, sheet="Metadata", na="N/A") %>% 
  clean_names()
#view(meta)
#names(meta)

quoll <- read_excel(raw_data, sheet="Quoll", na="N/A") %>%
  clean_names()
#view(quoll)
#names(quoll)

capture <- read_excel(raw_data, sheet="Captures") %>%
  clean_names()
#view(capture)
#names(capture)

session <- read_excel(raw_data, sheet="Sessions") %>%
    clean_names()
#view(session)
#names(session)

#bin <- read_excel(raw_data, sheet="Binned assays", na="N/A")%>%
 # clean_names()
#view(bin)

#sites <- read_excel(raw_data, sheet="Sites") %>%
  #clean_names()
#view(sites)

#trap_eff <- read_excel(raw_data, sheet="Trap effectiveness") %>%
 #clean_names()
#view(trap_eff)


#Clean up behaviour data from long to wide format 
occ <- pivot_wider(data = raw, 
                   names_from = behaviour, 
                   values_from = occurrences)  %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_o = "section_1", 
         section_2_o = "section_2", 
         section_3_o = "section_3", 
         section_4_o = "section_4", 
         moving_o = "moving", 
         jump_climb_o = "jump_climb", 
         food_o = "food", 
         legs_o = "legs", 
         grooming_o = "grooming", 
         resting_o = "resting", 
         perch_o = "perch")
#view(occ)


raw <- read_excel(raw_data, sheet="Assays", , na="N/A") %>% 
  clean_names() %>%
  select("obs_id"="observation_id", 
         "assay_id", 
         quoll_code, 
         behaviour="behavior", 
         duration="total_duration_s")

dur <- pivot_wider(data = raw,
                   names_from = behaviour, 
                   values_from = duration) %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_d = "section_1", 
         section_2_d = "section_2", 
         section_3_d = "section_3", 
         section_4_d = "section_4", 
         moving_d = "moving", 
         jump_climb_d = "jump_climb", 
         food_d = "food", 
         legs_d = "legs", 
         grooming_d = "grooming", 
         resting_d = "resting", 
         perch_d = "perch")
#view(dur)

assays <- left_join(occ, dur, by=c("obs_id", "assay_id", "quoll_code"))
#view(assays)

#Adding all sections together to create a column with total section visitations
assays$sumsect_o <- rowSums(assays[, c("section_1_o", "section_2_o", "section_3_o", "section_4_o")])

#Finding out the locations of the relevant columns 
#colfoodo <- which(colnames(assays) == "food_o")
#print(colfoodo) #4
#restingo <- which(colnames(assays) == "resting_o")
#print(restingo) #10

#Adding together all activity occurrences without sections
assays$totalact_o <- rowSums(assays[, c(4:10)])
#view(assays)

# Append metadata for each assay to dataframe
behavdata <- left_join(meta, assays, by=c("assay_id", "quoll_code"))%>%
  filter(!is.na(assay_number))

behavdata <- left_join(behavdata, session, by=c("session"))%>%
  filter(!is.na(assay_number))

#view(behavdata)
#names(behavdata)

quolldata <- left_join(capture, quoll, by=c("quoll_code"))
#view(quolldata)
#names(quolldata)

data <- left_join(behavdata, quolldata, by=c("session", "quoll_code"))
data$assay_number <- factor(data$assay_number)

view(data)
#names(data)

```

# Calculating time differences 
```{r}

#Check if the time columns are in the correct format
#print(class(data$snout))

#If not, correct to POSIXct format
data$snout <- as.POSIXct(data$snout)
data$process_end <- as.POSIXct(data$process_end)
data$first_light <- as.POSIXct(data$first_light)


#Calculate time differences
data$time_processtoassay <- data$snout - data$process_end
data$time_assaytolight <- data$first_light - data$snout

#names(data)
#view(data)

#Filtering out the two individuals who were assayed in Sept 2023
data <- data %>%
  filter(!(quoll_code %in% c("53328", "87DE0")))

```

# ** SINGLE ASSAYS

# Subsetting data to include first assays only 
For 'personality' / 'tendency' analysis
```{r}

#view(data)

data1 <- data %>%
    filter(assay_number !=2)
view(data1)

write.csv(data1, "first assay data raw.csv")

```

# Testing influence of environmental variables on arena behaviour
```{r}


foodd <- glm(food_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
foodo <- glm(food_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

groomd <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
groomo <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

jumpd <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
jumpo <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

legsd <- glm(legs_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
legso <- glm(legs_o  ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

moved <- glm(moving_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
moveo <- glm(moving_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

perchd <- glm(perch_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
percho <- glm(perch_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

bait <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
sumsecto <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
totalacto <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
emerge <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

trapstress <- glm(stress_in_trap ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
bagstress <- glm(stress_in_bag ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
tablestress <- glm(stress_on_table ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

```

# Tables: Evironmental stats
```{r}

tidy_results <- tidy(tablestress) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Table stress rating)", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

#colnames(tidy_results) <- c("Term", "Estimate", "Std. Error", "T-Value", "p.value")

#tidy_results <- tidy_results %>%
  #mutate(Term = case_when(
    #Term == "(Intercept)" ~ "Intercept", 
    #Term == "temp" ~ "Temperature",
    #Term == "moon_phase" ~ "Moon phase",
    #Term == "time_assaytolight" ~ "Time from assay to first light",
    #Term == "time_processtoassay" ~ "Time from processing to assay"))

```

# Analyse behaviour indicators

  1. Test the influence of fixed (e.g., site) and random effects (e.g., arena) on behavioural responses (e.g., food interaction duration) using the `lmer()` function.
  2. If multiple fixed effects produce significance, perform model selection using the dredge() function to determine which fixed effects are within delta 2 AICc.

# Testing behaviour in GLMMs including environmental variables as competing factors in fixed effects model.
```{r}

mod <- lmer(bait_eaten_g ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(emerge_max ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + temp + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(food_d ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(food_o ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")
 
mod <- lmer(grooming_d ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + temp + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(grooming_o ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + temp + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(jump_climb_d ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(jump_climb_o ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(legs_d ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(legs_o ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(moving_d ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + time_assaytolight
            + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(moving_o ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + time_assaytolight
            + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(perch_d ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + temp + moon_phase
            + time_assaytolight + time_processtoassay
            + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(perch_o ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_in_bag ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_in_trap ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_on_table ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(sumsect_o ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(totalact_o ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + pes_mean_mm + head_length_mm + (1|arena), 
            data=data1, na.action = "na.fail")

```

#Tables: Summaries of GLMMs using kableExtra
```{r}

tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Table stress rating", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

table <- tidy_results %>%
    mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

view(data1)
names(data1)
```

#AICc model selection test (ðŸš© this goes at the end of your independent variable modelling).
```{r}

names(data1)

mod_g_site <- lmer(grooming_o ~ study_site + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_g_temp <- lmer(grooming_o ~ temp + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")

mod_e_site <- lmer(emerge_max ~ study_site + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_e_temp <- lmer(emerge_max ~ temp + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_e_head <- lmer(emerge_max ~ head_length_mm + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")

mod_j_cond <- lmer(jump_climb_d ~ condition + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_j_morph <- lmer(jump_climb_d ~ morph + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")

mod_p_moon <- lmer(perch_d ~ moon_phase + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_p_temp <- lmer(perch_d ~ temp + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")

# Conduct model selection using AICc threshold
dredge(mod1, rank = "AICc")

models <- list(mod_p_moon, mod_p_temp)
model.names <- c("Perching moon phase", "Perching temperature")
aictab(cand.set = models, modnames = model.names)

```

#Plots: Significant results for first assays
```{r}

view(data1)

#Belinda's  Preliminary plot
#ggplot(data=data1_pred, aes(x=study_site, y=bait_pred, fill=study_site)) +geom_boxplot()

#groomd_plot <- ggplot(data=data1, aes(x = temp, y = grooming_d)) + 
 # geom_smooth() +
  #scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  #theme_minimal() +
  #theme(legend.position = "none", 
        #panel.grid = element_blank(),
        #axis.line.x = element_line(color = "black"),
        #axis.line.y = element_line(color = "black")) + 
 # scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  #xlab("Temperature") + ylab("Grooming duration (s)") + labs("")
    #annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('h')"), size = 5, hjust = -5)
#print(groomd_plot)
#ggsave(filename = "study site - food dur.jpeg", foodd_plot, width=200, height= 150, units = "mm")

#Plot with formatting
#Grooming 

ggplot(data1, aes(x = temp)) +
  geom_smooth(aes(y = grooming_o), method = "auto", color = "blue") +
  geom_smooth(aes(y = grooming_d), method = "auto", color = "red") +
  labs(x = "Temperature", y = "Grooming") +
  scale_color_manual(name = "Variable",
                     values = c("grooming_o" = "blue", "grooming_d" = "red")) +
  theme_minimal()

groomd_plot <- ggplot(data=data1, aes(x = temp, y = grooming_d)) + 
  geom_smooth() +
  #scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
 # scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Temperature") + ylab("Grooming duration (s)") + labs("")
    #annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('h')"), size = 5, hjust = -5)
  print(groomd_plot)
#ggsave(filename = "study site - food dur.jpeg", foodd_plot, width=200, height= 150, units = "mm")

groomo_plot <- ggplot(data=data1, aes(x = study_site, y = grooming_o, 
                        fill = study_site)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(0,8,2),labels=seq(0,8,2), limits=c(0,8)) +
  xlab("Study site") + ylab(expression(paste("Grooming occurrences ", italic(" (n)")))) + labs("")
  #annotate("text", x = "Mulligans Flat", y = 160, label = parse(text = "bold('b')"), size = 5, hjust = -5)
  
print(groomo_plot)
#ggsave(filename = "study site - move occ.jpeg", moveo_plot, width=200, height= 150, units = "mm")



#Latency to emerge

emerge_plot <- ggplot(data=data1, aes(x = study_site, y = emerge_max, 
                        fill = study_site)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,8,2),labels=seq(0,8,2), limits=c(0,8)) +
  xlab("Study site") + ylab(expression(paste("Latency to emerge ", italic(" (s)")))) + labs("")
  #annotate("text", x = "Mulligans Flat", y = 160, label = parse(text = "bold('b')"), size = 5, hjust = -5)
  
print(emerge_plot)
#ggsave(filename = "study site - move occ.jpeg", moveo_plot, width=200, height= 150, units = "mm")


emerge_temp_plot <- ggplot(data=data1, aes(x = emerge_max, y = temp)) + 
  geom_smooth() +
  #scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
 # scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Latency to emerge") + ylab("Temperature") + labs("")
    #annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('h')"), size = 5, hjust = -5)
  print(emerge_temp_plot)
#ggsave(filename = "study site - food dur.jpeg", foodd_plot, width=200, height= 150, units = "mm")


emerge_head_plot <- ggplot(data=data1, aes(x = emerge_max, y = head_length_mm)) + 
  geom_smooth() +
  #scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
 # scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Latency to emerge") + ylab("Head length mm") + labs("")
    #annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('h')"), size = 5, hjust = -5)
  print(emerge_head_plot)
#ggsave(filename = "study site - food dur.jpeg", foodd_plot, width=200, height= 150, units = "mm")
  

#Jumping and climbing duration 
  
jump_cond_plot <- ggplot(data=data1, aes(x = condition, y = jump_climb_d, 
                        fill = condition)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151", "#420053")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,8,2),labels=seq(0,8,2), limits=c(0,8)) +
  xlab("Condition") + ylab(expression(paste("Jumping and climbing duration ", italic(" (s)")))) + labs("")
  #annotate("text", x = "Mulligans Flat", y = 160, label = parse(text = "bold('b')"), size = 5, hjust = -5)
  
print(jump_cond_plot)
#ggsave(filename = "study site - move occ.jpeg", moveo_plot, width=200, height= 150, units = "mm")
  

jump_morph_plot <- ggplot(data=data1, aes(x = morph, y = jump_climb_d, 
                        fill = morph)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#7BD151", "#420053")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,8,2),labels=seq(0,8,2), limits=c(0,8)) +
  xlab("Morph") + ylab(expression(paste("Jumping and climbing duration ", italic(" (s)")))) + labs("")
  #annotate("text", x = "Mulligans Flat", y = 160, label = parse(text = "bold('b')"), size = 5, hjust = -5)
  
print(jump_morph_plot)
#ggsave(filename = "study site - move occ.jpeg", moveo_plot, width=200, height= 150, units = "mm")
  
```

#Arranging jpegs into one plot
```{r}

behaviour <- ggarrange(moved_plot, moveo_plot, jumpo_plot, legsd_plot, legso_plot, percho_plot, groomd_plot, foodd_plot, bait_plot, font.label=list(size=6, face="bold", color ="black",
ncol=3, nrow=3, #h=align, arranging matrix
label.x=0.89, label.y=0.99, hjust=-0.1, vjust=1.5))

behaviour <- annotate_figure(behaviour, left=text_grob("Adjusted assay behaviours", rot=90, size = 18, face = "bold"))

ggsave(filename = "adjusted behaviour plots.jpeg", behaviour, width=300, height= 300, units = "mm")

```





## **REPEATED ASSAYS**




#Subsetting data to animals with repeated assays
```{r}

values_to_exclude <- c("524E3", "53221", "53511", "53512", "53515", "53526", "563A6", "56ABE", "56EB2", "5FC08", "6D409" , "6D53F" , "6E990" , "71A4D" , "71B69" , "86E19" , "86FFC" , "87F61", "BCA09")

data2 <- data %>%
  filter(!quoll_code %in% values_to_exclude)

view(data2)
names(data2)

```

# Testing influence of environmental variables on behaviour over repeated assays
```{r}

foodd2 <- glm(food_d ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)
foodo2 <- glm(food_o ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

groomd2 <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)
groomo2 <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

jumpd2 <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)
jumpo2 <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

legsd2 <- glm(legs_d ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)
legso2 <- glm(legs_o ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

moved2 <- glm(moving_d ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)
moveo2 <- glm(moving_o ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

perchd2 <- glm(perch_d ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)
percho2 <- glm(perch_o ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

bait2 <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

sumsect2 <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)
totalact2 <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

emerge2 <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

trapstress2 <- glm(stress_in_trap ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

bagstress2 <- glm(stress_in_bag ~ temp + moon_phase + time_assaytolight + 
               time_processtoassay, data=data2)

tablestress2 <- glm(stress_on_table ~ temp + moon_phase + time_assaytolight +                
                     time_processtoassay, data=data2)

```

# Tables: Evironmental stats
```{r}

tidy_results <- tidy(tablestress2) %>%
  mutate_if(is.numeric, ~round(., digits = 2))

colnames(tidy_results) <- c("Term", "Estimate", "Std. Error", "T-Value", "p.value")

tidy_results <- tidy_results %>%
  mutate(Term = case_when(
    Term == "(Intercept)" ~ "Intercept", 
    Term == "temp" ~ "Temperature",
    Term == "moon_phase" ~ "Moon phase",
    Term == "time_assaytolight" ~ "Time from assay to first light",
    Term == "time_processtoassay" ~ "Time from processing to assay"))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "On table stress rating", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```

# Mutate data: accounting for environmental variables over both assays
```{r}

#Mutating the environmental variables in the 1st assay df, including animals 53328 and 87DE0
names(data2)

data2_mutate <- data2 %>%
  mutate_at(vars(5, 57, 62), ~ as.vector(scale(.)))

view(data2_mutate)
write.csv(data2_mutate, "data both assays mutated.csv")


#Mutating environmental variables excluding 53328 and 87DE0
#names(data1_excl)
#data1ex_mutate <- data1_excl %>%
 #mutate_at(vars(5, 56, 61), ~ as.vector(scale(.)))
#write.csv(data1ex_mutate, "data 1st assay mutated exl Sept individuals.csv")

```

#Extract predictor/adjusted variables for both assays
```{r}

mod <- glm(food_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$foodo_p <- predict(mod, type = "response")
             
mod <- glm(food_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$foodd_p <- predict(mod, type = "response")
             
mod <- glm(grooming_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$groomo_p <- predict(mod, type = "response")

mod <- glm(grooming_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$groomd_p <- predict(mod, type = "response")
             
mod <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$jumpo_p <- predict(mod, type = "response")

mod <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$jumpd_p <- predict(mod, type = "response")

mod <- glm(legs_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$legsd_p <- predict(mod, type = "response")

mod <- glm(legs_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$legso_p <- predict(mod, type = "response")

mod <- glm(moving_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$moved_p <- predict(mod, type = "response")
             
mod <- glm(moving_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$moveo_p <- predict(mod, type = "response")

mod <- glm(perch_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$perchd_p <- predict(mod, type = "response")
             
mod <- glm(perch_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$percho_p <- predict(mod, type = "response")

mod <- glm(resting_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$restd_p <- predict(mod, type = "response")
             
mod <- glm(resting_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$resto_p <- predict(mod, type = "response")

mod <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$bait_p <- predict(mod, type = "response")
 
mod <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$sumsecto_p <- predict(mod, type = "response")            
             
mod <- glm(totalact_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$totalacto_p <- predict(mod, type = "response")

view(data2_mutate)
             
```

#Create df of predicted variables 
Accounting for environmental heterogeneity for both assays
```{r}

view(data2_mutate)

data2_pred <- data2_mutate %>%
  select(-food_o, -food_d, -grooming_o, -grooming_d, 
                     -jump_climb_o, -jump_climb_d, -legs_o, -legs_d, 
                     -moving_o, -moving_d, -perch_d, -perch_o, -resting_o,
                     -resting_d, -remaining_bait_g, -bait_eaten_g, 
                     -sumsect_o, -totalact_o) %>%
  mutate(assay_number = as.factor(assay_number))
  

view(data2_pred)
names(data2_pred)



write.csv(data1_pred,"both assays predicted variables.csv")

```

#Test adjusted behaviours against assay number
```{r}

fooddmod <- glm(foodd_p ~ assay_number, family=gaussian, data=data2_pred)
summary(fooddmod)
foodpmod <- glm(foodo_p ~ assay_number, family=gaussian, data=data2_pred)

groomdmod <- glm(groomd_p ~ assay_number, family=gaussian, data=data2_pred)
groomomod <- glm(groomo_p ~ assay_number, family=gaussian, data=data2_pred)

jumpdmod <- glm(jumpd_p ~ assay_number, family=gaussian, data=data2_pred)
jumpomod <- glm(jumpo_p ~ assay_number, family=gaussian, data=data2_pred)

legsdmod <- glm(legsd_p ~ assay_number, family=gaussian, data=data2_pred)
legsomod <- glm(legso_p ~ assay_number, family=gaussian, data=data2_pred)

movedmod <- glm(moved_p ~ assay_number, family=gaussian, data=data2_pred)
moveomod <- glm(moveo_p ~ assay_number, family=gaussian, data=data2_pred)

perchdmod <- glm(perchd_p ~ assay_number, family=gaussian, data=data2_pred)
perchomod <- glm(percho_p ~ assay_number, family=gaussian, data=data2_pred)

baitmod <- glm(bait_p ~ assay_number, family=gaussian, data=data2_pred)

sumsectomod <- glm(sumsecto_p ~ assay_number, family=gaussian, data=data2_pred)

totalactomod <- glm(totalacto_p ~ assay_number, family=gaussian, data=data2_pred)

```

# Tables: Assay number stats
```{r}

print(tidy_results)

tidy_results <- tidy(totalactomod)%>%
 mutate_if(is.numeric, ~round(., digits = 4))

colnames(tidy_results) <- c("Term", "Estimate", "Std. Error", "T-Value", "p.value")

tidy_results <- tidy_results %>%
  mutate(Term = case_when(
    Term == "(Intercept)" ~ "Intercept", 
    Term == "assay_number" ~ "Assay number",
    #Term == "moon_phase" ~ "Moon phase",
    #Term == "time_assaytolight" ~ "Time from assay to first light"
    ))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total behaviour activity occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Bait eaten (g)", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```

#Plots: significant results for assay number
```{r}


jo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = jumpo_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("Assay number") + ylab(expression(paste("Jumping and climbing occurrences ", italic("(n) ")))) + labs("") 
print(jo_plot)
ggsave(filename = "2 assays - assay number - jump occ.jpeg", jumpo_plot, width=200, height= 150, units = "mm")

jd_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = jumpd_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("Assay number") + ylab(expression(paste("Jumping and climbing duration (s)" ))) + labs("") 
print(jd_plot)
ggsave(filename = "2 assays - assay number - jump occ.jpeg", jumpo_plot, width=200, height= 150, units = "mm")

acto_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = totalacto_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("Assay number") + ylab(expression(paste("Total behaviour activity occurrences ", italic("(n) ")))) + labs("") 
print(acto_plot)

ggsave(filename = "2 assays - assay number - jump occ.jpeg", jumpo_plot, width=200, height= 150, units = "mm")

```

#Prep data for coefficient left_join 
```{r}

names(data2)
view(data2)

quoll2 <- data2 %>%
  filter(!assay_number %in% 1) %>%
  mutate(study_site = if_else(study_site == "MFWS", "Mulligans Flat", study_site))


```



#Extracting adjusted values for intercept (personality) and  slope (plasticity) over both assays
```{r}

# Create a list of dependent behavioural variables
dependent <- c("bait_eaten_g","food_o","food_d","grooming_o",
               "grooming_d","jump_climb_o","jump_climb_d","legs_o", "legs_d",
               "moving_o", "moving_d", "perch_o", "perch_d", "sumsect_o", "totalact_o")

# Define the levels in an object
quolls <- levels(factor(data2$quoll_code))

# Create a blank dataframe with four columns
coefficients <- data.frame(individual=NULL, intercept=NULL, 
                           slope=NULL, variable=NULL)

# Loop to extract the intercept and slope of each behavioural response
for(v in 1:NROW(dependent)) {
  for(i in 1:NROW(quolls)){
    individual <- quolls[i]
    variable <- dependent[v]
    mod <- lm(eval(as.name(paste0(variable))) ~ 
                assay_number + temp + moon_phase + time_assaytolight + time_processtoassay, 
              data=subset(data2, individual==quolls[i]))
    i <- coef(mod)[1]
    s <- coef(mod)[2]
    results <- data.frame(cbind(individual, i, s, variable))
    coefficients <- rbind(coefficients, results)
  }
}

# Convert the df to wide format
coefficients <- reshape(coefficients, idvar="individual", 
                        timevar="variable", direction="wide")

# Define names of the coefficients
names(coefficients) <- gsub("\\.", "_", names(coefficients))

# Remove duplicated coefficients
coefficients <- coefficients[ , !duplicated(colnames(coefficients))]

view(coefficients)

# Join behavioural df with post-release df
post <- read_excel(raw_data, sheet="post-release performance") %>%
  left_join(coefficients, by="quoll_code")

# Remove duplicated column names
post <- post[ , !duplicated(colnames(post))]

# Write to csv file
write_csv(post, "processed data/post-release performance.csv")

```



#Activity over time - prepping data
```{r}

bin <- read_excel(raw_data, sheet="Binned assays", na="N/A")%>%
 clean_names() 
 view(bin)

 # Append metadata for each assay to dataframe
bin_data <- left_join(meta, bin, by=c("assay_id", "quoll_code"), relationship = "many-to-many")
#view(data)
 
bin_data <- left_join(meta, bin, by=c("session", "assay_id", "quoll_code"), relationship = "many-to-many")%>%
 filter(!assay_id %in% c("MulligansA_4", "MulligansA_9", "MulligansB_19")) %>%
  select(-initial_repeat_assay, -trap_location, -time_to_emerge_s, -remaining_bait_g, -bait_eaten_g)

bin_data <- bin_data %>%
  mutate(minute_integer = as.integer(gsub("\\D", "", minute)))

names(bin_data)
view(bin_data)
 
```


```{r}

bin_data$assay_number <- factor(bin_data$assay_number)

plot <- ggplot(data = bin_data, 
       mapping = aes(x = minute_integer, y = moving_occ_binned))

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, color = study_site)) +
  geom_smooth() + # Add line
  labs(x = "Assay minute", y = "Moving Occurrences", title = "Line Plot") + # Add labels
  theme_minimal() # Choose a theme

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, color = assay_number)) +
  geom_smooth() + # Add line
  labs(x = "Assay minute", y = "Moving Occurrences", title = "Line Plot") + # Add labels
  theme_minimal() # Choose a theme

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, 
                             color = study_site, fill=study_site)) +
  geom_smooth() + # Add line
  ggtitle(label="Assay number", vjust=0.5) +
  labs(x="Assay minute", y="moving occ") + # Add labels
  theme_minimal() + # Choose a theme
  facet_wrap(~assay_number)

print(plot)
```

# Correlation analysis

```{r}

#Finding out the locations of the relevant columns 
colfoodo <- which(colnames(megadata) == "food_o")
print(colfoodo) #22
restingo <- which(colnames(megadata) == "resting_o")
print(restingo) #28
colsection4o <- which(colnames(megadata) == "section_4_o")
print(colsection4o) #32
colfoodd <- which(colnames(megadata) == "food_d")
print(colfoodd) #33
restingd <- which(colnames(megadata) == "resting_d")
print(restingd) #39
colsection4d <- which(colnames(megadata) == "section_4_d")
print(colsection4d) #43

#Selecting the appropriate columns for each correlation matrix
#all occurrence and duration columns including sections
cor_o_d <- megadata %>% 
  dplyr::select(22:43)

#all occurrence columns including sections
cor_o <- megadata %>%
  dplyr::select(22:32)

#all duration data including sections 
cor_d <- megadata %>%
  dplyr::select(33:43)

#all duration and occurrence data not including sections
cor_od_act <- megadata %>%
  dplyr::select(22:28, 33:39)

#all occurrence data not including sections
cor_o_act <- megadata %>%
  dplyr::select(22:28)

#all duration data not including sections
cor_d_act <- megadata %>%
  dplyr::select(33:39)

#Running the correlations tests for both, then occurrences, then duration, with sections
correlation_od <- cor(cor_o_d)
correlation_o <- cor(cor_o)
correlation_d <- cor(cor_d)

#Running the correlations for both, then occurrences v duration, then occurrences, then duration, without sections
correlation_od_act <- cor(cor_od_act)
correlation_ovd_act <- cor(cor_d_act,cor_o_act)
correlation_occ_act <- cor(cor_o_act)
correlation_dur_act <- cor(cor_d_act)

#Saving them to a .csv file
write.csv(correlation_od, "correlation matrix occ dur all sessions.csv")
write.csv(correlation_o, "correlation matrix occ all sessions.csv")
write.csv(correlation_d, "correlation matrix dur all sessions.csv")
write.csv(correlation_ovd_act, "correlation matrix activity occ vs dur all sessions.csv")
write.csv(correlation_occ_act, "correlation matrix activity occ all sessions.csv")
write.csv(correlation_dur_act, "correlation matrix activity dur all sessions.csv")

#Creating and printing correlation matrix .jpgs which colour code the correlations

#Correlation of occurrences and duration with sections
jpeg(height=2000, width=2000, file="correlation matrix od all sessions.jpeg", type="cairo")
corrplot(correlation_od, method="color", type="upper", #creates a correlation matrix
         cl.cex=3, number.cex=2, tl.cex=3, diag=FALSE,
         tl.col="black", tl.srt=45, addCoef.col="black")
dev.off()

#Correlations of duration and occurrences without sections
jpeg(height=2000, width=2000, file="correlation matrix occdur act all sessions.jpeg", type="cairo")
corrplot(correlation_od_act, method="color", type="upper", #creates a correlation matrix
         cl.cex=3, number.cex=2, tl.cex=3, diag=FALSE,
         tl.col="black", tl.srt=45, addCoef.col="black")
dev.off()

```

## Map

```{r, warning=FALSE}
# Read in and project MFWS fence shapefile using rgdal
mfws <- readOGR(dsn="shapefiles/MFGO_fences_and surrounds.shp", verbose=FALSE) %>% 
  spTransform(CRS("+proj=utm +zone=55 +ellps=WGS84")) %>%
  # Transform shapefile into a dataframe
  fortify(verbose=FALSE) %>%
  mutate(lat=as.numeric(lat + 10000000), 
         long=as.numeric(long))

# Read in and project MFGO fence shapefile using rgdal
mfgo <- st_read("shapefiles/MFGO_fences.shp", quiet=TRUE) %>%
  # Set projection to eastings/northings
  st_set_crs("EPSG:32755") %>% 
  # Reproject to lat/long
  st_transform("EPSG:4326")

# Plot den locations on MFWS map for each trial
map <- ggplot() + 
  geom_polygon(mfws, mapping=aes(x=long, y=lat, group=group), col="grey15") +
  #coord_sf(xlim=c(695750, 699250), ylim=c(6104250, 6107750)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_rect(fill="white"),
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.key = element_blank(), 
        strip.background = element_blank()) +
  #facet_wrap(~factor(year_of_acquisition), ncol=3) +
  #scale_colour_manual(values = viridis(3, begin=0.9, end=0.1)) +
  xlab("") + ylab("") + labs(col="Trial")
print(map)
```

```{r}
jpeg(file="mfgo_fences_and_surrounds.jpeg", 
     width=4750, height=1500, units="px", res=500)
map
dev.off()
```

# **Session information**

```{r}
# Display version information for R, OS, and packages
sessionInfo()
```


#***OLD CODE***

# Mutate data: accounting for environmental variables for first assays
```{r}

#Mutating the environmental variables in the 1st assay df, including animals 53328 and 87DE0
names(data1)

data1_mutate <- data1 %>%
  mutate_at(vars(5, 46, 67, 68), ~ as.vector(scale(.)))

view(data1_mutate)

write.csv(data1_mutate, "data 1st assay mutated.csv")

```



# Step 1 extract predicted values 
Of behaviour with accounted-for environmental variables
```{r}

mod <- glm(food_o ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$foodo_pred <- predict(mod, type = "response")
             
mod <- glm(food_d ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$foodd_pred <- predict(mod, type = "response")
             
mod <- glm(grooming_o ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$groomo_pred <- predict(mod, type = "response")
             
mod <- glm(grooming_d ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$groomd_pred <- predict(mod, type = "response")
             
mod <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$jumpo_pred <- predict(mod, type = "response")
             
mod <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$jumpd_pred <- predict(mod, type = "response")

mod <- glm(legs_d ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$legsd_pred <- predict(mod, type = "response")
             
mod <- glm(legs_o ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$legso_pred <- predict(mod, type = "response")

mod <- glm(moving_d ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$moved_pred <- predict(mod, type = "response")
             
mod <- glm(moving_o ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$moveo_pred <- predict(mod, type = "response")

mod <- glm(perch_d ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$perchd_pred <- predict(mod, type = "response")
             
mod <- glm(perch_o ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$percho_pred <- predict(mod, type = "response")

mod <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$bait_pred <- predict(mod, type = "response")
 
mod <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$sumsecto_pred <- predict(mod, type = "response")            
             
mod <- glm(totalact_o ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$totalacto_pred <- predict(mod, type = "response")
             
mod <- glm(stress_in_trap ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
            data1_mutate)
             data1_mutate$traps_pred <- predict(mod, type = "response")

mod <- glm(stress_in_bag ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
            data1_mutate)
             data1_mutate$bags_pred <- predict(mod, type = "response")
  
mod <- glm(stress_on_table ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
            data1_mutate)
             data1_mutate$tables_pred <- predict(mod, type = "response")
             
mod <- glm(emerge_max ~ temp + moon_phase + time_assaytolight +  
           time_processtoassay, 
           family=gaussian, data=
            data1_mutate)
             data1_mutate$emerge_pred <- predict(mod, type = "response")

#view(data1_mutate)
names(data1_mutate)

```


#Create df of predicted variables 
Accounting for environmental heterogeneity for first assays
```{r}

data1_pred <- data1_mutate %>%
              select(-food_o, -food_d, -grooming_o, -grooming_d, -jump_climb_o, -jump_climb_d,
                     -legs_o, -legs_d, -moving_o, -moving_d, -perch_d, -perch_o, -resting_o,
                     -resting_d, -bait_eaten_g, -sumsect_o, -totalact_o,
                     -stress_in_trap, -stress_in_bag, -stress_on_table, -time_to_emerge_s, -emerge_max)

write.csv(data1_pred,"first assay predicted variables.csv")

```


Running basic models to get the feel of the data
```{r}

summary(glm(sumsect_o ~ study_site + temp + assay_number + morph + sex +  age_estimate, data=data))
summary(glm(totalact_o ~ study_site + temp + assay_number + morph + sex +  age_estimate, data=data))

```

