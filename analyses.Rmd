---
title: "Eastern quoll behaviour and dispersal"
author: "Christina Gee, Belinda Wilson"
date: "14 March 2024"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: true
    theme: cerulean
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'tutorial.html')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE)
```

# * Background

Personality can play a crucial role in the survival and dispersal of reintroduced animals. In 2017, we reintroduced a cohort of female-only eastern quolls (*Dasyurus viverrinus*) to a [conservation-fenced haven](https://www.mulligansflat.org.au/) in the Australian Capital Territory, and conducted behavioural assays on each animal prior to their release. We aimed to determine whether personality and plasticity of these animals could predict their post-release performance.

Here we describe the analyses we conducted for our article [Wilson *et al.* (2022) Personality and plasticity predicts post-release performance in a reintroduced mesopredator](https://doi.org/10.1016/j.anbehav.2022.02.019), published in Animal Behaviour.

# * Setup

First, we installed the [pacman Package Management Tool](https://cran.r-project.org/web/packages/pacman/index.html), which allows us to install and load subsequent packages in a condensed and efficient way. 

```{r, eval=FALSE}
#install.packages("pacman")
```

# Install packages
```{r, results='hide', warning=FALSE, message=FALSE}
# Install and load required packages
pacman::p_load(basemaps, ggplot2, ggpubr, gtools, janitor, lme4,lmerTest, MuMIn,  
               readr, sf, readxl, rstudioapi, tidyverse, viridis, beepr, corrplot,
               broom, sjPlot, sjmisc, sjlabelled, knitr)

install.packages("kableExtra")
library(kableExtra)

install.packages("sjPlot")
library(sjPlot)

```

# Data preparation
```{r, eval=FALSE}
# Assign raw data filename to an object
raw_data <- "data.xlsx"

# Read in behavioural assay data
raw <- read_excel(raw_data, sheet="Assays", na="N/A") %>% 
  clean_names() %>%
  select("id"="observation_id", 
         "assay_id", 
         "quoll_code",
         behaviour="behavior", 
         occurrences="total_number_of_occurences")

#Read in the data for all data sheets in excel 
meta <- read_excel(raw_data, sheet="Metadata", na="N/A") %>% 
  clean_names()
#view(meta)
#names(meta)

quoll <- read_excel(raw_data, sheet="Quoll", na="N/A") %>%
  select(2, 4, 5) %>%
  clean_names()
#view(quoll)
#names(quoll)

capture <- read_excel(raw_data, sheet="Captures") %>%
   select(2, 4, 8, 9, 10, 11, 12, 13, 14, 24, 26, 27, 28, 30) %>%
  clean_names()
#view(capture)
#names(capture)

session <- read_excel(raw_data, sheet="Sessions") %>%
  select(4, 8, 9, 10, 11) %>%
  clean_names()
#view(session)
#names(session)

#bin <- read_excel(raw_data, sheet="Binned assays", na="N/A")%>%
 # clean_names()
#view(bin)

#sites <- read_excel(raw_data, sheet="Sites") %>%
  #clean_names()
#view(sites)

#trap_eff <- read_excel(raw_data, sheet="Trap effectiveness") %>%
 #clean_names()
#view(trap_eff)


#Clean up behaviour data from long to wide format 
occ <- pivot_wider(data = raw, 
                   names_from = behaviour, 
                   values_from = occurrences)  %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_o = "section_1", 
         section_2_o = "section_2", 
         section_3_o = "section_3", 
         section_4_o = "section_4", 
         moving_o = "moving", 
         jump_climb_o = "jump_climb", 
         food_o = "food", 
         legs_o = "legs", 
         grooming_o = "grooming", 
         resting_o = "resting", 
         perch_o = "perch")
#view(occ)


raw <- read_excel(raw_data, sheet="Assays", , na="N/A") %>% 
  clean_names() %>%
  select("id"="observation_id", 
         "assay_id", 
         quoll_code, 
         behaviour="behavior", 
         duration="total_duration_s")

dur <- pivot_wider(data = raw,
                   names_from = behaviour, 
                   values_from = duration) %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_d = "section_1", 
         section_2_d = "section_2", 
         section_3_d = "section_3", 
         section_4_d = "section_4", 
         moving_d = "moving", 
         jump_climb_d = "jump_climb", 
         food_d = "food", 
         legs_d = "legs", 
         grooming_d = "grooming", 
         resting_d = "resting", 
         perch_d = "perch")
#view(dur)

assays <- left_join(occ, dur, by=c("id", "assay_id", "quoll_code"))

#Adding all sections together to create a column with total section visitations
assays$sumsect_o <- rowSums(assays[, c("section_1_o", "section_2_o", "section_3_o", "section_4_o")])

#Finding out the locations of the relevant columns 
colfoodo <- which(colnames(assays) == "food_o")
print(colfoodo) #4

restingo <- which(colnames(assays) == "resting_o")
print(restingo) #10

#Adding together all activity occurrences without sections
assays$totalact_o <- rowSums(assays[, c(4:10)])

#view(assays)

# Append metadata for each assay to dataframe
data <- left_join(meta, assays, by=c("assay_id", "quoll_code"))
#view(data)

#this filters out animals which were not assayed
data <- data %>%
  filter(!is.na(assay_number))

data <- left_join(data, quoll, by=c("quoll_code"), relationship = "many-to-many")

data <- left_join(data, capture, by=c("quoll_code", "session"), relationship = "many-to-many")

data <- left_join(data, session, by=c("session"))

view(data)
names(data)

```

# Calculating time differences 
```{r}

#Check if the time columns are in the correct format
print(class(data$snout_in_arena))

#If not, correct to POSIXct format
data$snout_in_arena <- as.POSIXct(data$snout_in_arena)
data$process_end <- as.POSIXct(data$process_end)
data$first_light <- as.POSIXct(data$first_light)

#Calculate time differences
data$time_processtoassay <- data$snout_in_arena - data$process_end
data$time_assaytolight <- data$snout_in_arena - data$first_light

#view(data)

```

# ** SINGLE ASSAYS

# Subsetting data to include first assays only 
For 'personality' / 'tendency' analysis
```{r}

view(data)

data1 <- data %>%
    filter(assay_number !=2)
view(data1)

write.csv(data1, "first assay data raw.csv")

```

# Filtering out the two individuals who were assayed in Sept 2023
```{r}
#data1_excl <- data1 %>%
  #filter(!(quoll_code %in% c("53328", "87DE0")))
#view(data1_excl)

```

# Testing influence of environmental variables on behaviour
```{r}

foodd <- glm(food_d ~ temp + moon_phase + time_assaytolight, data=data1)
foodo <- glm(food_o ~ temp + moon_phase + time_assaytolight, data=data1)

groomd <- glm(grooming_d ~ temp + moon_phase + time_assaytolight, data=data1)
groomo <- glm(grooming_o ~ temp + moon_phase + time_assaytolight, data=data1)

jumpd <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight, data=data1)
jumpo <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight, data=data1)

legsd <- glm(legs_d ~ temp + moon_phase + time_assaytolight, data=data1)
legso <- glm(legs_o ~ temp + moon_phase + time_assaytolight, data=data1)

moved <- glm(moving_d ~ temp + moon_phase + time_assaytolight, data=data1)
moveo <- glm(moving_o ~ temp + moon_phase + time_assaytolight, data=data1)

perchd <- glm(perch_d ~ temp + moon_phase + time_assaytolight, data=data1)
percho <- glm(perch_o ~ temp + moon_phase + time_assaytolight, data=data1)

restd <- glm(resting_d ~ temp + moon_phase + time_assaytolight, data=data1)
resto <- glm(resting_o ~ temp + moon_phase + time_assaytolight, data=data1)

bait <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight, data=data1)

```

# Tables: Evironmental stats
```{r}

tidy_results <- tidy(bait) %>%
  mutate_if(is.numeric, ~round(., digits = 2))

colnames(tidy_results) <- c("Term", "Estimate", "Std. Error", "T-Value", "p.value")

tidy_results <- tidy_results %>%
  mutate(Term = case_when(
    Term == "(Intercept)" ~ "Intercept", 
    Term == "temp" ~ "Temperature",
    Term == "moon_phase" ~ "Moon phase",
    Term == "time_assaytolight" ~ "Time from assay to first light"))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Resting occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Bait eaten (g)", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)

table

```

# Mutate data: accounting for environmental variables for first assays
```{r}

#Mutating the environmental variables in the 1st assay df, including animals 53328 and 87DE0
names(data1)

data1_mutate <- data1 %>%
  mutate_at(vars(5, 57, 62), ~ as.vector(scale(.)))

view(data1_mutate)

write.csv(data1_mutate, "data 1st assay mutated.csv")


#Mutating environmental variables excluding 53328 and 87DE0
names(data1_excl)

data1ex_mutate <- data1_excl %>%
  mutate_at(vars(5, 56, 61), ~ as.vector(scale(.)))

write.csv(data1ex_mutate, "data 1st assay mutated exl Sept individuals.csv")

```

Running basic models to get the feel of the data
```{r}

#GLM to test duration of moving, first with all individuals, and then excluding the Sept 2023 individuals 
summary(glm(moving_d ~ study_site + temp + assay_number + morph + sex +  age_estimate, data=megadata))
summary(glm(moving_d ~ study_site + temp + assay_number + morph + sex +  age_estimate, data=megadata_excl))

```

# Step 1 extract predicted values 
Of behaviour with accounted-for environmental variables
```{r}

mod <- glm(food_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$foodo_pred <- predict(mod, type = "response")
mod <- glm(food_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$foodd_pred <- predict(mod, type = "response")
             
mod <- glm(grooming_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$groomo_pred <- predict(mod, type = "response")
mod <- glm(grooming_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$groomd_pred <- predict(mod, type = "response")
             
mod <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$jumpo_pred <- predict(mod, type = "response")
mod <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$jumpd_pred <- predict(mod, type = "response")

mod <- glm(legs_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$legsd_pred <- predict(mod, type = "response")
mod <- glm(legs_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$legso_pred <- predict(mod, type = "response")

mod <- glm(moving_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$moved_pred <- predict(mod, type = "response")
mod <- glm(moving_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$moveo_pred <- predict(mod, type = "response")

mod <- glm(perch_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$perchd_pred <- predict(mod, type = "response")
mod <- glm(perch_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$percho_pred <- predict(mod, type = "response")

mod <- glm(resting_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$restd_pred <- predict(mod, type = "response")
mod <- glm(resting_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$resto_pred <- predict(mod, type = "response")

mod <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=
             data1_mutate)
             data1_mutate$bait_pred <- predict(mod, type = "response")
             
view(data1_mutate)
names(data1_mutate)

```

#Create df of predicted variables 
Accounting for environmental heterogeneity for first assays
```{r}

data1_mutate <- data1_mutate %>%
  mutate(study_site = if_else(study_site == "MFWS", "Mulligans Flat", study_site))

data1_pred <- data1_mutate %>%
              select(-food_o, -food_d, -grooming_o, -grooming_d, -jump_climb_o, -jump_climb_d,
                     -legs_o, -legs_d, -moving_o, -moving_d, -perch_d, -perch_o, -resting_o,
                     -resting_d, -remaining_bait_g, -bait_eaten_g)

view(data1_pred)
names(data1_pred)

write.csv(data1_pred,"first assay predicted variables.csv")

```

Now we have our predicted values, accounting for environmental heterogeneity. 

#Step 2 Analyse behaviour indicators

  1. Test the influence of fixed (e.g., site) and random effects (e.g., arena) on behavioural responses (e.g., food interaction duration) using the `lmer()` function.
  2. If multiple fixed effects produce significance, perform model selection using the dredge() function to determine which fixed effects are within delta 2 AICc.

#LMERs for 'personality' 
Using predicted variables
(single response / static etc? figure out appropriate language for the variable being tested here)
```{r}

names(data1_pred)
view(data1_pred)

# Test random effects using LMER 
mod1 <- lmer(percho_pred ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + (1|quoll_code) + (1|arena), 
            data=data1_pred, na.action = "na.fail")

mod1 <- lmer(perchd_pred ~ study_site + sex + age_estimate + condition + 
              body_weight_kg + morph + (1|quoll_code) + (1|arena), 
            data=data1_pred, na.action = "na.fail")

# Display summary statistics
summary(mod1)

# Display model selection table for fixed effects
dredge(mod1, rank = "AICc")

```

#Tables: LMER stats using tableExtra
```{r}

view(tidy_results)
print(tidy_results)

tidy_results <- tidy(mod1) %>%
  mutate_if(is.numeric, ~round(., digits = 2))

tidy_results <- tidy_results %>%
  select(-effect, -group) %>%
  slice (-c(10, 11, 12))

colnames(tidy_results) <- c("Term", "Estimate", "Std. Error", "T-Value", "DF", "p.value")

tidy_results <- tidy_results %>%
  mutate(Term = case_when(
    Term == "(Intercept)" ~ "Intercept", 
    Term == "study_siteMulligans Flat" ~ "Study Site (Mulligans Flat)",
    Term == "sexMale" ~ "Sex (Male)",
    Term == "age_estimate1-2yrs" ~ "Age estimate (1-2yrs)",
    Term == "age_estimate2-3yrs" ~ "Age estimate (2-3yrs)",
    Term == "conditionFair" ~ "Condition (Fair)",
    Term == "conditionGood" ~ "Condition (Good)",
    Term == "body_weight_kg" ~ "Body weight (kg)",
    Term == "morphFawn" ~ "Morph (Fawn)"))

table <- tidy_results %>%
    mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Perching occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Perching duration (s)", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

view(data1_pred)
```

#Plots: Significant results for first assays
```{r}

#Belinda's  Preliminary plot
#ggplot(data=data1_pred, aes(x=study_site, y=bait_pred, fill=study_site)) +geom_boxplot()

#data1_pred$sex <- factor(data1_pred$sex, levels = c("F", "M"), labels = c("Female", "Male"))

#Plot with formatting

foodd_plot <- ggplot(data=data1_pred, aes(x = study_site, y = foodd_pred, 
                        fill = study_site)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Study site") + ylab("Food interaction duration (s)") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('h')"), size = 5, hjust = -5)
#print(foodd_plot)
#ggsave(filename = "study site - food dur.jpeg", foodd_plot, width=200, height= 150, units = "mm")

groomd_plot <- ggplot(data=data1_pred, aes(x = study_site, y = groomd_pred, 
                        fill = study_site)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(-20,60,10),labels=seq(-20,60,10), limits=c(-20,60)) +
  xlab("Study site") + ylab("Grooming duration (s)") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 60, label = parse(text = "bold('g')"), size = 5, hjust = -5)
#print(groomd_plot)
#ggsave(filename = "study site - groom dur.jpeg", groomd_plot, width=200, height= 150, units = "mm")

jumpo_plot <- ggplot(data=data1_pred, aes(x = sex, y = jumpo_pred, 
                        fill = sex)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(-20,80,20),labels=seq(-20,80,20), limits=c(-20,80)) +
  xlab("Sex") + ylab(expression(paste("Jumping and climbing occurrences ", italic("(n) ")))) + labs("") +
  annotate("text", x = "Male", y = 80, label = parse(text = "bold('c')"), size = 5, hjust = -5)
print(jumpo_plot)
#ggsave(filename = "sex - jump occ.jpeg", jumpo_plot, width=200, height= 150, units = "mm")

legsd_plot <- ggplot(data=data1_pred, aes(x = study_site, y = legsd_pred, 
                        fill = study_site)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(140,260,20),labels=seq(140,260,20), limits=c(140,270)) +
  xlab("Study site") + ylab("Standing on hind legs duration (s)") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 270, label = parse(text = "bold('d')"), size = 5, hjust = -5)
#print(legsd_plot)
#ggsave(filename = "study site - legs dur.jpeg", legsd_plot, width=200, height= 150, units = "mm")

legso_plot <- ggplot(data=data1_pred, aes(x = study_site, y = legso_pred, 
                        fill = study_site)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
scale_y_continuous(breaks=seq(40,120,20),labels=seq(40,120,20), limits=c(40,120)) +
  xlab("Study site") + ylab(expression(paste("Standing on hind legs occurrences ", italic("(n) ")))) + labs("") +
  annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('e')"), size = 5, hjust = -5)
#print(legso_plot)
#ggsave(filename = "study site - legs occ.jpeg", legso_plot, width=200, height= 150, units = "mm")

moved_plot <- ggplot(data=data1_pred, aes(x = study_site, y = moved_pred, 
                        fill = study_site)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(20,180,20),labels=seq(20,180,20), limits=c(20,180)) +
  xlab("Study site") + ylab("Quadrupedal movement duration (s)") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 180, label = parse(text = "bold('a')"), size = 5, hjust = -5)
#print(moved_plot)
#ggsave(filename = "study site - move dur.jpeg", moved_plot, width=200, height= 150, units = "mm")

moveo_plot <- ggplot(data=data1_pred, aes(x = study_site, y = moveo_pred, 
                        fill = study_site)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(40,160,20),labels=seq(40,160,20), limits=c(20,160)) +
  xlab("Study site") + ylab(expression(paste("Quadrupedal movement  occurrences ", italic("(n)")))) + labs("") +
  annotate("text", x = "Mulligans Flat", y = 160, label = parse(text = "bold('b')"), size = 5, hjust = -5)
#print(moveo_plot)
#ggsave(filename = "study site - move occ.jpeg", moveo_plot, width=200, height= 150, units = "mm")

percho_plot <- ggplot(data=data1_pred, aes(x = sex, y = percho_pred, 
                        fill = sex)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(-5,25,5),labels=seq(-5,25,5), limits=c(-10,25)) +
  xlab("Sex") + ylab(expression(paste("Perching occurrences ", italic("(n) ")))) + labs("") +
  annotate("text", x = "Male", y = 25, label = parse(text = "bold('f')"), size = 5, hjust = -5)
#print(percho_plot)
#ggsave(filename = "sex - perch occ.jpeg", percho_plot, width=200, height= 150, units = "mm")

bait_plot <- ggplot(data=data1_pred, aes(x = study_site, y = bait_pred, 
                        fill = study_site)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(0,50, 10),labels=seq(0,50,10), limits=c(-5,50)) +
  xlab("Study site") + ylab("Bait eaten (g)") + labs("") +
  annotate("text", x = "Mulligans Flat", y = 50, label = parse(text = "bold('i')"), size = 5, hjust = -5) 

#print(bait_plot)
#ggsave(filename = "study site - bait.jpeg", bait_plot, width=200, height= 150, units = "mm")

```

#Arranging jpegs into one plot
```{r}

behaviour <- ggarrange(moved_plot, moveo_plot, jumpo_plot, legsd_plot, legso_plot, percho_plot, groomd_plot, foodd_plot, bait_plot, font.label=list(size=6, face="bold", color ="black",
ncol=3, nrow=3, #h=align, arranging matrix
label.x=0.89, label.y=0.99, hjust=-0.1, vjust=1.5))

behaviour <- annotate_figure(behaviour, left=text_grob("Adjusted assay behaviours", rot=90, size = 18, face = "bold"))

ggsave(filename = "adjusted behaviour plots.jpeg", behaviour, width=300, height= 300, units = "mm")

```


#Collecting statistics for a model table (🚩 this goes at the end of your independent variable modelling).
```{r}
# Generate a model
mod <- glm(food_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate, 
           na.action = "na.fail")

summary(mod)

#collect stats into a table
p_temp <- summary(mod)$coefficients["temp", "Pr(>|t|)"]
p_moon <- summary(mod)$coefficients["moon_phase", "Pr(>|t|)"]

data.frame(Variable = c("Temperature", "Moon phase"),
           p_value = c(p_temp, p_moon))

# Conduct model selection using AICc threshold
dredge(mod, rank = "AICc")


```

## **REPEATED ASSAYS

#Subsetting data to animals with repeated assays
```{r}
values_to_exclude <- c("524E3", "53221", "53511", "53512", "53515", "53526", "563A6", "56ABE", "56EB2", "5FC08", "6D409" , "6D53F" , "6E990" , "71A4D" , "71B69" , "86E19" , "86FFC" , "87F61", "BCA09")

data2 <- data %>%
  filter(!quoll_code %in% values_to_exclude) %>%
  mutate(study_site = if_else(study_site == "MFWS", "Mulligans Flat", study_site))

view(data2)

```

# Testing influence of environmental variables on behaviour over repeated assays
```{r}

foodd2 <- glm(food_d ~ temp + moon_phase + time_assaytolight, data=data2)
foodo2 <- glm(food_o ~ temp + moon_phase + time_assaytolight, data=data2)

groomd2 <- glm(grooming_d ~ temp + moon_phase + time_assaytolight, data=data2)
groomo2 <- glm(grooming_o ~ temp + moon_phase + time_assaytolight, data=data2)

jumpd2 <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight, data=data2)
jumpo2 <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight, data=data2)

legsd2 <- glm(legs_d ~ temp + moon_phase + time_assaytolight, data=data2)
legso2 <- glm(legs_o ~ temp + moon_phase + time_assaytolight, data=data2)

moved2 <- glm(moving_d ~ temp + moon_phase + time_assaytolight, data=data2)
moveo2 <- glm(moving_o ~ temp + moon_phase + time_assaytolight, data=data2)

perchd2 <- glm(perch_d ~ temp + moon_phase + time_assaytolight, data=data2)
percho2 <- glm(perch_o ~ temp + moon_phase + time_assaytolight, data=data2)

restd2 <- glm(resting_d ~ temp + moon_phase + time_assaytolight, data=data2)
resto2 <- glm(resting_o ~ temp + moon_phase + time_assaytolight, data=data2)

bait2 <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight, data=data2)

```

# Tables: Evironmental stats
```{r}

print(tidy_results)

tidy_results <- tidy(bait2) %>%
  mutate_if(is.numeric, ~round(., digits = 2))

colnames(tidy_results) <- c("Term", "Estimate", "Std. Error", "T-Value", "p.value")

tidy_results <- tidy_results %>%
  mutate(Term = case_when(
    Term == "(Intercept)" ~ "Intercept", 
    Term == "temp" ~ "Temperature",
    Term == "moon_phase" ~ "Moon phase",
    Term == "time_assaytolight" ~ "Time from assay to first light"))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Perching occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Bait eaten (g)", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```


# Mutate data: accounting for environmental variables over both assays
```{r}

#Mutating the environmental variables in the 1st assay df, including animals 53328 and 87DE0
names(data2)

data2_mutate <- data2 %>%
  mutate_at(vars(5, 57, 62), ~ as.vector(scale(.)))

view(data2_mutate)
write.csv(data2_mutate, "data both assays mutated.csv")


#Mutating environmental variables excluding 53328 and 87DE0
#names(data1_excl)
#data1ex_mutate <- data1_excl %>%
 #mutate_at(vars(5, 56, 61), ~ as.vector(scale(.)))
#write.csv(data1ex_mutate, "data 1st assay mutated exl Sept individuals.csv")

```


#Step 3 Run GLMs for assay numbers and if this is significant, do step 3b in mind map plan
```{r}

mod_fo_p <- glm(mod_fo_p ~ assay_number, family=gaussian, data=megadata_mutate)
mod_fd_p <- glm(mod_fd_p ~ assay_number, family=gaussian, data=megadata_mutate)

```

# Correlation analysis
```{r}

#Finding out the locations of the relevant columns 
colfoodo <- which(colnames(megadata) == "food_o")
print(colfoodo) #22
restingo <- which(colnames(megadata) == "resting_o")
print(restingo) #28
colsection4o <- which(colnames(megadata) == "section_4_o")
print(colsection4o) #32
colfoodd <- which(colnames(megadata) == "food_d")
print(colfoodd) #33
restingd <- which(colnames(megadata) == "resting_d")
print(restingd) #39
colsection4d <- which(colnames(megadata) == "section_4_d")
print(colsection4d) #43

#Selecting the appropriate columns for each correlation matrix
#all occurrence and duration columns including sections
cor_o_d <- megadata %>% 
  dplyr::select(22:43)

#all occurrence columns including sections
cor_o <- megadata %>%
  dplyr::select(22:32)

#all duration data including sections 
cor_d <- megadata %>%
  dplyr::select(33:43)

#all duration and occurrence data not including sections
cor_od_act <- megadata %>%
  dplyr::select(22:28, 33:39)

#all occurrence data not including sections
cor_o_act <- megadata %>%
  dplyr::select(22:28)

#all duration data not including sections
cor_d_act <- megadata %>%
  dplyr::select(33:39)

#Running the correlations tests for both, then occurrences, then duration, with sections
correlation_od <- cor(cor_o_d)
correlation_o <- cor(cor_o)
correlation_d <- cor(cor_d)

#Running the correlations for both, then occurrences v duration, then occurrences, then duration, without sections
correlation_od_act <- cor(cor_od_act)
correlation_ovd_act <- cor(cor_d_act,cor_o_act)
correlation_occ_act <- cor(cor_o_act)
correlation_dur_act <- cor(cor_d_act)

#Saving them to a .csv file
write.csv(correlation_od, "correlation matrix occ dur all sessions.csv")
write.csv(correlation_o, "correlation matrix occ all sessions.csv")
write.csv(correlation_d, "correlation matrix dur all sessions.csv")
write.csv(correlation_ovd_act, "correlation matrix activity occ vs dur all sessions.csv")
write.csv(correlation_occ_act, "correlation matrix activity occ all sessions.csv")
write.csv(correlation_dur_act, "correlation matrix activity dur all sessions.csv")

#Creating and printing correlation matrix .jpgs which colour code the correlations

#Correlation of occurrences and duration with sections
jpeg(height=2000, width=2000, file="correlation matrix od all sessions.jpeg", type="cairo")
corrplot(correlation_od, method="color", type="upper", #creates a correlation matrix
         cl.cex=3, number.cex=2, tl.cex=3, diag=FALSE,
         tl.col="black", tl.srt=45, addCoef.col="black")
dev.off()

#Correlations of duration and occurrences without sections
jpeg(height=2000, width=2000, file="correlation matrix occdur act all sessions.jpeg", type="cairo")
corrplot(correlation_od_act, method="color", type="upper", #creates a correlation matrix
         cl.cex=3, number.cex=2, tl.cex=3, diag=FALSE,
         tl.col="black", tl.srt=45, addCoef.col="black")
dev.off()

```

## Map
```{r, warning=FALSE}
# Read in and project MFWS fence shapefile using rgdal
mfws <- readOGR(dsn="shapefiles/MFGO_fences_and surrounds.shp", verbose=FALSE) %>% 
  spTransform(CRS("+proj=utm +zone=55 +ellps=WGS84")) %>%
  # Transform shapefile into a dataframe
  fortify(verbose=FALSE) %>%
  mutate(lat=as.numeric(lat + 10000000), 
         long=as.numeric(long))

# Read in and project MFGO fence shapefile using rgdal
mfgo <- st_read("shapefiles/MFGO_fences.shp", quiet=TRUE) %>%
  # Set projection to eastings/northings
  st_set_crs("EPSG:32755") %>% 
  # Reproject to lat/long
  st_transform("EPSG:4326")

# Plot den locations on MFWS map for each trial
map <- ggplot() + 
  geom_polygon(mfws, mapping=aes(x=long, y=lat, group=group), col="grey15") +
  #coord_sf(xlim=c(695750, 699250), ylim=c(6104250, 6107750)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_rect(fill="white"),
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.key = element_blank(), 
        strip.background = element_blank()) +
  #facet_wrap(~factor(year_of_acquisition), ncol=3) +
  #scale_colour_manual(values = viridis(3, begin=0.9, end=0.1)) +
  xlab("") + ylab("") + labs(col="Trial")
print(map)
```

```{r}
jpeg(file="mfgo_fences_and_surrounds.jpeg", 
     width=4750, height=1500, units="px", res=500)
map
dev.off()
```

# **Session information**
```{r}
# Display version information for R, OS, and packages
sessionInfo()
```