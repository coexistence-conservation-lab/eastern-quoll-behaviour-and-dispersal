---
title: "Eastern quoll behaviour and dispersal"
author: "Christina Gee, Belinda Wilson"
date: "14 March 2024"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: true
    theme: cerulean
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'tutorial.html')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE)
```

# * Background

Personality can play a crucial role in the survival and dispersal of reintroduced animals. In 2017, we reintroduced a cohort of female-only eastern quolls (*Dasyurus viverrinus*) to a [conservation-fenced haven](https://www.mulligansflat.org.au/) in the Australian Capital Territory, and conducted behavioural assays on each animal prior to their release. We aimed to determine whether personality and plasticity of these animals could predict their post-release performance.

Here we describe the analyses we conducted for our article [Wilson *et al.* (2022) Personality and plasticity predicts post-release performance in a reintroduced mesopredator](https://doi.org/10.1016/j.anbehav.2022.02.019), published in Animal Behaviour.

# * Setup

First, we installed the [pacman Package Management Tool](https://cran.r-project.org/web/packages/pacman/index.html), which allows us to install and load subsequent packages in a condensed and efficient way. 

```{r, eval=FALSE}
#install.packages("pacman")
```

# Install packages
```{r, results='hide', warning=FALSE, message=FALSE}
# Install and load required packages
pacman::p_load(basemaps, ggplot2, ggpubr, gtools, janitor, lme4,lmerTest, MuMIn,  
               readr, sf, readxl, rstudioapi, tidyverse, viridis, beepr, corrplot,
               broom, sjPlot, sjmisc, sjlabelled, knitr)

#install.packages("kableExtra")
library(kableExtra)

#install.packages("broom.mixed")
library(broom.mixed)

#install.packages("AICcmodavg")
library(AICcmodavg)

#install.packages("glmmTMB")
library(glmmTMB)

```

# Data preparation
```{r, eval=FALSE}
# Assign raw data filename to an object
raw_data <- "data.xlsx"

# Read in behavioural assay data
raw <- read_excel(raw_data, sheet="Assays", na="N/A") %>% 
  clean_names() %>%
  select("obs_id"="observation_id", 
         "assay_id", 
         "quoll_code",
         behaviour="behavior", 
         occurrences="total_number_of_occurences")

#Read in the data for all data sheets in excel 
meta <- read_excel(raw_data, sheet="Metadata", na="N/A") %>% 
  clean_names()

quoll <- read_excel(raw_data, sheet="Quoll", na="N/A") %>%
  clean_names()

capture <- read_excel(raw_data, sheet="Captures") %>%
  clean_names()

session <- read_excel(raw_data, sheet="Sessions") %>%
    clean_names()


#bin <- read_excel(raw_data, sheet="Binned assays", na="N/A")%>%
 # clean_names()

#sites <- read_excel(raw_data, sheet="Sites") %>%
  #clean_names()

#trap_eff <- read_excel(raw_data, sheet="Trap effectiveness") %>%
 #clean_names()

#Clean up behaviour data from long to wide format 
occ <- pivot_wider(data = raw, 
                   names_from = behaviour, 
                   values_from = occurrences)  %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_o = "section_1", 
         section_2_o = "section_2", 
         section_3_o = "section_3", 
         section_4_o = "section_4", 
         moving_o = "moving", 
         jump_climb_o = "jump_climb", 
         food_o = "food", 
         legs_o = "legs", 
         grooming_o = "grooming", 
         resting_o = "resting", 
         perch_o = "perch")

raw <- read_excel(raw_data, sheet="Assays", , na="N/A") %>% 
  clean_names() %>%
  select("obs_id"="observation_id", 
         "assay_id", 
         quoll_code, 
         behaviour="behavior", 
         duration="total_duration_s")

dur <- pivot_wider(data = raw,
                   names_from = behaviour, 
                   values_from = duration) %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_d = "section_1", 
         section_2_d = "section_2", 
         section_3_d = "section_3", 
         section_4_d = "section_4", 
         moving_d = "moving", 
         jump_climb_d = "jump_climb", 
         food_d = "food", 
         legs_d = "legs", 
         grooming_d = "grooming", 
         resting_d = "resting", 
         perch_d = "perch")

assays <- left_join(occ, dur, by=c("obs_id", "assay_id", "quoll_code"))

#Adding all sections together to create a column with total section visitations
assays$sumsect_o <- rowSums(assays[, c("section_1_o", "section_2_o", "section_3_o", "section_4_o")])

#Adding together all activity occurrences without sections
assays$totalact_o <- rowSums(assays[, c(4:10)])
#view(assays)

# Append metadata for each assay to dataframe
behavdata <- left_join(meta, assays, by=c("assay_id", "quoll_code"))%>%
  filter(!is.na(assay_number))

behavdata <- left_join(behavdata, session, by=c("session"))%>%
  filter(!is.na(assay_number))

quolldata <- left_join(capture, quoll, by=c("quoll_code"))

data <- left_join(behavdata, quolldata, by=c("session", "quoll_code"))
  
data <- data %>%
  select(-min_temp, -session_desc, -capture_date, -new_animal) %>%
  mutate(assay_number = as.factor(assay_number),
         cond_n = as.numeric(ifelse(condition=="Excellent", 4,
                            ifelse(condition=="Good", 3,
                                   ifelse(condition=="Fair", 2, NA)))),
         age_n = as.numeric(ifelse(age_estimate=="<1yr", 0,
                               ifelse(age_estimate=="1-2yrs", 1,
                                      ifelse(age_estimate=="2-3yrs", 2, NA)))))

```

# Calculating time differences 
```{r}

#Change time columns to correct POSIXct format
data$snout <- as.POSIXct(data$snout)
data$process_end <- as.POSIXct(data$process_end)
data$first_light <- as.POSIXct(data$first_light)

#Calculate time differences
data$time_processtoassay <- data$snout - data$process_end
data$time_assaytolight <- data$first_light - data$snout

#Filtering out the two individuals who were assayed in Sept 2023
data <- data %>%
  filter(!(quoll_code %in% c("53328", "87DE0")))

```

# Correlation analysis
```{r}

cor <- data  %>% 
  dplyr::select(age_n, body_weight_kg, cond_n, pes_mean_mm, head_length_mm)

#Running the correlation test
cor <- cor(cor)
view(cor)

#Saving them to a .csv file
write.csv(cor, "data - morphometric correlation matrix.csv")

#Creating and printing correlation matrix .jpgs which colour code the correlations
col_names <- c("Age estimate", "Body weight (kg)", "Condition", "Pes length (mm)", "Head length (mm)")
row_names <- c("Age estimate", "Body weight (kg)", "Condition", "Pes length (mm)", "Head length (mm)")
colnames(cor) <- col_names
rownames(cor) <- row_names

#Correlation of occurrences and duration with sections
jpeg(height=2000, width=2000, file="data corplot.jpeg", type="cairo")
corrplot(cor, method="color", type="upper", #creates a correlation matrix
         cl.cex=3, number.cex=2, tl.cex=3, diag=FALSE,
         tl.col="black", tl.srt=45, addCoef.col="black")
dev.off()

```

#** SINGLE ASSAYS

# Subsetting data to include first assays only 
For morphometric and demographic analysis, and 'static behaviour' analysis
```{r}

data1 <- data %>%
      filter(assay_number !=2)

data1$site01 <- ifelse(data1$study_site == "Goorooyarroo", 1, 0)

write.csv(data1, "data1 - first assay data raw.csv")

```

#Demo/morpho GLM analysis
```{r}

#Generalised linear model
mod <- glm(site01 ~ sex*body_weight_kg + cond_n + age_n, data=data1, family=binomial)
summary(mod)

#AICc 
mod_cn_site <- lmer(site01 ~ cond_n + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_an_temp <- lmer(site01 ~ age_n + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_cn_site, mod_an_temp)
model.names <- c("Condition", "Age")
aictab(cand.set = models, modnames = model.names)

```

#Demo/morpho tables with kableExtra
```{r}
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Study site", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```

#Demo/morpho plots
```{r}

#Condition plot
data1$condition <- factor(data1$condition, levels = c("Excellent", "Good", "Fair", "Poor"))

cond_plot  <- ggplot(data=data1, aes(x = study_site, fill=condition)) + 
 geom_bar(position="fill") +
  stat_count(aes(label = ..count..), geom = "text", position = position_fill(vjust = 0.5), size = 3.5, 
             color = "white") +
  scale_fill_manual (values = c("#3f4288", "#25798F", "#1caa85","#7BD151"), name = "Body condition score") +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,20,5),labels=seq(0,20,5), limits=c(0,20)) +
  xlab("Study site") + ylab("Proportion of eastern quolls") + labs("") 
print(cond_plot)
ggsave(filename = "morpho - cond v study site.jpeg", cond_plot, width=200, height= 150, units = "mm")

#Age plot 
data1$age_n <- factor(data1$age_n, levels = c("2", "1", "0"))

age_plot  <- ggplot(data=data1, aes(x = study_site, fill=age_n)) + 
 geom_bar(position="fill") +
  stat_count(aes(label = ..count..), geom = "text", position = position_fill(vjust = 0.5), size = 3.5, 
             color = "white") +
  scale_fill_manual (values = c("#3f4288", "#25798F", "#1caa85"), 
                     name = "Age estimate",
                     labels = c("2-3 years", "1-2 years", "< 1 year")) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  #scale_y_continuous(breaks=seq(0,20,5),labels=seq(0,20,5), limits=c(0,20)) +
  xlab("Study site") + ylab("Proportion of eastern quolls") + labs("") 
print(age_plot)
ggsave(filename = "morpho - age v study site.jpeg", age_plot, width=200, height= 150, units = "mm")

```

#Environmental vars influence GLM analysis
```{r}

foodd <- glm(food_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
foodo <- glm(food_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

groomd <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
groomo <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

jumpd <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
jumpo <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

legsd <- glm(legs_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
legso <- glm(legs_o  ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

moved <- glm(moving_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
moveo <- glm(moving_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

perchd <- glm(perch_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
percho <- glm(perch_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

bait <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
sumsecto <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
totalacto <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
emerge <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

trapstress <- glm(stress_in_trap ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
bagstress <- glm(stress_in_bag ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)
tablestress <- glm(stress_on_table ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data1)

```

#Environmental vars tables  with kabelExtra
```{r}

tidy_results <- tidy(groomd) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```

#Environmental vars plots
```{r}

#Grooming duration v temp
gdtemp_plot <- ggplot(data=data1, aes(x = grooming_d, y = temp)) + 
 geom_smooth() +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) +
  xlab("Grooming duration (s)") + ylab("Temperature") + labs("") 

print(gdtemp_plot)
ggsave(filename = "1st assay - study site v grooming dur.jpeg", groomd_site, width=200, height= 150, units = "mm")

#Grooming occurrences v temp
gotemp_plot <- ggplot(data=data1, aes(x = grooming_o, y = temp)) + 
 geom_smooth() +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) +
  xlab("Grooming occurrences (n)") + ylab("Temperature") + labs("") 

print(gotemp_plot)
ggsave(filename = "1st assay - study site v grooming dur.jpeg", groomd_site, width=200, height= 150, units = "mm")

```

Analyse behaviour indicators
  1. Test the influence of fixed (e.g., site) and random effects (e.g., arena) on behavioural responses (e.g., food interaction duration) using the `lmer()` function.
  2. If multiple fixed effects produce significance, perform model selection using the dredge() function to determine which fixed effects are within delta 2 AICc.

#Static behaviour GLMMS
Testing behaviour in GLMMs including environmental variables as competing factors in fixed effects model.
```{r}

mod <- lmer(bait_eaten_g ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(emerge_max ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + (1|arena),             data=data1, na.action = "na.fail")

mod <- lmer(food_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(food_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(grooming_d ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + (1|arena),
            data=data1, na.action = "na.fail")

mod <- lmer(grooming_o ~ study_site + sex + age_n + cond_n +
              body_weight_kg + temp + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(jump_climb_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(jump_climb_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(legs_d ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(legs_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(moving_d ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight
            + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(moving_o ~ study_site + sex + age_n + cond_n + body_weight_kg + time_assaytolight
            + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(perch_d ~ study_site + sex + age_n + cond_n + body_weight_kg + temp + moon_phase
            + time_assaytolight + time_processtoassay + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(perch_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_in_bag ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_in_trap ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(stress_on_table ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(sumsect_o ~ study_site + sex + age_n + cond_n + body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

mod <- lmer(totalact_o ~ study_site + sex + age_n + cond_n + 
              body_weight_kg + (1|arena), 
            data=data1, na.action = "na.fail")

#Tables with kableExtra
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences (n)", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

```

#Static behaviour AICc model selection
```{r}

control_ml <- lmerControl(optimizer = "Nelder_Mead")

#Grooming duration 
mod_gd_site <- lmer(grooming_d ~ study_site + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_gd_temp <- lmer(grooming_d ~ temp + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_gd_site, mod_gd_temp)
model.names <- c("Site", "Temp")
aictab(cand.set = models, modnames = model.names)

#Grooming occurrences
mod_go_site <- lmer(grooming_o ~ study_site + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_go_temp <- lmer(grooming_o ~ temp + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_go_site, mod_go_temp)
model.names <- c("Site", "Temp")
aictab(cand.set = models, modnames = model.names)

#Jumping and climbing occurrences
mod_jo_sex <- lmer(jump_climb_o ~ sex + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_jo_age <- lmer(jump_climb_o ~ age_n + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_jo_sex, mod_jo_age)
model.names <- c("Sex", "Age")
aictab(cand.set = models, modnames = model.names)

#Perching occurrences
mod_po_sex <- lmer(perch_o ~ sex + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_po_age <- lmer(perch_o ~ age_n + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
mod_po_site <- lmer(perch_o ~ study_site + (1|arena), 
            data=data1, control = control_ml, na.action = "na.fail")
models <- list(mod_po_sex, mod_po_age, mod_po_site)
model.names <- c("Sex", "Age", "Study site")
aictab(cand.set = models, modnames = model.names)

```

#Static behaviour plots
```{r}

#Grooming duration v study site plot
groomd_site <- ggplot(data=data1, aes(x = study_site, y = grooming_d, fill=study_site)) + 
 geom_violin() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(0,120,20),labels=seq(0,120,20), limits=c(0,120)) +
  xlab("Study site") + ylab("Grooming duration (s)") + labs("") 
#annotate("text", x = "Mulligans Flat", y = 120, label = parse(text = "bold('h')"), size = 5, hjust = -5)
print(groomd_site)
ggsave(filename = "1st assay - study site v grooming dur.jpeg", groomd_site, width=200, height= 150, units = "mm")

#Grooming occurrences v study site plot
groomo_site <- ggplot(data=data1, aes(x = study_site, y = grooming_o, 
                        fill = study_site)) + 
  geom_violin() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  scale_y_continuous(breaks=seq(0,8,2),labels=seq(0,8,2), limits=c(0,8)) +
  xlab("Study site") + ylab(expression(paste("Grooming occurrences ", italic(" (n)")))) + labs("")
print(groomo_site)
ggsave(filename = "1st assay - study site v grooming occ.jpeg", groomo_site, width=200, height= 150, units = "mm")

#Jumping and climbing v age plot 
joage_plot  <- ggplot(data=data1, aes(x = age_estimate, y = jump_climb_o, fill = age_estimate)) + 
 geom_boxplot() +
  scale_fill_manual (values = c("#3f4288", "#25798F", "#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("Age estimate") + ylab(expression(paste("Jumping and climbing occurrences ", italic(" (n) ")))) + 
  labs("") 
print(joage_plot)
ggsave(filename = "morpho - age v jumping.jpeg", joage_plot, width=200, height= 150, units = "mm")

#Perching v age plot 
page_plot  <- ggplot(data=data1, aes(x = age_estimate, y = perch_o, fill = age_estimate)) + 
 geom_boxplot() +
  scale_fill_manual (values = c("#3f4288", "#25798F", "#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("Age estimate") + ylab(expression(paste("Perching occurrences ", italic(" (n) ")))) + 
  labs("") 
print(page_plot)

ggsave(filename = "morpho - age v perching.jpeg", page_plot, width=200, height= 150, units = "mm")

#Perching v sex plot 
psex_plot  <- ggplot(data=data1, aes(x = sex, y = perch_o, fill = sex)) + 
 geom_boxplot() +
  scale_fill_manual (values = c("#25798F", "#1caa85")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("Sex") + ylab(expression(paste("Perching occurrences ", italic(" (n) ")))) + 
  labs("") +
  scale_x_discrete(labels = c("Female", "Male"))
print(psex_plot)
ggsave(filename = "morpho - sex v perching.jpeg", psex_plot, width=200, height= 150, units = "mm")

```

## ** MULTIPLE ASSAYS
#Subsetting data to animals with repeated assays
```{r}
values_to_exclude <- c("524E3", "53221", "53511", "53512", "53515", "53526", "563A6", "56ABE", "56EB2", "5FC08", "6D409" , "6D53F" , "6E990" , "71A4D" , "71B69" , "86E19" , "86FFC" , "87F61", "BCA09")

data2 <- data %>%
  filter(!quoll_code %in% values_to_exclude)

write.csv(data2, "data2 - individuals with two assays raw data.csv")

```

# Environmental vars GLM analysis
```{r}

bait2 <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
foodd2 <- glm(food_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
foodo2 <- glm(food_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

groomd2 <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
groomo2 <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

jumpd2 <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
jumpo2 <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

legsd2 <- glm(legs_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
legso2 <- glm(legs_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

moved2 <- glm(moving_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
moveo2 <- glm(moving_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

perchd2 <- glm(perch_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
percho2 <- glm(perch_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

emerge2 <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
summary(emerge2)

sumsect2 <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
totalact2 <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)

trapstress2 <- glm(stress_in_trap ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
bagstress2 <- glm(stress_in_bag ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
tablestress2 <- glm(stress_on_table ~ temp + moon_phase + time_assaytolight + time_processtoassay, data=data2)
summary(tablestress2)

```

# Environmental vars tables with kableExtra
```{r}

tidy_results <- tidy(bait2) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Bait eaten (g)", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences <em>(n)</em>", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```

# Environmental vars data mutated
```{r}

#Mutating the environmental variables 
data2_mutate <- data2 %>%
  mutate_at(vars(5, 44, 65, 66), ~ as.vector(scale(.)))

data2$condition <- factor(data2$condition, levels = c("Excellent", "Good", "Fair", "Poor"))
data2$age_n <- factor(data2$age_n, levels = c("2", "1", "0"))

view(data2_mutate)
write.csv(data2_mutate, "data2_mutate - both assays env vars adjusted.csv")

```

#Adjusted behaviour variables - extracting values
```{r}

mod <- glm(food_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$foodo_p <- predict(mod, type = "response")
             
mod <- glm(food_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$foodd_p <- predict(mod, type = "response")
             
mod <- glm(grooming_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$groomo_p <- predict(mod, type = "response")

mod <- glm(grooming_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$groomd_p <- predict(mod, type = "response")
             
mod <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$jumpo_p <- predict(mod, type = "response")

mod <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$jumpd_p <- predict(mod, type = "response")

mod <- glm(legs_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$legsd_p <- predict(mod, type = "response")

mod <- glm(legs_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$legso_p <- predict(mod, type = "response")

mod <- glm(moving_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$moved_p <- predict(mod, type = "response")
             
mod <- glm(moving_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$moveo_p <- predict(mod, type = "response")

mod <- glm(perch_d ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$perchd_p <- predict(mod, type = "response")
             
mod <- glm(perch_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$percho_p <- predict(mod, type = "response")

mod <- glm(bait_eaten_g ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$bait_p <- predict(mod, type = "response")
 
mod <- glm(sumsect_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$sumsecto_p <- predict(mod, type = "response")            
             
mod <- glm(totalact_o ~ temp + moon_phase + time_assaytolight + time_processtoassay, 
           family=gaussian, data=
             data2_mutate)
             data2_mutate$totalacto_p <- predict(mod, type = "response")
             
mod <- glm(stress_in_trap ~ temp + moon_phase + time_assaytolight + time_processtoassay,
           family=gaussian, data=
             data2_mutate)
             data2_mutate$trapstress_p <- predict(mod, type = "response")

mod <- glm(stress_in_bag ~ temp + moon_phase + time_assaytolight + time_processtoassay,
           family=gaussian, data=
             data2_mutate)
             data2_mutate$bagstress_p <- predict(mod, type = "response")

mod <- glm(stress_on_table ~ temp + moon_phase + time_assaytolight + time_processtoassay,
           family=gaussian, data=
             data2_mutate)
             data2_mutate$tablestress_p <- predict(mod, type = "response")

mod <- glm(emerge_max ~ temp + moon_phase + time_assaytolight + time_processtoassay,
           family=gaussian, data=
             data2_mutate)
             data2_mutate$emerge_p <- predict(mod, type = "response")

```

#Adjusted behaviour variables - create df 
Accounting for environmental heterogeneity for both assays
```{r}

data2_pred <- data2_mutate %>%
  select(-food_o, -food_d, -grooming_o, -grooming_d, 
                     -jump_climb_o, -jump_climb_d, -legs_o, -legs_d, 
                     -moving_o, -moving_d, -perch_d, -perch_o, -resting_o,
                     -resting_d, -bait_eaten_g, 
                     -sumsect_o, -totalact_o, -emerge_max, -time_to_emerge_s, -arena_entry)

write.csv(data2_pred,"data2_pred - both assays adjusted env variables.csv")

```

#Adjusted behaviour variables - test vs assay number
```{r}

mod <- glm(foodd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(foodo_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(bait_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(groomd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(groomo_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(jumpd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(jumpo_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(legsd_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(legso_p ~ assay_number, family=gaussian, data=data2_pred)

mod <- glm(moved_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(moveo_p ~ assay_number, family=gaussian, data=data2_pred)
mod <- glm(emerge_p ~ assay_number, family=gaussian, data=data2_pred)

mod1 <- glm(perchd_p ~ assay_number, family=gaussian, data=data2_pred)
mod2 <- glm(percho_p ~ assay_number, family=gaussian, data=data2_pred)

mod2 <- glm(sumsecto_p ~ assay_number, family=gaussian, data=data2_pred)
mod2 <- glm(totalacto_p ~ assay_number, family=gaussian, data=data2_pred)

mod1 <- glm(bagstress_p ~ assay_number, family=gaussian, data=data2_pred)
mod1 <- glm(trapstress_p ~ assay_number, family=gaussian, data=data2_pred)
mod1 <- glm(tablestress_p ~ assay_number, family=gaussian, data=data2_pred)

#Tables with kableExtra
tidy_results <- tidy(mod)%>%
 mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Adjusted jumping and climbing occurrences (n)", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 15)
table

```

#Adjusted behaviour variables vs assay number plots
```{r}

ed_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = emerge_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("") + 
  ylab(expression(paste("Latency to emerge (s)")))+
  annotate("text", x = "2", y =50, label = "a", size = 5, hjust = -5) + 
  labs("") 
print(ed_plot)
ggsave(filename = "assay number - emerge - site.jpeg", ed_plot, width=200, height= 150, units = "mm")


fo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = foodo_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("") + ylab(expression(paste("Food interaction occurrences", italic(" (n) ")))) +
  annotate("text", x = "2", y =30, label = "b", size = 5, hjust = -5) 
  labs("") 
print(fo_plot)
#ggsave(filename = "assay number - food occ - site.jpeg", fo_plot, width=200, height= 150, units = "mm")


jd_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = jumpd_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("") + ylab(expression(paste("Jumping and climbing duration (s)" )))  +
  annotate("text", x = "2", y =200, label = "c", size = 5, hjust = -5)
  labs("") 
print(jd_plot)
#ggsave(filename = "assay number - jump dur - site.jpeg", jd_plot, width=200, height= 150, units = "mm")

  
assayplot1 <- ggarrange(ed_plot, fo_plot, jd_plot, ncol = 3)
print(assayplot1)  
  

jo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = jumpo_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("") + ylab(expression(paste("Jumping and climbing occurrences ", italic(" (n) ")))) +
  annotate("text", x = "2", y =80, label = "d", size = 5, hjust = -5) + 
  labs("") 
print(jo_plot)
#ggsave(filename = "assay number - jump occ - site.jpeg", jo_plot, width=200, height= 150, units = "mm")


md_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = moved_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("") + ylab(expression(paste("Quadrupedal movement duration (s)" ))) +
  annotate("text", x = "2", y =160, label = "e", size = 5, hjust = -5) + 
  labs("") 
print(md_plot)
#ggsave(filename = "assay number - move dur - site.jpeg", md_plot, width=200, height= 150, units = "mm")


mo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = moveo_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("") + ylab(expression(paste("Quadrupedal movement occurrences", italic(" (n) ")))) +
  annotate("text", x = "2", y =140, label = "f", size = 5, hjust = -5) + 
  labs("") 
print(mo_plot)
#ggsave(filename = "assay number - move occ - site.jpeg", mo_plot, width=200, height= 150, units = "mm")

sum_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = sumsecto_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("") + ylab(expression(paste("Total different section visits", italic(" (n) ")))) +
  annotate("text", x = "2", y =65, label = "g", size = 5, hjust = -5) +
  labs("") 
print(sum_plot)
#ggsave(filename = "assay number - sum sect - site.jpeg", sum_plot, width=200, height= 150, units = "mm")


act_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = totalacto_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("") + ylab(expression(paste("Total activity occurrences", italic(" (n) ")))) +
  annotate("text", x = "2", y =350, label = "h", size = 5, hjust = -5) + 
  labs("") 
print(act_plot)
#ggsave(filename = "assay number - tot sect - site.jpeg", act_plot, width=200, height= 150, units = "mm")


lo_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = legso_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("") + ylab(expression(paste("Standing on hind legs occurrences", italic("(n) ")))) +
  annotate("text", x = "2", y =100, label = "i", size = 5, hjust = -6) +
  labs("") 
print(lo_plot)
#ggsave(filename = "assay number - legs occ - site.jpeg", lo_plot, width=200, height= 150, units = "mm")


#po_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = percho_p, 
                        #fill = assay_number)) + 
  #geom_boxplot() +
  #scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  #theme_minimal() +
  #theme(legend.position = "none", 
        #panel.grid = element_blank(),
        #axis.line.x = element_line(color = "black"),
        #axis.line.y = element_line(color = "black")) + 
  #xlab("") + ylab(expression(paste("Perching occurrences", italic(" (n) ")))) + 
  #annotate("text", x = "2", y =35, label = parse(text = "bold('j')"), size = 5, hjust = -1) +
  #labs("") 


po_plot <- ggplot(data=data2_pred, aes(x = assay_number, y = percho_p, 
                        fill = assay_number)) + 
  geom_boxplot() +
  scale_fill_manual (values = c("#25798F","#7BD151")) +
  #facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("") + ylab(expression(paste("Perching occurrences ", italic(" (n) ")))) + 
  annotate("text", x = "2", y =30, label ="j", size = 5, hjust = -5) +
  labs("") 

print(po_plot)
#ggsave(filename = "assay number - perch occ  - site.jpeg", po_plot, width=200, height= 150, units = "mm")


```

Arrange individual plots into one. 
```{r}

behav <- ggarrange(ed_plot, fo_plot, jd_plot, jo_plot, md_plot, mo_plot,
  sum_plot, act_plot, lo_plot, po_plot, ncol = 2, nrow = 5,
  font.label = list(
    size = 6,
    face = "bold",
    color = "black",
    label.x = 0.89,
    label.y = 0.99,
    hjust = -0.1,
    vjust = 1.5  ))

behav <- annotate_figure(behav, 
        left = text_grob("Adjusted behaviours over two assays", rot=90, size = 16, face = "bold"),
        bottom = text_grob("Assay number", size = 16, face = "bold"))

print(behav)
ggsave(filename = "adjusted behaviour plots.jpeg", behav, width=300, height= 500, units = "mm")

```

#** PERSONALITY AND PLASTICITY 
Prep data for coefficient left_join 
```{r}

quoll2 <- data2_pred %>%
  select(-assay_date, -initial_repeat_assay, -trap_location, -snout, 
                     -haunches, -trap_session_date, -trap_session_morning, -first_light,
                     -ssr, -process_start, -process_end, -pouch, -teeth_colour, 
                     -teeth_sharpness, -teeth_shine, stress_in_trap, stress_in_bag, stress_on_table)

quoll2$condition <- factor(quoll2$condition, levels = c("Excellent", "Good", "Fair", "Poor"))
quoll2$cond_n <- factor(quoll2$cond_n, levels = c("4", "3", "2", "1"))
quoll2$age_n <- factor(quoll2$age_n, levels = c("2", "1", "0"))

write.csv(quoll2, "2nd try quoll2.csv")

```

#Intercept and slope - extracting adjusted values for intercept (personality) and  slope (plasticity) over both assays
```{r}

# Create a list of dependent behavioural variables
dependent <- c("foodd_p","foodo_p","groomd_p","groomo_p",
               "jumpd_p","jumpo_p","legsd_p","legso_p", "moved_p",
               "moveo_p", "perchd_p", "percho_p", "bait_p", "sumsecto_p", "totalacto_p", 
               "trapstress_p", "bagstress_p", "tablestress_p", "emerge_p")

# Define the levels in an object
quolls <- levels(factor(quoll2$quoll_code))

# Create a blank dataframe with four columns
coefficients <- data.frame(quoll_code=NULL, intercept=NULL, 
                           slope=NULL, variable=NULL)

# Loop to extract the intercept and slope of each behavioural response
for(v in 1:NROW(dependent)) {
  for(i in 1:NROW(quolls)){
    quoll_code <- quolls[i]
    variable <- dependent[v]
    mod <- lm(eval(as.name(paste0(variable))) ~ 
                assay_number + temp + moon_phase + time_assaytolight + time_processtoassay, 
              data=subset(quoll2, quoll_code==quolls[i]))
    i <- coef(mod)[1]
    s <- coef(mod)[2]
    results <- data.frame(cbind(quoll_code, i, s, variable))
    coefficients <- rbind(coefficients, results)
  }
}

# Convert the df to wide format
coefficients <- reshape(coefficients, idvar="quoll_code", 
                        timevar="variable", direction="wide")

# Define names of the coefficients
names(coefficients) <- gsub("\\.", "_", names(coefficients))

# Remove duplicated coefficients
coefficients <- coefficients[ , !duplicated(colnames(coefficients))]

# Check structure of coefficients
str(coefficients)

#If they are being read as characters, change to numeric 
cols_to_convert <- setdiff(names(coefficients), "quoll_code")
coefficients[cols_to_convert] <- lapply(coefficients[cols_to_convert], as.numeric)

# Join behavioural df with post-release df
ppdata <- left_join(quoll2, coefficients, by="quoll_code", "session")

# Remove duplicated column names
ppdata <- ppdata[ , !duplicated(colnames(ppdata))]

view(ppdata)
#str(ppdata)

# Write to csv file
write_csv(ppdata, "2nd try ppdata - intercept and slope data.csv")

#str(ppdata)

```

# Analyse behaviour indicators for personality and plasticity 

  1. Test the influence of fixed (e.g., site) and random effects (e.g., arena) on behavioural responses (e.g., food interaction duration) using the `lmer()` function.
  2. If multiple fixed effects produce significance, perform model selection using the dredge() function to determine which fixed effects are within delta 2 AICc.

#Intercept GLMMs - testing behaviour intercept (personality) against independent variables
```{r}

mod <- lmer(i_bait_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_emerge_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_foodd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_foodo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_groomd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_groomo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_jumpd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_jumpo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_legsd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_legso_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_moved_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_moveo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_perchd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_percho_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_sumsecto_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_totalacto_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_trapstress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_bagstress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_tablestress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

```

#Intercept tables
```{r}
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Adjusted table stress rating intercept", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

table <- tidy_results %>%
    mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences <em>(n)</em> intercept", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

```

#Intercept AICc model selection
```{r}

#Grooming duration
mod_gdi_site <- lmer(i_groomd_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_gdi_weight <- lmer(i_groomd_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_gdi_sex <- lmer(i_groomd_p ~ sex  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_gdi_site, mod_gdi_weight, mod_gdi_sex)
model.names <- c("Study site", "Body weight kg", "Sex")
aictab(cand.set = models, modnames = model.names)

#Grooming occurrences
mod_goi_site <- lmer(i_groomo_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_goi_weight <- lmer(i_groomo_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_goi_sex <- lmer(i_groomo_p ~ sex  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_goi_site, mod_goi_weight, mod_goi_sex)
model.names <- c("Study site", "Body weight kg", "Sex")
aictab(cand.set = models, modnames = model.names)

#Jump/climb duration
mod_jdi_site <- lmer(i_jumpd_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_jdi_weight <- lmer(i_jumpd_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_jdi_site, mod_jdi_weight)
model.names <- c("Study site", "Body weight kg")
aictab(cand.set = models, modnames = model.names)

#Latency to emerge
mod_ei_site <- lmer(i_emerge_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_ei_weight <- lmer(i_emerge_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_ei_site, mod_ei_weight)
model.names <- c("Study site", "Body weight kg")
aictab(cand.set = models, modnames = model.names)

#Perching duration
mod_pdi_site <- lmer(i_perchd_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_pdi_weight <- lmer(i_perchd_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_pdi_sex <- lmer(i_perchd_p ~ sex  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_pdi_site, mod_pdi_weight, mod_pdi_sex)
model.names <- c("Study site", "Body weight kg", "Sex")
aictab(cand.set = models, modnames = model.names)

#Quadrupedal movement duration 
mod_md_site <- lmer(i_moved_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_md_weight <- lmer(i_moved_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_md_site, mod_md_weight)
model.names <- c("Study site", "Body weight kg")
aictab(cand.set = models, modnames = model.names)

#Perching duration
mod_tsi_site <- lmer(i_tablestress_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_tsi_weight <- lmer(i_tablestress_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_tsi_sex <- lmer(i_tablestress_p ~ sex  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_tsi_site, mod_tsi_weight, mod_tsi_sex)
model.names <- c("Study site", "Body weight kg", "Sex")
aictab(cand.set = models, modnames = model.names)

```

#Slope GLMMs - testing behaviour slope (plasticity) against independent variables
```{r}

mod <- lmer(s_bait_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_emerge_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_foodd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_foodo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_groomd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_groomo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_jumpd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_jumpo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_legsd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_legso_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_moved_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_moveo_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_perchd_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_percho_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_sumsecto_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_totalacto_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_bagstress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_trapstress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_tablestress_p ~ sex*body_weight_kg + study_site + age_n + (1|arena), 
            data=ppdata, na.action = "na.fail")

#Tables with kableExtra
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Adjusted table stress rating slope", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

```

#Slope AICc model selection 
```{r}
#Jumping climbing duration
mod_jds_site <- lmer(s_jumpd_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_jds_weight <- lmer(s_jumpd_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_jds_site, mod_jds_weight)
model.names <- c("Study site", "Body weight kg")
aictab(cand.set = models, modnames = model.names)

#Jumping climbing occurrences
mod_jos_site <- lmer(s_jumpo_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_jos_weight <- lmer(s_jumpo_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_jos_site, mod_jos_weight)
model.names <- c("Study site", "Body weight kg")
aictab(cand.set = models, modnames = model.names)

#Perching duration
mod_pds_site <- lmer(s_perchd_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_pds_weight <- lmer(s_perchd_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_pds_sex <- lmer(s_perchd_p ~ sex  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_pds_site, mod_pds_weight, mod_pds_sex)
model.names <- c("Study site", "Body weight kg", "Sex")
aictab(cand.set = models, modnames = model.names)

#Perching occurrences
mod_pos_site <- lmer(s_percho_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_pos_sex <- lmer(s_percho_p ~ sex  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_pos_site, mod_pos_sex)
model.names <- c("Study site", "Sex")
aictab(cand.set = models, modnames = model.names)

#Quadrupedal movement duration
mod_mds_site <- lmer(s_moved_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_mds_weight <- lmer(s_moved_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_mds_site, mod_mds_weight)
model.names <- c("Study site", "Weight")
aictab(cand.set = models, modnames = model.names)

#Quadrupedal movement occurrences
mod_mos_site <- lmer(s_moveo_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_mos_weight <- lmer(s_moveo_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_mos_site, mod_mos_weight)
model.names <- c("Study site", "Weight")
aictab(cand.set = models, modnames = model.names)

#Quadrupedal movement occurrences
mod_los_site <- lmer(s_legso_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_los_weight <- lmer(s_legso_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_los_site, mod_los_weight)
model.names <- c("Study site", "Weight")
aictab(cand.set = models, modnames = model.names)

#Table stress rating
mod_tbls_site <- lmer(s_tablestress_p ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_tbls_weight <- lmer(s_tablestress_p ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_tbls_site, mod_tbls_weight)
model.names <- c("Study site", "Weight")
aictab(cand.set = models, modnames = model.names)

```







#Activity over time - prepping data
```{r}

bin <- read_excel(raw_data, sheet="Binned assays", na="N/A")%>%
 clean_names() 
 view(bin)

 # Append metadata for each assay to dataframe
bin_data <- left_join(meta, bin, by=c("assay_id", "quoll_code"), relationship = "many-to-many")
#view(data)
 
bin_data <- left_join(meta, bin, by=c("session", "assay_id", "quoll_code"), relationship = "many-to-many")%>%
 filter(!assay_id %in% c("MulligansA_4", "MulligansA_9", "MulligansB_19")) %>%
  select(-initial_repeat_assay, -trap_location, -time_to_emerge_s, -remaining_bait_g, -bait_eaten_g)

bin_data <- bin_data %>%
  mutate(minute_integer = as.integer(gsub("\\D", "", minute)))

names(bin_data)
view(bin_data)
 
```


```{r}

bin_data$assay_number <- factor(bin_data$assay_number)

plot <- ggplot(data = bin_data, 
       mapping = aes(x = minute_integer, y = moving_occ_binned))

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, color = study_site)) +
  geom_smooth() + # Add line
  labs(x = "Assay minute", y = "Moving Occurrences", title = "Line Plot") + # Add labels
  theme_minimal() # Choose a theme

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, color = assay_number)) +
  geom_smooth() + # Add line
  labs(x = "Assay minute", y = "Moving Occurrences", title = "Line Plot") + # Add labels
  theme_minimal() # Choose a theme

plot <- ggplot(bin_data, aes(x = minute_integer, y = moving_occ_binned, 
                             color = study_site, fill=study_site)) +
  geom_smooth() + # Add line
  ggtitle(label="Assay number", vjust=0.5) +
  labs(x="Assay minute", y="moving occ") + # Add labels
  theme_minimal() + # Choose a theme
  facet_wrap(~assay_number)

print(plot)
```


## Map

```{r, warning=FALSE}
# Read in and project MFWS fence shapefile using rgdal
mfws <- readOGR(dsn="shapefiles/MFGO_fences_and surrounds.shp", verbose=FALSE) %>% 
  spTransform(CRS("+proj=utm +zone=55 +ellps=WGS84")) %>%
  # Transform shapefile into a dataframe
  fortify(verbose=FALSE) %>%
  mutate(lat=as.numeric(lat + 10000000), 
         long=as.numeric(long))

# Read in and project MFGO fence shapefile using rgdal
mfgo <- st_read("shapefiles/MFGO_fences.shp", quiet=TRUE) %>%
  # Set projection to eastings/northings
  st_set_crs("EPSG:32755") %>% 
  # Reproject to lat/long
  st_transform("EPSG:4326")

# Plot den locations on MFWS map for each trial
map <- ggplot() + 
  geom_polygon(mfws, mapping=aes(x=long, y=lat, group=group), col="grey15") +
  #coord_sf(xlim=c(695750, 699250), ylim=c(6104250, 6107750)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_rect(fill="white"),
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.key = element_blank(), 
        strip.background = element_blank()) +
  #facet_wrap(~factor(year_of_acquisition), ncol=3) +
  #scale_colour_manual(values = viridis(3, begin=0.9, end=0.1)) +
  xlab("") + ylab("") + labs(col="Trial")
print(map)
```

```{r}
jpeg(file="mfgo_fences_and_surrounds.jpeg", 
     width=4750, height=1500, units="px", res=500)
map
dev.off()
```

# **Session information**

```{r}
# Display version information for R, OS, and packages
sessionInfo()
```


#***OLD CODE***

**1st try  PERSONALITY AND PLASTICITY
Prep data for coefficient left_join 
```{r}

names(data2)
view(data2)

quoll2 <- data2 %>%
  filter(!assay_number %in% 1) %>%
  select(-assay_date, -initial_repeat_assay, -trap_location, -snout, 
                     -haunches, -time_to_emerge_s,-arena_entry, -trap_session_date, 
                     -trap_session_morning, -first_light,
                     -ssr, -process_start, -process_end, -pouch, -teeth_colour, 
                     -teeth_sharpness, -teeth_shine)

 view(quoll2)
 names(quoll2)
 write.csv(quoll2, "quoll2.csv")

```

#Intercept and slope - extracting adjusted values for intercept (personality) and  slope (plasticity) over both assays
```{r}

# Create a list of dependent behavioural variables
dependent <- c("bait_eaten_g","food_o","food_d","grooming_o",
               "grooming_d","jump_climb_o","jump_climb_d","legs_o", "legs_d",
               "moving_o", "moving_d", "perch_o", "perch_d", "sumsect_o", "totalact_o", 
               "emerge_max", "stress_in_trap", "stress_in_bag", "stress_on_table")

# Define the levels in an object
quolls <- levels(factor(data2$quoll_code))

# Create a blank dataframe with four columns
coefficients <- data.frame(quoll_code=NULL, intercept=NULL, 
                           slope=NULL, variable=NULL)

# Loop to extract the intercept and slope of each behavioural response
for(v in 1:NROW(dependent)) {
  for(i in 1:NROW(quolls)){
    quoll_code <- quolls[i]
    variable <- dependent[v]
    mod <- lm(eval(as.name(paste0(variable))) ~ 
                assay_number + temp + moon_phase + time_assaytolight + time_processtoassay, 
              data=subset(data2, quoll_code==quolls[i]))
    i <- coef(mod)[1]
    s <- coef(mod)[2]
    results <- data.frame(cbind(quoll_code, i, s, variable))
    coefficients <- rbind(coefficients, results)
  }
}

# Convert the df to wide format
coefficients <- reshape(coefficients, idvar="quoll_code", 
                        timevar="variable", direction="wide")

# Define names of the coefficients
names(coefficients) <- gsub("\\.", "_", names(coefficients))

# Remove duplicated coefficients
coefficients <- coefficients[ , !duplicated(colnames(coefficients))]

# Check structure of coefficients
str(coefficients)

#If they are being read as characters, change to numeric 
cols_to_convert <- setdiff(names(coefficients), "quoll_code")
coefficients[cols_to_convert] <- lapply(coefficients[cols_to_convert], as.numeric)

# Join behavioural df with post-release df
ppdata <- left_join(quoll2, coefficients, by="quoll_code", "session")

# Remove duplicated column names
ppdata <- ppdata[ , !duplicated(colnames(ppdata))]

view(ppdata)
#str(ppdata)

# Write to csv file
write_csv(ppdata, "ppdata - intercept and slope data.csv")

#str(ppdata)

```

# Analyse behaviour indicators for personality and plasticity 

  1. Test the influence of fixed (e.g., site) and random effects (e.g., arena) on behavioural responses (e.g., food interaction duration) using the `lmer()` function.
  2. If multiple fixed effects produce significance, perform model selection using the dredge() function to determine which fixed effects are within delta 2 AICc.

#Intercept GLMMs - testing behaviour intercept (personality) against independent variables
```{r}
names(ppdata)

mod <- lmer(i_bait_eaten_g ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_emerge_max ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_food_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_food_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_grooming_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_grooming_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_jump_climb_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_jump_climb_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_legs_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_legs_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_moving_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_moving_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_perch_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_perch_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_stress_in_bag ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_stress_in_trap ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_stress_on_table ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_sumsect_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(i_totalact_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

summary(mod1)
summary(mod1)
summary(mod1)
summary(mod1)
summary(mod1)
summary(mod1)
summary(mod1)
summary(mod1)
summary(mod1)
summary(mod1)
summary(mod1)

```

#Intercept tables
```{r}
tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))

table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Latency to emerge (s) intercept", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

table <- tidy_results %>%
    mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences <em>(n)</em> intercept", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

```

#Intercept AICc model selection
```{r}

mod_md_site <- lmer(i_grooming_o ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_md_weight <- lmer(i_grooming_o ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_md_site, mod_md_weight)
model.names <- c("Study site", "Body weight kg")
aictab(cand.set = models, modnames = model.names)

mod_e_site <- lmer(i_emerge_max ~ study_site + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
mod_e_weight <- lmer(i_emerge_max ~ body_weight_kg  + (1|arena), 
            data=ppdata, control = control_ml, na.action = "na.fail")
models <- list(mod_e_site, mod_e_weight)
model.names <- c("Study site", "Body weight kg")
aictab(cand.set = models, modnames = model.names)

```

#Slope GLMMs - testing behaviour slope (plasticity) against independent variables
```{r}

names(ppdata)

mod <- lmer(s_bait_eaten_g ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_food_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_emerge_max ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_food_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_grooming_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_grooming_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_jump_climb_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_jump_climb_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_legs_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_legs_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_moving_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_moving_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_perch_d ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_perch_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_stress_in_bag ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_stress_in_trap ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_stress_on_table ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_sumsect_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")

mod <- lmer(s_totalact_o ~ sex + study_site + age_n +
              body_weight_kg + (1|arena), 
            data=ppdata, na.action = "na.fail")


tidy_results <- tidy(mod) %>%
  mutate_if(is.numeric, ~round(., digits = 3))
table <- tidy_results %>%
  mutate(p.value = ifelse(p.value <= 0.05, cell_spec(p.value, bold = TRUE), p.value)) %>%
  kbl(caption = "Total activity occurrences (n) slope", escape = FALSE) %>%
  kable_classic(full_width = F, html_font = "Times New Roman") %>%
  kable_styling(bootstrap_options = "striped", font_size = 12)
table

```


