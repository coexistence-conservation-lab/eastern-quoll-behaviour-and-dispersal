---
title: "Eastern quoll behaviour and dispersal"
author: "Christina Gee, Belinda Wilson"
date: "14 March 2024"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: true
    theme: cerulean
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'tutorial.html')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE)
```

# **Background**

Personality can play a crucial role in the survival and dispersal of reintroduced animals. In 2017, we reintroduced a cohort of female-only eastern quolls (*Dasyurus viverrinus*) to a [conservation-fenced haven](https://www.mulligansflat.org.au/) in the Australian Capital Territory, and conducted behavioural assays on each animal prior to their release. We aimed to determine whether personality and plasticity of these animals could predict their post-release performance.

Here we describe the analyses we conducted for our article [Wilson *et al.* (2022) Personality and plasticity predicts post-release performance in a reintroduced mesopredator](https://doi.org/10.1016/j.anbehav.2022.02.019), published in Animal Behaviour.

# **Setup**

First, we installed the [pacman Package Management Tool](https://cran.r-project.org/web/packages/pacman/index.html), which allows us to install and load subsequent packages in a condensed and efficient way. 

```{r, eval=FALSE}
#install.packages("pacman")
```

```{r, results='hide', warning=FALSE, message=FALSE}
# Install and load required packages
pacman::p_load(basemaps, ggplot2, ggpubr, gtools, janitor, lme4, MuMIn,  
               readr, sf, readxl, rstudioapi, tidyverse, viridis)

install.packages("corrplot")
install.packages("beepr")
install.packages("lubridate")
install.packages("broom")

install.packages("sjPlot")
install.packages("sjmisc")
install.packages("sjlabelled")

library(sjPlot)
library(sjmisc)
library(sjlabelled)

library(beepr)
library(corrplot)
library(lubridate)
library(broom)
```

# **Data preparation**

```{r, eval=FALSE}
# Assign raw data filename to an object
raw_data <- "data.xlsx"

# Read in behavioural assay data
raw <- read_excel(raw_data, sheet="Assays", na="N/A") %>% 
  clean_names() %>%
  select("id"="observation_id", 
         "assay_id", 
         "quoll_code",
         behaviour="behavior", 
         occurrences="total_number_of_occurences")

#view(raw)


#Read in the data for all data sheets in excel 
meta <- read_excel(raw_data, sheet="Metadata", na="N/A") %>% 
  select(-16, -17) %>%
  clean_names()
#view(meta)
#names(meta)

quoll <- read_excel(raw_data, sheet="Quoll", na="N/A") %>%
  select(2, 4, 5) %>%
  clean_names()
#view(quoll)
#names(quoll)

capture <- read_excel(raw_data, sheet="Captures") %>%
   select(2, 4, 8, 9, 10, 11, 12, 13, 14, 24, 26, 27, 28, 30) %>%
  clean_names()
#view(capture)
#names(capture)

session <- read_excel(raw_data, sheet="Sessions") %>%
  select(4, 8, 9, 10, 11) %>%
  clean_names()
#view(session)
#names(session)

#bin <- read_excel(raw_data, sheet="Binned assays", na="N/A")%>%
 # clean_names()
#view(bin)

#sites <- read_excel(raw_data, sheet="Sites") %>%
  #clean_names()
#view(sites)

#trap_eff <- read_excel(raw_data, sheet="Trap effectiveness") %>%
 #clean_names()
#view(trap_eff)


#Clean up behaviour data from long to wide format 
occ <- pivot_wider(data = raw, 
                   names_from = behaviour, 
                   values_from = occurrences)  %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_o = "section_1", 
         section_2_o = "section_2", 
         section_3_o = "section_3", 
         section_4_o = "section_4", 
         moving_o = "moving", 
         jump_climb_o = "jump_climb", 
         food_o = "food", 
         legs_o = "legs", 
         grooming_o = "grooming", 
         resting_o = "resting", 
         perch_o = "perch")
#view(occ)


raw <- read_excel(raw_data, sheet="Assays", , na="N/A") %>% 
  clean_names() %>%
  select("id"="observation_id", 
         "assay_id", 
         quoll_code, 
         behaviour="behavior", 
         duration="total_duration_s")

dur <- pivot_wider(data = raw,
                   names_from = behaviour, 
                   values_from = duration) %>%
  clean_names() %>%
  mutate(across(all_of(c("section_1", "section_2", "section_3", "section_4", 
                         "moving", "jump_climb", "food", "legs", 
                         "grooming", "resting", "perch")), as.numeric)) %>%
  rename(section_1_d = "section_1", 
         section_2_d = "section_2", 
         section_3_d = "section_3", 
         section_4_d = "section_4", 
         moving_d = "moving", 
         jump_climb_d = "jump_climb", 
         food_d = "food", 
         legs_d = "legs", 
         grooming_d = "grooming", 
         resting_d = "resting", 
         perch_d = "perch")
#view(dur)

assays <- left_join(occ, dur, by=c("id", "assay_id", "quoll_code"))

#Adding all sections together to create a column with total section visitations
assays$sumsect_o <- rowSums(assays[, c("section_1_o", "section_2_o", "section_3_o", "section_4_o")])

#Finding out the locations of the relevant columns 
colfoodo <- which(colnames(assays) == "food_o")
print(colfoodo) #4

restingo <- which(colnames(assays) == "resting_o")
print(restingo) #10

#Adding together all activity occurrences without sections
assays$totalact_o <- rowSums(assays[, c(4:10)])

#view(assays)

# Append metadata for each assay to dataframe
data <- left_join(meta, assays, by=c("assay_id", "quoll_code"))
#view(data)

#this filters out animals which were not assayed
data <- data %>%
  filter(!is.na(assay_number))

data <- left_join(data, quoll, by=c("quoll_code"), relationship = "many-to-many")

data <- left_join(data, capture, by=c("quoll_code", "session"), relationship = "many-to-many")

megadata <- left_join(data, session, by=c("session"))

view(megadata)
names(megadata)

```


# ** Calculating time differences 
```{r}

#Check if the time columns are in the correct format
print(class(megadata$snout_in_arena))
print(class(megadata$process_end))
print(class(megadata$first_light))

#If not, correct to POSIXct format
megadata$snout_in_arena <- as.POSIXct(megadata$snout_in_arena)
megadata$process_end <- as.POSIXct(megadata$process_end)
megadata$first_light <- as.POSIXct(megadata$first_light)

#Calculate time differences
megadata$time_processtoassay <- megadata$snout_in_arena - megadata$process_end
megadata$time_assaytolight <-  megadata$snout_in_arena - megadata$first_light

#view(megadata)

```


```{r}

#Adding a column to turn study site names into binomial 0 and 1 values 
megadata$binomial_study_site <- as.numeric(ifelse(megadata$study_site == "MFWS", 0, ifelse(megadata$study_site == "Goorooyarroo", 1, NA)))


```

# ** Filtering out the two individuals who were assayed in Sept 2023

```{r}
megadata_excl <- megadata %>%
  filter(!(quoll_code %in% c("53328", "87DE0")))

view(megadata_excl)

```


# ** Testing environmental variables for influence on behaviour 

```{r}

foodd <- glm(food_d ~ temp + moon_phase + time_assaytolight, data=megadata)
foodo <- glm(food_o ~ temp + moon_phase + time_assaytolight, data=megadata)

summary(foodd)
summary(foodo)

summary(glm(grooming_d ~ temp + moon_phase + time_assaytolight, data=megadata))
summary(glm(grooming_o ~ temp + moon_phase + time_assaytolight, data=megadata))

summary(glm(jump_climb_d ~ temp + moon_phase + time_assaytolight, data=megadata))
summary(glm(jump_climb_o ~ temp + moon_phase + time_assaytolight, data=megadata))

summary(glm(legs_d ~ temp + moon_phase + time_assaytolight, data=megadata))
summary(glm(legs_o ~ temp + moon_phase + time_assaytolight, data=megadata))

summary(glm(moving_d ~ temp + moon_phase + time_assaytolight, data=megadata))
summary(glm(moving_o ~ temp + moon_phase + time_assaytolight, data=megadata))

summary(glm(perch_d ~ temp + moon_phase + time_assaytolight, data=megadata))
summary(glm(perch_o ~ temp + moon_phase + time_assaytolight, data=megadata))

summary(glm(resting_d ~ temp + moon_phase + time_assaytolight, data=megadata))
summary(glm(resting_o ~ temp + moon_phase + time_assaytolight, data=megadata))


#collect stats into a table
p_temp <- summary(foodd)$coefficients["temp", "Pr(>|t|)"]
p_moon <- summary(foodo)$coefficients["moon_phase", "Pr(>|t|)"]

data.frame(Model = c("foodd", "foodo"),
           Variable = c("Temperature", "Moon phase"),
           p_value = c(p_temp, p_moon))



tidy_results <- bind_rows(tidy(foodd))

print(tidy_results)

tab_model(
  foodd, foodo, 
  pred.labels = c("Intercept", "Temperature", "Moon phase", "Time to first light"),
  dv.labels = c("Food interaction duration (s)", "Food interaction occurrences (n)"),
  string.pred = "Coefficient",
  string.ci = "Conf. Int (95%)",
  string.p = "P-Value"
)

```


# ** Accounting for environmental variables

```{r}

#Mutating the environmental variables in the overall data frame, including animals 53328 and 87DE0
names(megadata)
view(megadata)

megadata_mutate <- megadata %>%
  mutate_at(vars(5, 110, 117), ~ as.vector(scale(.)))

view(megadata_mutate)

write.csv(megadata_mutate, "megadata mutated.csv")


#Mutating environmental variables excluding 53328 and 87DE0
names(megadata_excl)

megadata_ex_mutate <- megadata_excl %>%
  mutate_at(vars(5, 110, 117), ~ as.vector(scale(.)))

write.csv(megadata_ex_mutate, "megadata mutated excluding sept individuals.csv")

```


# **  Correlation analysis

```{r}

#Finding out the locations of the relevant columns 
colfoodo <- which(colnames(megadata) == "food_o")
print(colfoodo) #22
restingo <- which(colnames(megadata) == "resting_o")
print(restingo) #28
colsection4o <- which(colnames(megadata) == "section_4_o")
print(colsection4o) #32
colfoodd <- which(colnames(megadata) == "food_d")
print(colfoodd) #33
restingd <- which(colnames(megadata) == "resting_d")
print(restingd) #39
colsection4d <- which(colnames(megadata) == "section_4_d")
print(colsection4d) #43

#Selecting the appropriate columns for each correlation matrix
#all occurrence and duration columns including sections
cor_o_d <- megadata %>% 
  dplyr::select(22:43)

#all occurrence columns including sections
cor_o <- megadata %>%
  dplyr::select(22:32)

#all duration data including sections 
cor_d <- megadata %>%
  dplyr::select(33:43)

#all duration and occurrence data not including sections
cor_od_act <- megadata %>%
  dplyr::select(22:28, 33:39)

#all occurrence data not including sections
cor_o_act <- megadata %>%
  dplyr::select(22:28)

#all duration data not including sections
cor_d_act <- megadata %>%
  dplyr::select(33:39)

#Running the correlations tests for both, then occurrences, then duration, with sections
correlation_od <- cor(cor_o_d)
correlation_o <- cor(cor_o)
correlation_d <- cor(cor_d)

#Running the correlations for both, then occurrences v duration, then occurrences, then duration, without sections
correlation_od_act <- cor(cor_od_act)
correlation_ovd_act <- cor(cor_d_act,cor_o_act)
correlation_occ_act <- cor(cor_o_act)
correlation_dur_act <- cor(cor_d_act)

#Saving them to a .csv file
write.csv(correlation_od, "correlation matrix occ dur all sessions.csv")
write.csv(correlation_o, "correlation matrix occ all sessions.csv")
write.csv(correlation_d, "correlation matrix dur all sessions.csv")
write.csv(correlation_ovd_act, "correlation matrix activity occ vs dur all sessions.csv")
write.csv(correlation_occ_act, "correlation matrix activity occ all sessions.csv")
write.csv(correlation_dur_act, "correlation matrix activity dur all sessions.csv")

#Creating and printing correlation matrix .jpgs which colour code the correlations

#Correlation of occurrences and duration with sections
jpeg(height=2000, width=2000, file="correlation matrix od all sessions.jpeg", type="cairo")
corrplot(correlation_od, method="color", type="upper", #creates a correlation matrix
         cl.cex=3, number.cex=2, tl.cex=3, diag=FALSE,
         tl.col="black", tl.srt=45, addCoef.col="black")
dev.off()

#Correlations of duration and occurrences without sections
jpeg(height=2000, width=2000, file="correlation matrix occdur act all sessions.jpeg", type="cairo")
corrplot(correlation_od_act, method="color", type="upper", #creates a correlation matrix
         cl.cex=3, number.cex=2, tl.cex=3, diag=FALSE,
         tl.col="black", tl.srt=45, addCoef.col="black")
dev.off()

```


# ** Running basic models to get the feel of the data

```{r}

#GLM to test duration of moving, first with all individuals, and then excluding the Sept 2023 individuals 
summary(glm(moving_d ~ study_site + temp + assay_number + morph + sex +  age_estimate, data=megadata))
summary(glm(moving_d ~ study_site + temp + assay_number + morph + sex +  age_estimate, data=megadata_excl))


#GLM to test occurrences of moving, first with all individuals, and then excluding the Sept 2023 individuals
summary(glm(moving_o ~ study_site + temp + assay_number + morph + sex +  age_estimate, data=megadata))
summary(glm(moving_o ~ study_site + temp + assay_number + morph + sex +  age_estimate, data=megadata_excl))


```


## Code for analysis - see 'Christina mind map' 

#Step 1 extract predicted values for behaviour with environmental variables

```{r}

mod <- glm(food_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$food_o_pred <- predict(mod, type = "response")

mod <- glm(food_d ~ temp + moon_phase + time_assaytolight,
           family=gaussian, data=megadata_mutate)
megadata_mutate$food_d_pred <- predict(mod, type = "response")

mod <- glm(grooming_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$food_o_pred <- predict(mod, type = "response")

mod <- glm(grooming_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$groom_d_pred <- predict(mod, type = "response")

mod <- glm(jump_climb_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$jump_o_pred <- predict(mod, type = "response")

mod <- glm(jump_climb_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$jump_d_pred <- predict(mod, type = "response")

mod <- glm(legs_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$legs_o_pred <- predict(mod, type = "response")

mod <- glm(legs_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$legs_d_pred <- predict(mod, type = "response")

mod <- glm(moving_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$move_o_pred <- predict(mod, type = "response")

mod <- glm(moving_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$move_d_pred <- predict(mod, type = "response")

mod <- glm(perch_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$perch_o_pred <- predict(mod, type = "response")

mod <- glm(perch_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$perch_d_pred <- predict(mod, type = "response")

mod <- glm(resting_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$rest_o_pred <- predict(mod, type = "response")

mod <- glm(resting_d ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate)
megadata_mutate$rest_d_pred <- predict(mod, type = "response")

```

Now we have our predicted values, accounting for environmental heterogeneity. 

#Step 2 Analyse behaviour indicators (name?)
```{r}

#Personality (single response / static etc? figure this out)

#GLM models with random vaiables - then use AICc to assess best model

mod <- lmer(move_o_p_i ~ site + sex + age + body_cond + weight + morph + (1|ID) + (1|arena), family=gaussian, data=data)
#Model selection (Δ 2 AICc)

mod <- lmer(move_o_p_s ~ site + sex + age + body_cond + weight + morph + (1|ID) + (1|arena), family=gaussian, data=data)
#Model selection (Δ 2 AICc)


```


# Collecting statistics for a model table (🚩 this goes at the end of your independent variable modelling).

```{r}
# Generate a model
mod <- glm(food_o ~ temp + moon_phase + time_assaytolight, 
           family=gaussian, data=megadata_mutate, 
           na.action = "na.fail")

summary(mod)

#collect stats into a table
p_temp <- summary(mod)$coefficients["temp", "Pr(>|t|)"]
p_moon <- summary(mod)$coefficients["moon_phase", "Pr(>|t|)"]

data.frame(Variable = c("Temperature", "Moon phase"),
           p_value = c(p_temp, p_moon))

# Conduct model selection using AICc threshold
dredge(mod, rank = "AICc")


```


#Step 3 Run GLMs for assay numbers and if this is significant, do step 3b in mind map plan

```{r}

mod_fo_p <- glm(mod_fo_p ~ assay_number, family=gaussian, data=megadata_mutate)
mod_fd_p <- glm(mod_fd_p ~ assay_number, family=gaussian, data=megadata_mutate)

```




# **Plots 

```{r}

view(megadata)

# Gooroo v Mulligans Moving
mov <- ggplot(megadata, aes(x = as.character(assay_number), y = moving_d, 
                        fill = as.character(assay_number))) + 
  geom_boxplot() +
  facet_wrap(~study_site) + 
  theme_minimal() +
  theme(legend.position = "none", 
        panel.grid = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) + 
  xlab("Assay number") + ylab("Moving duration (s)") + labs("")
print(mov)





```

## Map

```{r, warning=FALSE}
# Read in and project MFWS fence shapefile using rgdal
mfws <- readOGR(dsn="shapefiles/MFGO_fences_and surrounds.shp", verbose=FALSE) %>% 
  spTransform(CRS("+proj=utm +zone=55 +ellps=WGS84")) %>%
  # Transform shapefile into a dataframe
  fortify(verbose=FALSE) %>%
  mutate(lat=as.numeric(lat + 10000000), 
         long=as.numeric(long))

# Read in and project MFGO fence shapefile using rgdal
mfgo <- st_read("shapefiles/MFGO_fences.shp", quiet=TRUE) %>%
  # Set projection to eastings/northings
  st_set_crs("EPSG:32755") %>% 
  # Reproject to lat/long
  st_transform("EPSG:4326")

# Plot den locations on MFWS map for each trial
map <- ggplot() + 
  geom_polygon(mfws, mapping=aes(x=long, y=lat, group=group), col="grey15") +
  #coord_sf(xlim=c(695750, 699250), ylim=c(6104250, 6107750)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_rect(fill="white"),
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.key = element_blank(), 
        strip.background = element_blank()) +
  #facet_wrap(~factor(year_of_acquisition), ncol=3) +
  #scale_colour_manual(values = viridis(3, begin=0.9, end=0.1)) +
  xlab("") + ylab("") + labs(col="Trial")
print(map)
```



```{r}
jpeg(file="mfgo_fences_and_surrounds.jpeg", 
     width=4750, height=1500, units="px", res=500)
map
dev.off()
```


# **Session information**

```{r}
# Display version information for R, OS, and packages
sessionInfo()
```